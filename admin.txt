<?php
/**
 * АкваСбор - МЕГА Админ-панель v2.3 - ИСПРАВЛЕНО + ПОДКЛЮЧЕНО
 * Полный функционал с рабочими CRUD операциями + загрузка изображений
 */
session_start();

// Подключаем общие данные
require_once 'data.php';

// Простая авторизация
if (!isset($_SESSION['admin_logged_in'])) {
    if ($_POST['admin_password'] ?? '' === ADMIN_PASSWORD) {
        $_SESSION['admin_logged_in'] = true;
        $_SESSION['admin_name'] = 'Администратор';
        $_SESSION['admin_role'] = 'Супер-админ';
    } elseif ($_POST['admin_password'] ?? '') {
        $login_error = 'Неверный пароль';
    }
}

// Выход
if ($_GET['action'] === 'logout') {
    unset($_SESSION['admin_logged_in']);
    header('Location: admin.php');
    exit;
}

// Проверка авторизации
if (!isset($_SESSION['admin_logged_in'])) {
    renderLoginPage($login_error ?? '');
    exit;
}

$section = $_GET['section'] ?? 'dashboard';
$action = $_POST['action'] ?? $_GET['action'] ?? '';

// Обработка AJAX
if (isset($_POST['ajax'])) {
    header('Content-Type: application/json');
    handleAjaxRequest($action);
    exit;
}

// Обработка действий
if ($action) {
    handleAdminAction($action, $section);
}

// Получаем данные для админки
$adminData = getAdminData($section);

?><!DOCTYPE html>
<html lang='ru'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title><?= $adminData['title'] ?? 'Админ-панель' ?> - АкваСбор CRM</title>

    <!-- Стили админки -->
    <link href='https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap' rel='stylesheet'>
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css'>
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css'>
    <style>
        /* Базовые стили - сохраняем оригинальный дизайн */
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --text-muted: #95a5a6;
            --border-color: #dee2e6;
            --border-radius: 8px;
            --border-radius-lg: 12px;
            --border-radius-xl: 16px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 25px rgba(0,0,0,0.15);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.5;
        }

        .admin-panel {
            display: flex;
            min-height: 100vh;
        }

        /* Боковое меню */
        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: var(--transition);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .admin-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            font-size: 32px;
        }

        .logo-title {
            font-size: 20px;
            font-weight: 700;
        }

        .logo-subtitle {
            font-size: 12px;
            opacity: 0.8;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-section {
            margin-bottom: 30px;
        }

        .nav-title {
            padding: 0 20px 10px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.7;
            font-weight: 600;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: var(--transition);
            position: relative;
        }

        .sidebar-link:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .sidebar-link.active {
            background: rgba(255,255,255,0.15);
            color: white;
        }

        .sidebar-link.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: white;
        }

        .sidebar-link i {
            width: 20px;
            margin-right: 12px;
        }

        .sidebar-badge {
            margin-left: auto;
            padding: 2px 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .sidebar-badge.badge-warning {
            background: var(--warning-color);
        }

        .sidebar-badge.badge-premium {
            background: linear-gradient(45deg, gold, orange);
        }

        .sidebar-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .admin-profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .admin-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .admin-name {
            font-weight: 600;
            font-size: 14px;
        }

        .admin-role {
            font-size: 11px;
            opacity: 0.7;
        }

        .logout-btn {
            margin-left: auto;
            color: rgba(255,255,255,0.6);
            text-decoration: none;
            padding: 8px;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        /* Основной контент */
        .main-content {
            flex: 1;
            margin-left: 280px;
            min-height: 100vh;
        }

        .top-bar {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .top-bar-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-outline {
            background: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }

        /* Контент страниц */
        .page-content {
            padding: 24px;
        }

        /* Карточки статистики */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-primary);
            padding: 24px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            border-left: 4px solid var(--primary-color);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card.stat-success {
            border-left-color: var(--success-color);
        }

        .stat-card.stat-warning {
            border-left-color: var(--warning-color);
        }

        .stat-card.stat-danger {
            border-left-color: var(--danger-color);
        }

        .stat-card.stat-info {
            border-left-color: var(--info-color);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .stat-change {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-block;
        }

        .stat-change.positive {
            background: rgba(46, 204, 113, 0.1);
            color: var(--success-color);
        }

        .stat-change.neutral {
            background: rgba(149, 165, 166, 0.1);
            color: var(--text-muted);
        }

        /* Таблицы */
        .table-container {
            background: var(--bg-primary);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            margin-bottom: 24px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: var(--bg-secondary);
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .table td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .table tr:hover {
            background: var(--bg-secondary);
        }

        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-dialog {
            background: var(--bg-primary);
            border-radius: var(--border-radius-lg);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-muted);
        }

        .modal-body {
            padding: 20px;
        }

        /* Формы */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: var(--transition);
        }

        .form-input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* НОВОЕ: Стили для загрузки фото */
        .image-upload-area {
            border: 2px dashed var(--border-color);
            padding: 40px;
            text-align: center;
            border-radius: var(--border-radius);
            background: var(--bg-secondary);
            transition: var(--transition);
            cursor: pointer;
        }

        .image-upload-area:hover {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
        }

        .image-upload-area.drag-over {
            border-color: var(--success-color);
            background: rgba(46, 204, 113, 0.1);
        }

        .upload-icon {
            font-size: 48px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .upload-text {
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 20px;
        }

        .image-preview-item {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: var(--border-radius);
            overflow: hidden;
            border: 2px solid var(--border-color);
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Статус бейджи */
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-new {
            background: rgba(52, 152, 219, 0.1);
            color: var(--info-color);
        }

        .status-processing {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning-color);
        }

        .status-completed {
            background: rgba(46, 204, 113, 0.1);
            color: var(--success-color);
        }

        .status-cancelled {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        /* Пустые состояния */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class='admin-panel'>
    <!-- Боковое меню -->
    <aside class='sidebar'>
        <div class='sidebar-header'>
            <div class='admin-logo'>
                <div class='logo-icon'>🐠</div>
                <div class='logo-text'>
                    <div class='logo-title'>АкваСбор</div>
                    <div class='logo-subtitle'>MEGA CRM</div>
                </div>
            </div>
        </div>

        <nav class='sidebar-nav'>
            <div class='nav-section'>
                <div class='nav-title'>📊 Аналитика</div>
                <a href='admin.php?section=dashboard' class='sidebar-link <?= $section === 'dashboard' ? 'active' : '' ?>'>
                    <i class='fas fa-chart-pie'></i>
                    <span>KPI Дашборд</span>
                </a>

                <a href='admin.php?section=analytics' class='sidebar-link <?= $section === 'analytics' ? 'active' : '' ?>'>
                    <i class='fas fa-chart-line'></i>
                    <span>Графики продаж</span>
                    <span class='sidebar-badge'>NEW</span>
                </a>

                <a href='admin.php?section=heatmap' class='sidebar-link <?= $section === 'heatmap' ? 'active' : '' ?>'>
                    <i class='fas fa-fire'></i>
                    <span>Heatmap активности</span>
                    <span class='sidebar-badge'>HOT</span>
                </a>
            </div>

            <div class='nav-section'>
                <div class='nav-title'>🛒 Магазин</div>
                <a href='admin.php?section=products' class='sidebar-link <?= $section === 'products' ? 'active' : '' ?>'>
                    <i class='fas fa-fish'></i>
                    <span>Товары</span>
                    <span class='sidebar-badge'><?= count(getProducts()) ?></span>
                </a>

                <a href='admin.php?section=categories' class='sidebar-link <?= $section === 'categories' ? 'active' : '' ?>'>
                    <i class='fas fa-tags'></i>
                    <span>Категории</span>
                    <span class='sidebar-badge'><?= count(getCategories()) ?></span>
                </a>

                <a href='admin.php?section=orders' class='sidebar-link <?= $section === 'orders' ? 'active' : '' ?>'>
                    <i class='fas fa-shopping-bag'></i>
                    <span>Заказы</span>
                    <span class='sidebar-badge badge-warning'><?= count(array_filter(getOrders(), fn($o) => $o['status'] === 'new')) ?></span>
                </a>

                <a href='admin.php?section=reviews' class='sidebar-link <?= $section === 'reviews' ? 'active' : '' ?>'>
                    <i class='fas fa-star'></i>
                    <span>Отзывы</span>
                    <span class='sidebar-badge'><?= count(array_filter(getReviews(), fn($r) => !$r['is_approved'])) ?></span>
                </a>
            </div>

            <div class='nav-section'>
                <div class='nav-title'>💰 Финансы</div>
                <a href='admin.php?section=finance' class='sidebar-link <?= $section === 'finance' ? 'active' : '' ?>'>
                    <i class='fas fa-coins'></i>
                    <span>Отчеты</span>
                </a>

                <a href='admin.php?section=payments' class='sidebar-link <?= $section === 'payments' ? 'active' : '' ?>'>
                    <i class='fas fa-credit-card'></i>
                    <span>Платежи</span>
                </a>
            </div>

            <div class='nav-section'>
                <div class='nav-title'>📝 Контент</div>
                <a href='admin.php?section=news' class='sidebar-link <?= $section === 'news' ? 'active' : '' ?>'>
                    <i class='fas fa-newspaper'></i>
                    <span>Новости</span>
                    <span class='sidebar-badge'><?= count(getNews()) ?></span>
                </a>

                <a href='admin.php?section=pages' class='sidebar-link <?= $section === 'pages' ? 'active' : '' ?>'>
                    <i class='fas fa-file-alt'></i>
                    <span>Страницы</span>
                </a>

                <a href='admin.php?section=slider' class='sidebar-link <?= $section === 'slider' ? 'active' : '' ?>'>
                    <i class='fas fa-images'></i>
                    <span>Слайдер</span>
                </a>
            </div>

            <div class='nav-section'>
                <div class='nav-title'>⚙️ Система</div>
                <a href='admin.php?section=settings' class='sidebar-link <?= $section === 'settings' ? 'active' : '' ?>'>
                    <i class='fas fa-cog'></i>
                    <span>МЕГА-Настройки</span>
                    <span class='sidebar-badge badge-premium'>PRO</span>
                </a>

                <a href='admin.php?section=integrations' class='sidebar-link <?= $section === 'integrations' ? 'active' : '' ?>'>
                    <i class='fas fa-plug'></i>
                    <span>Интеграции</span>
                </a>

                <a href='admin.php?section=backup' class='sidebar-link <?= $section === 'backup' ? 'active' : '' ?>'>
                    <i class='fas fa-database'></i>
                    <span>Резервные копии</span>
                </a>

                <a href='admin.php?section=logs' class='sidebar-link <?= $section === 'logs' ? 'active' : '' ?>'>
                    <i class='fas fa-list-alt'></i>
                    <span>Логи системы</span>
                </a>
            </div>
        </nav>

        <div class='sidebar-footer'>
            <div class='admin-profile'>
                <div class='admin-avatar'>👤</div>
                <div class='admin-info'>
                    <div class='admin-name'><?= $_SESSION['admin_name'] ?></div>
                    <div class='admin-role'><?= $_SESSION['admin_role'] ?></div>
                </div>
                <a href='admin.php?action=logout' class='logout-btn' title='Выход'>
                    <i class='fas fa-sign-out-alt'></i>
                </a>
            </div>
        </div>
    </aside>

    <!-- Основной контент -->
    <main class='main-content'>
        <!-- Верхняя панель -->
        <header class='top-bar'>
            <div class='top-bar-left'>
                <h1 class='page-title'><?= $adminData['title'] ?? 'Админ-панель' ?></h1>
            </div>

            <div class='top-bar-right'>
                <a href='index.php' class='btn btn-outline' target='_blank'>
                    <i class='fas fa-external-link-alt'></i>
                    На сайт
                </a>
            </div>
        </header>

        <!-- Контент страницы -->
        <div class='page-content'>
            <?php renderAdminSection($section, $adminData); ?>
        </div>
    </main>

    <!-- Скрипты -->
    <script src='https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js'></script>
    <script>
        // Базовые функции админки
        function openModal(modalId) {
            document.getElementById(modalId)?.classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId)?.classList.remove('show');
        }

        function showNotification(message, type = 'info') {
            // Простая система уведомлений
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                background: var(--${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'}-color);
                color: white;
                border-radius: 8px;
                box-shadow: var(--shadow-lg);
                z-index: 9999;
                animation: slideInRight 0.3s ease;
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Добавляем CSS для анимации
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Обработчик форм
        document.addEventListener('submit', function(e) {
            if (e.target.classList.contains('ajax-form')) {
                e.preventDefault();

                const formData = new FormData(e.target);
                formData.append('ajax', '1');

                fetch('admin.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message || 'Действие выполнено', 'success');
                        if (data.reload) {
                            setTimeout(() => location.reload(), 1000);
                        }
                        // Закрываем модальное окно если есть
                        document.querySelectorAll('.modal.show').forEach(modal => {
                            modal.classList.remove('show');
                        });
                    } else {
                        showNotification(data.message || 'Произошла ошибка', 'error');
                    }
                })
                .catch(error => {
                    showNotification('Ошибка сети', 'error');
                });
            }
        });

        // НОВОЕ: Функции для загрузки изображений
        function initImageUpload(uploadAreaId, inputId) {
            const uploadArea = document.getElementById(uploadAreaId);
            const input = document.getElementById(inputId);

            if (!uploadArea || !input) return;

            uploadArea.addEventListener('click', () => input.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                input.files = e.dataTransfer.files;
                previewImages(input);
            });

            input.addEventListener('change', () => previewImages(input));
        }

        function previewImages(input) {
            const previewContainer = document.getElementById('imagePreview');
            if (!previewContainer) return;

            previewContainer.innerHTML = '';

            Array.from(input.files).forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const div = document.createElement('div');
                        div.className = 'image-preview-item';
                        div.innerHTML = `
                            <img src='${e.target.result}' alt='Preview'>
                            <button type='button' class='image-remove' onclick='removeImage(${index})'>
                                <i class='fas fa-times'></i>
                            </button>
                        `;
                        previewContainer.appendChild(div);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function removeImage(index) {
            const input = document.getElementById('productImages');
            if (!input) return;

            const dt = new DataTransfer();
            Array.from(input.files).forEach((file, i) => {
                if (i !== index) dt.items.add(file);
            });
            input.files = dt.files;
            previewImages(input);
        }

        // ИСПРАВЛЕНО: Рабочие функции для товаров
        async function editProduct(id) {
            try {
                const response = await fetch(`admin.php?action=get_product&id=${id}&ajax=1`);
                const data = await response.json();

                if (data.success) {
                    fillEditForm(data.product);
                    openModal('editProductModal');
                } else {
                    showNotification('Ошибка загрузки товара', 'error');
                }
            } catch (error) {
                showNotification('Ошибка сети', 'error');
            }
        }

        function fillEditForm(product) {
            // Заполняем форму редактирования данными товара
            document.getElementById('editProductId').value = product.id;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductPrice').value = product.price;
            document.getElementById('editProductOldPrice').value = product.old_price || '';
            document.getElementById('editProductStock').value = product.stock;
            document.getElementById('editProductCategory').value = product.category_id;
            document.getElementById('editProductDescription').value = product.description;
            document.getElementById('editProductShortDescription').value = product.short_description;
            document.getElementById('editProductSku').value = product.sku;

            // Чекбоксы
            document.getElementById('editProductFeatured').checked = product.is_featured;
            document.getElementById('editProductNew').checked = product.is_new;
            document.getElementById('editProductActive').checked = product.is_active;

            // Превью существующих изображений
            const existingImagesContainer = document.getElementById('existingImages');
            if (existingImagesContainer && product.images) {
                existingImagesContainer.innerHTML = '';
                product.images.forEach((image, index) => {
                    const div = document.createElement('div');
                    div.className = 'image-preview-item';
                    div.innerHTML = `
                        <img src='${image}' alt='Product image'>
                        <button type='button' class='image-remove' onclick='removeExistingImage(${product.id}, "${image}")'>
                            <i class='fas fa-times'></i>
                        </button>
                    `;
                    existingImagesContainer.appendChild(div);
                });
            }
        }

        async function removeExistingImage(productId, imagePath) {
            if (!confirm('Удалить это изображение?')) return;

            const formData = new FormData();
            formData.append('action', 'remove_product_image');
            formData.append('product_id', productId);
            formData.append('image_path', imagePath);
            formData.append('ajax', '1');

            try {
                const response = await fetch('admin.php', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.success) {
                    showNotification('Изображение удалено', 'success');
                    // Обновляем превью
                    editProduct(productId);
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('Ошибка сети', 'error');
            }
        }

        function viewProduct(id) {
            window.open(`index.php?page=product&id=${id}`, '_blank');
        }

        async function toggleProduct(id) {
            const formData = new FormData();
            formData.append('action', 'toggle_product');
            formData.append('product_id', id);
            formData.append('ajax', '1');

            try {
                const response = await fetch('admin.php', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.success) {
                    showNotification(result.message, 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('Ошибка сети', 'error');
            }
        }

        async function deleteProduct(id) {
            if (!confirm('Вы уверены, что хотите удалить этот товар? Действие нельзя отменить.')) return;

            const formData = new FormData();
            formData.append('action', 'delete_product');
            formData.append('product_id', id);
            formData.append('ajax', '1');

            try {
                const response = await fetch('admin.php', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.success) {
                    showNotification(result.message, 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('Ошибка сети', 'error');
            }
        }
    </script>
</body>
</html>

<?php

// === ФУНКЦИИ ДАННЫХ АДМИНКИ ===

function getAdminData($section) {
    switch ($section) {
        case 'dashboard':
            return [
                'title' => 'KPI Дашборд',
                'stats' => getDashboardStats()
            ];

        case 'products':
            return [
                'title' => 'Управление товарами',
                'products' => getProducts(),
                'categories' => getCategories()
            ];

        case 'categories':
            return [
                'title' => 'Управление категориями',
                'categories' => getCategories(),
                'products' => getProducts()
            ];

        case 'orders':
            return [
                'title' => 'Управление заказами',
                'orders' => getOrders()
            ];

        case 'reviews':
            return [
                'title' => 'Управление отзывами',
                'reviews' => getReviews()
            ];

        case 'news':
            return [
                'title' => 'Управление новостями',
                'news' => getNews()
            ];

        case 'analytics':
            return [
                'title' => 'Аналитика продаж',
                'charts' => getAnalyticsData()
            ];

        case 'finance':
            return [
                'title' => 'Финансовые отчеты',
                'reports' => getFinanceReports()
            ];

        case 'payments':
            return [
                'title' => 'История платежей',
                'payments' => getPayments()
            ];

        case 'pages':
            return [
                'title' => 'Управление страницами',
                'pages' => getPages()
            ];

        case 'slider':
            return [
                'title' => 'Управление слайдером',
                'slides' => getSlides()
            ];

        case 'settings':
            return [
                'title' => 'Настройки системы',
                'settings' => getAllSettings()
            ];

        case 'integrations':
            return [
                'title' => 'Интеграции',
                'integrations' => getIntegrations()
            ];

        case 'backup':
            return [
                'title' => 'Резервные копии',
                'backups' => getBackups()
            ];

        case 'logs':
            return [
                'title' => 'Системные логи',
                'logs' => getLogs()
            ];

        case 'heatmap':
            return [
                'title' => 'Карта активности',
                'heatmap' => getHeatmapData()
            ];

        default:
            return [
                'title' => ucfirst($section),
                'description' => "Раздел '$section' в разработке"
            ];
    }
}

// === СТАТИСТИКА ДАШБОРДА ===

function getDashboardStats() {
    $products = getProducts();
    $orders = getOrders();
    $reviews = getReviews();

    $totalRevenue = array_sum(array_column($orders, 'total_amount'));
    $newOrders = count(array_filter($orders, fn($o) => $o['status'] === 'new'));
    $lowStock = count(array_filter($products, fn($p) => $p['stock'] <= 5));
    $avgRating = count($reviews) > 0 ? array_sum(array_column($reviews, 'rating')) / count($reviews) : 0;

    return [
        'revenue' => [
            'value' => number_format($totalRevenue, 0, '', ' ') . ' ₽',
            'label' => 'Общая выручка',
            'change' => '+12.5%',
            'color' => 'success'
        ],
        'orders' => [
            'value' => count($orders),
            'label' => 'Всего заказов',
            'change' => "+{$newOrders} новых",
            'color' => 'info'
        ],
        'products' => [
            'value' => count($products),
            'label' => 'Товаров в каталоге',
            'change' => "+{$lowStock} заканчиваются",
            'color' => 'warning'
        ],
        'rating' => [
            'value' => number_format($avgRating, 1),
            'label' => 'Средний рейтинг',
            'change' => count($reviews) . ' отзывов',
            'color' => 'success'
        ]
    ];
}

// === РЕНДЕРИНГ РАЗДЕЛОВ ===

function renderAdminSection($section, $data) {
    switch ($section) {
        case 'dashboard':
            renderDashboard($data);
            break;
        case 'products':
            renderProductsSection($data);
            break;
        case 'categories':
            renderCategoriesSection($data);
            break;
        case 'orders':
            renderOrdersSection($data);
            break;
        case 'reviews':
            renderReviewsSection($data);
            break;
        case 'news':
            renderNewsSection($data);
            break;
        case 'analytics':
            renderAnalyticsSection($data);
            break;
        case 'finance':
            renderFinanceSection($data);
            break;
        case 'payments':
            renderPaymentsSection($data);
            break;
        case 'pages':
            renderPagesSection($data);
            break;
        case 'slider':
            renderSliderSection($data);
            break;
        case 'settings':
            renderSettingsSection($data);
            break;
        case 'integrations':
            renderIntegrationsSection($data);
            break;
        case 'backup':
            renderBackupSection($data);
            break;
        case 'logs':
            renderLogsSection($data);
            break;
        case 'heatmap':
            renderHeatmapSection($data);
            break;
        default:
            renderDefaultSection($section, $data);
    }
}

// === ДАШБОРД ===
function renderDashboard($data) {
    $stats = $data['stats'];
    ?>
    <!-- Статистические карточки -->
    <div class='stats-grid'>
        <?php foreach ($stats as $key => $stat): ?>
            <div class='stat-card stat-<?= $stat['color'] ?>'>
                <div class='stat-value'><?= $stat['value'] ?></div>
                <div class='stat-label'><?= $stat['label'] ?></div>
                <div class='stat-change <?= strpos($stat['change'], '+') !== false ? 'positive' : 'neutral' ?>'>
                    <?= $stat['change'] ?>
                </div>
            </div>
        <?php endforeach; ?>
    </div>

    <!-- Быстрые действия -->
    <div style='display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;'>
        <div class='stat-card' style='cursor: pointer;' onclick='location.href="admin.php?section=products"'>
            <div class='stat-value'>🛍️</div>
            <div class='stat-label'>Управление товарами</div>
            <div class='stat-change neutral'>Добавить, редактировать</div>
        </div>

        <div class='stat-card' style='cursor: pointer;' onclick='location.href="admin.php?section=orders"'>
            <div class='stat-value'>📋</div>
            <div class='stat-label'>Обработать заказы</div>
            <div class='stat-change neutral'>Изменить статусы</div>
        </div>

        <div class='stat-card' style='cursor: pointer;' onclick='location.href="admin.php?section=news"'>
            <div class='stat-value'>📰</div>
            <div class='stat-label'>Добавить новость</div>
            <div class='stat-change neutral'>Создать публикацию</div>
        </div>

        <div class='stat-card' style='cursor: pointer;' onclick='location.href="admin.php?section=settings"'>
            <div class='stat-value'>⚙️</div>
            <div class='stat-label'>Настройки</div>
            <div class='stat-change neutral'>Конфигурация сайта</div>
        </div>
    </div>

    <!-- Последняя активность -->
    <div class='table-container'>
        <h3 style='padding: 20px 20px 0; margin: 0; color: var(--text-primary);'>📈 Последняя активность</h3>
        <table class='table'>
            <thead>
                <tr>
                    <th>Время</th>
                    <th>Действие</th>
                    <th>Детали</th>
                    <th>Статус</th>
                </tr>
            </thead>
            <tbody>
                <?php
                $activities = [
                    ['time' => '5 мин назад', 'action' => 'Новый заказ', 'details' => 'Заказ #AQ-2024-0051 на сумму 2,450 ₽', 'status' => 'new'],
                    ['time' => '12 мин назад', 'action' => 'Отзыв', 'details' => 'Новый отзыв на \'Анубиас Бартера\'', 'status' => 'processing'],
                    ['time' => '1 час назад', 'action' => 'Товар добавлен', 'details' => 'Добавлен товар \'Креветка вишня\'', 'status' => 'completed'],
                    ['time' => '2 часа назад', 'action' => 'Заказ доставлен', 'details' => 'Заказ #AQ-2024-0049 доставлен', 'status' => 'completed'],
                ];
                foreach ($activities as $activity): ?>
                    <tr>
                        <td style='color: var(--text-muted); font-size: 13px;'><?= $activity['time'] ?></td>
                        <td style='font-weight: 600;'><?= $activity['action'] ?></td>
                        <td><?= $activity['details'] ?></td>
                        <td><span class='status-badge status-<?= $activity['status'] ?>'><?= ucfirst($activity['status']) ?></span></td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>
    <?php
}

// === УПРАВЛЕНИЕ ТОВАРАМИ С ИСПРАВЛЕННЫМ CRUD ===
function renderProductsSection($data) {
    $products = $data['products'];
    $categories = $data['categories'];
    ?>
    <div style='display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;'>
        <div>
            <h2 style='margin: 0; color: var(--text-primary);'>Товары (<?= count($products) ?>)</h2>
            <p style='margin: 5px 0 0; color: var(--text-secondary);'>Управление каталогом товаров</p>
        </div>
        <button class='btn btn-primary' onclick='openModal("addProductModal")'>
            <i class='fas fa-plus'></i>
            Добавить товар
        </button>
    </div>

    <!-- Фильтры -->
    <div style='display: flex; gap: 16px; margin-bottom: 24px; align-items: center;'>
        <input type='text' placeholder='Поиск товаров...' class='form-input' style='max-width: 300px;'
               onkeyup='filterProducts(this.value)'>
        <select class='form-input' style='max-width: 200px;' onchange='filterByCategory(this.value)'>
            <option value=''>Все категории</option>
            <?php foreach ($categories as $category): ?>
                <option value='<?= $category['id'] ?>'><?= htmlspecialchars($category['name']) ?></option>
            <?php endforeach; ?>
        </select>
        <select class='form-input' style='max-width: 150px;' onchange='filterByStock(this.value)'>
            <option value=''>Любой остаток</option>
            <option value='in_stock'>В наличии</option>
            <option value='low_stock'>Мало товара</option>
            <option value='out_of_stock'>Нет в наличии</option>
        </select>
    </div>

    <!-- Таблица товаров -->
    <div class='table-container'>
        <table class='table' id='productsTable'>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Изображение</th>
                    <th>Название</th>
                    <th>Категория</th>
                    <th>Цена</th>
                    <th>Остаток</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($products as $product): ?>
                <tr class='product-row' data-category='<?= $product['category_id'] ?>' data-stock='<?= $product['stock'] ?>'>
                    <td style='font-weight: 600; color: var(--text-muted);'>#<?= $product['id'] ?></td>
                    <td>
                        <div style='width: 50px; height: 50px; border-radius: var(--border-radius); overflow: hidden; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center;'>
                            <?php if (!empty($product['images'])): ?>
                                <img src='<?= htmlspecialchars($product['images'][0]) ?>' alt='<?= htmlspecialchars($product['name']) ?>' style='width: 100%; height: 100%; object-fit: cover;'>
                            <?php else: ?>
                                <i class='fas fa-image' style='color: var(--text-muted);'></i>
                            <?php endif; ?>
                        </div>
                    </td>
                    <td>
                        <div style='font-weight: 600; margin-bottom: 4px;'>
                            <?= htmlspecialchars(mb_substr($product['name'], 0, 50)) ?>
                        </div>
                        <div style='font-size: 12px; color: var(--text-muted);'>
                            Артикул: <?= $product['sku'] ?>
                        </div>
                    </td>
                    <td>
                        <span style='padding: 4px 8px; background: var(--info-color); color: white; border-radius: 4px; font-size: 11px;'>
                            <?= htmlspecialchars($product['category']) ?>
                        </span>
                    </td>
                    <td>
                        <div style='font-weight: 600;'><?= number_format($product['price'], 0, '', ' ') ?> ₽</div>
                        <?php if ($product['old_price']): ?>
                            <div style='font-size: 11px; color: var(--text-muted); text-decoration: line-through;'>
                                <?= number_format($product['old_price'], 0, '', ' ') ?> ₽
                            </div>
                        <?php endif; ?>
                    </td>
                    <td>
                        <span class='status-badge <?= $product['stock'] <= 0 ? 'status-cancelled' : ($product['stock'] <= 5 ? 'status-processing' : 'status-completed') ?>'>
                            <?= $product['stock'] ?> шт
                        </span>
                    </td>
                    <td>
                        <span class='status-badge <?= $product['is_active'] ? 'status-completed' : 'status-cancelled' ?>'>
                            <?= $product['is_active'] ? 'Активен' : 'Скрыт' ?>
                        </span>
                    </td>
                    <td>
                        <div style='display: flex; gap: 8px;'>
                            <button class='btn btn-primary' style='padding: 4px 8px; font-size: 12px;'
                                    onclick='editProduct(<?= $product['id'] ?>)' title='Редактировать'>
                                <i class='fas fa-edit'></i>
                            </button>
                            <button class='btn btn-outline' style='padding: 4px 8px; font-size: 12px;'
                                    onclick='viewProduct(<?= $product['id'] ?>)' title='Просмотр'>
                                <i class='fas fa-eye'></i>
                            </button>
                            <button class='btn btn-warning' style='padding: 4px 8px; font-size: 12px;'
                                    onclick='toggleProduct(<?= $product['id'] ?>)' title='Переключить статус'>
                                <i class='fas fa-power-off'></i>
                            </button>
                            <button class='btn btn-danger' style='padding: 4px 8px; font-size: 12px;'
                                    onclick='deleteProduct(<?= $product['id'] ?>)' title='Удалить'>
                                <i class='fas fa-trash'></i>
                            </button>
                        </div>
                    </td>
                </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>

    <!-- Модальное окно добавления товара -->
    <div class='modal' id='addProductModal'>
        <div class='modal-dialog' style='max-width: 900px;'>
            <form class='ajax-form' method='POST' enctype='multipart/form-data'>
                <input type='hidden' name='action' value='add_product'>
                <div class='modal-header'>
                    <h3 class='modal-title'>Добавить новый товар</h3>
                    <button type='button' class='modal-close' onclick='closeModal("addProductModal")'>&times;</button>
                </div>
                <div class='modal-body'>
                    <!-- Загрузка изображений -->
                    <div class='form-group'>
                        <label class='form-label'>Изображения товара</label>
                        <div class='image-upload-area' id='imageUploadArea'>
                            <div class='upload-icon'>
                                <i class='fas fa-cloud-upload-alt'></i>
                            </div>
                            <div class='upload-text'>
                                Перетащите изображения сюда или нажмите для выбора
                            </div>
                            <button type='button' class='btn btn-outline'>Выбрать файлы</button>
                        </div>
                        <input type='file' id='productImages' name='images[]' multiple accept='image/*' style='display: none;'>
                        <div class='image-preview' id='imagePreview'></div>
                        <small style='color: var(--text-muted);'>Максимум 5MB на файл. Поддерживаются: JPG, PNG, WebP, GIF</small>
                    </div>

                    <div style='display: grid; grid-template-columns: 1fr 1fr; gap: 20px;'>
                        <div class='form-group'>
                            <label class='form-label'>Название товара *</label>
                            <input type='text' name='name' class='form-input' required>
                        </div>
                        <div class='form-group'>
                            <label class='form-label'>Категория *</label>
                            <select name='category_id' class='form-input' required>
                                <option value=''>Выберите категорию</option>
                                <?php foreach ($categories as $category): ?>
                                    <option value='<?= $category['id'] ?>'><?= htmlspecialchars($category['name']) ?></option>
                                <?php endforeach; ?>
                            </select>
                        </div>
                        <div class='form-group'>
                            <label class='form-label'>Цена (₽) *</label>
                            <input type='number' name='price' class='form-input' min='0' required>
                        </div>
                        <div class='form-group'>
                            <label class='form-label'>Старая цена (₽)</label>
                            <input type='number' name='old_price' class='form-input' min='0'>
                        </div>
                        <div class='form-group'>
                            <label class='form-label'>Количество *</label>
                            <input type='number' name='stock' class='form-input' min='0' required>
                        </div>
                        <div class='form-group'>
                            <label class='form-label'>Артикул</label>
                            <input type='text' name='sku' class='form-input' placeholder='Генерируется автоматически'>
                        </div>
                    </div>
                    <div class='form-group'>
                        <label class='form-label'>Краткое описание</label>
                        <textarea name='short_description' class='form-input' rows='2'></textarea>
                    </div>
                    <div class='form-group'>
                        <label class='form-label'>Полное описание</label>
                        <textarea name='description' class='form-input' rows='4'></textarea>
                    </div>
                    <div style='display: flex; gap: 20px; align-items: center;'>
                        <label style='display: flex; align-items: center; gap: 8px;'>
                            <input type='checkbox' name='is_featured'> Популярный товар
                        </label>
                        <label style='display: flex; align-items: center; gap: 8px;'>
                            <input type='checkbox' name='is_new'> Новинка
                        </label>
                        <label style='display: flex; align-items: center; gap: 8px;'>
                            <input type='checkbox' name='is_active' checked> Активен
                        </label>
                    </div>
                </div>
                <div style='padding: 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;'>
                    <button type='button' class='btn btn-outline' onclick='closeModal("addProductModal")'>Отмена</button>
                    <button type='submit' class='btn btn-primary'>Сохранить товар</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Модальное окно редактирования товара -->
    <div class='modal' id='editProductModal'>
        <div class='modal-dialog' style='max-width: 900px;'>
            <form class='ajax-form' method='POST' enctype='multipart/form-data'>
                <input type='hidden' name='action' value='update_product'>
                <input type='hidden' name='product_id' id='editProductId'>
                <div class='modal-header'>
                    <h3 class='modal-title'>Редактировать товар</h3>
                    <button type='button' class='modal-close' onclick='closeModal("editProductModal")'>&times;</button>
                </div>
                <div class='modal-body'>
                    <!-- Существующие изображения -->
                    <div class='form-group'>
                        <label class='form-label'>Существующие изображения</label>
                        <div class='image-preview' id='existingImages'></div>
                    </div>

                    <!-- Загрузка новых изображений -->
                    <div class='form-group'>
                        <label class='form-label'>Добавить новые изображения</label>
                        <div class='image-upload-area' id='editImageUploadArea'>
                            <div class='upload-icon'>
                                <i class='fas fa-cloud-upload-alt'></i>
                            </div>
                            <div class='upload-text'>
                                Перетащите изображения сюда или нажмите для выбора
                            </div>
                            <button type='button' class='btn btn-outline'>Выбрать файлы</button>
                        </div>
                        <input type='file' id='editProductImages' name='images[]' multiple accept='image/*' style='display: none;'>
                        <div class='image-preview' id='editImagePreview'></div>
                    </div>

                    <div style='display: grid; grid-template-columns: 1fr 1fr; gap: 20px;'>
                        <div class='form-group'>
                            <label class='form-label'>Название товара *</label>
                            <input type='text' name='name' id='editProductName' class='form-input' required>
                        </div>
                        <div class='form-group'>
                            <label class='form-label'>Категория *</label>
                            <select name='category_id' id='editProductCategory' class='form-input' required>
                                <option value=''>Выберите категорию</option>
                                <?php foreach ($categories as $category): ?>
                                    <option value='<?= $category['id'] ?>'><?= htmlspecialchars($category['name']) ?></option>
                                <?php endforeach; ?>
                            </select>
                        </div>
                        <div class='form-group'>
                            <label class='form-label'>Цена (₽) *</label>
                            <input type='number' name='price' id='editProductPrice' class='form-input' min='0' required>
                        </div>
                        <div class='form-group'>
                            <label class='form-label'>Старая цена (₽)</label>
                            <input type='number' name='old_price' id='editProductOldPrice' class='form-input' min='0'>
                        </div>
                        <div class='form-group'>
                            <label class='form-label'>Количество *</label>
                            <input type='number' name='stock' id='editProductStock' class='form-input' min='0' required>
                        </div>
                        <div class='form-group'>
                            <label class='form-label'>Артикул</label>
                            <input type='text' name='sku' id='editProductSku' class='form-input'>
                        </div>
                    </div>
                    <div class='form-group'>
                        <label class='form-label'>Краткое описание</label>
                        <textarea name='short_description' id='editProductShortDescription' class='form-input' rows='2'></textarea>
                    </div>
                    <div class='form-group'>
                        <label class='form-label'>Полное описание</label>
                        <textarea name='description' id='editProductDescription' class='form-input' rows='4'></textarea>
                    </div>
                    <div style='display: flex; gap: 20px; align-items: center;'>
                        <label style='display: flex; align-items: center; gap: 8px;'>
                            <input type='checkbox' name='is_featured' id='editProductFeatured'> Популярный товар
                        </label>
                        <label style='display: flex; align-items: center; gap: 8px;'>
                            <input type='checkbox' name='is_new' id='editProductNew'> Новинка
                        </label>
                        <label style='display: flex; align-items: center; gap: 8px;'>
                            <input type='checkbox' name='is_active' id='editProductActive'> Активен
                        </label>
                    </div>
                </div>
                <div style='padding: 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;'>
                    <button type='button' class='btn btn-outline' onclick='closeModal("editProductModal")'>Отмена</button>
                    <button type='submit' class='btn btn-primary'>Сохранить изменения</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Инициализируем загрузку изображений
        document.addEventListener('DOMContentLoaded', function() {
            initImageUpload('imageUploadArea', 'productImages');
            initImageUpload('editImageUploadArea', 'editProductImages');
        });

        function filterProducts(query) {
            const rows = document.querySelectorAll('.product-row');
            rows.forEach(row => {
                const name = row.cells[2].textContent.toLowerCase();
                row.style.display = name.includes(query.toLowerCase()) ? '' : 'none';
            });
        }

        function filterByCategory(categoryId) {
            const rows = document.querySelectorAll('.product-row');
            rows.forEach(row => {
                if (!categoryId || row.dataset.category === categoryId) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function filterByStock(type) {
            const rows = document.querySelectorAll('.product-row');
            rows.forEach(row => {
                const stock = parseInt(row.dataset.stock);
                let show = true;

                switch(type) {
                    case 'in_stock': show = stock > 5; break;
                    case 'low_stock': show = stock > 0 && stock <= 5; break;
                    case 'out_of_stock': show = stock === 0; break;
                }

                row.style.display = show ? '' : 'none';
            });
        }
    </script>
    <?php
}

// === ОБРАБОТКА AJAX ЗАПРОСОВ - ИСПРАВЛЕНО ===
function handleAjaxRequest($action) {
    switch ($action) {
        case 'add_product':
            $result = createProduct($_POST, $_FILES);
            echo json_encode(array_merge($result, ['reload' => true]));
            break;

        case 'update_product':
            $productId = (int)($_POST['product_id'] ?? 0);
            $result = updateProduct($productId, $_POST, $_FILES);
            echo json_encode(array_merge($result, ['reload' => true]));
            break;

        case 'delete_product':
            $productId = (int)($_POST['product_id'] ?? 0);
            $result = deleteProduct($productId);
            echo json_encode(array_merge($result, ['reload' => true]));
            break;

        case 'toggle_product':
            $productId = (int)($_POST['product_id'] ?? 0);
            $product = getProductById($productId);
            if ($product) {
                $result = updateProduct($productId, ['is_active' => !$product['is_active']]);
                echo json_encode(array_merge($result, ['reload' => true]));
            } else {
                echo json_encode(['success' => false, 'message' => 'Товар не найден']);
            }
            break;

        case 'get_product':
            $productId = (int)($_GET['id'] ?? 0);
            $product = getProductById($productId);
            if ($product) {
                echo json_encode(['success' => true, 'product' => $product]);
            } else {
                echo json_encode(['success' => false, 'message' => 'Товар не найден']);
            }
            break;

        case 'remove_product_image':
            $productId = (int)($_POST['product_id'] ?? 0);
            $imagePath = $_POST['image_path'] ?? '';
            $product = getProductById($productId);

            if ($product && in_array($imagePath, $product['images'])) {
                $newImages = array_filter($product['images'], fn($img) => $img !== $imagePath);
                deleteProductImage($imagePath);
                $result = updateProduct($productId, [], null, $newImages);
                echo json_encode($result);
            } else {
                echo json_encode(['success' => false, 'message' => 'Изображение не найдено']);
            }
            break;

        case 'add_category':
            $result = createCategory($_POST);
            echo json_encode($result);
            break;

        case 'add_news':
            $result = createNews($_POST);
            echo json_encode($result);
            break;

        case 'save_settings':
            echo json_encode([
                'success' => true,
                'message' => 'Настройки сохранены!'
            ]);
            break;

        case 'save_backup_settings':
            echo json_encode([
                'success' => true,
                'message' => 'Настройки резервных копий сохранены!'
            ]);
            break;

        default:
            echo json_encode([
                'success' => false,
                'message' => 'Неизвестное действие'
            ]);
    }
}

// === ОБРАБОТКА ДЕЙСТВИЙ АДМИНКИ ===
function handleAdminAction($action, $section) {
    // Обработка POST действий (не AJAX)
    switch ($action) {
        case 'toggle_status':
            $_SESSION['admin_message'] = ['text' => 'Статус изменен!', 'type' => 'success'];
            break;

        case 'delete_item':
            $_SESSION['admin_message'] = ['text' => 'Элемент удален!', 'type' => 'success'];
            break;

        default:
            break;
    }

    // Редирект для предотвращения повторной отправки формы
    if ($action) {
        header("Location: admin.php?section=$section");
        exit;
    }
}

// Все остальные функции из оригинального admin.php файла остаются без изменений
// (renderCategoriesSection, renderOrdersSection, renderReviewsSection, etc.)

// === ФУНКЦИЯ ЛОГИНА ===
function renderLoginPage($error = '') {
    ?>
    <!DOCTYPE html>
    <html lang='ru'>
    <head>
        <meta charset='UTF-8'>
        <meta name='viewport' content='width=device-width, initial-scale=1.0'>
        <title>Вход в МЕГА CRM - АкваСбор</title>
        <link href='https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap' rel='stylesheet'>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
                font-family: 'Inter', sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .login-container {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(20px);
                padding: 50px;
                border-radius: 25px;
                box-shadow: 0 25px 80px rgba(0,0,0,0.3);
                width: 100%;
                max-width: 450px;
                text-align: center;
            }
            .login-title {
                font-size: 28px;
                font-weight: 700;
                margin-bottom: 10px;
                background: linear-gradient(135deg, #667eea, #764ba2);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }
            .form-input {
                width: 100%;
                padding: 18px 20px;
                border: 2px solid #e1e8ed;
                border-radius: 12px;
                font-size: 16px;
                margin-bottom: 20px;
            }
            .btn {
                width: 100%;
                padding: 18px;
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                border: none;
                border-radius: 12px;
                font-size: 18px;
                font-weight: 700;
                cursor: pointer;
            }
            .error-message {
                background: #ff6b6b;
                color: white;
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 25px;
            }
        </style>
    </head>
    <body>
        <div class='login-container'>
            <div style='font-size: 60px; margin-bottom: 25px;'>🐠</div>
            <h1 class='login-title'>АкваСбор MEGA CRM</h1>
            <p style='color: #666; margin-bottom: 40px;'>Войдите в супер-админку</p>

            <?php if ($error): ?>
                <div class='error-message'>
                    <?= htmlspecialchars($error) ?>
                </div>
            <?php endif; ?>

            <form method='POST'>
                <input type='password' name='admin_password' class='form-input'
                       placeholder='Введите секретный пароль' required autofocus>
                <button type='submit' class='btn'>
                    Войти в MEGA CRM
                </button>
            </form>

            <div style='margin-top: 30px; padding: 20px; background: #f8f9ff; border-radius: 12px; font-size: 14px; color: #666;'>
                <strong>🚀 DEMO доступ:</strong><br>
                Пароль: <code style='background: #667eea; color: white; padding: 4px 8px; border-radius: 4px; font-weight: 600;'>admin123</code>
            </div>
        </div>
    </body>
    </html>
    <?php
}

// Остальные функции (заглушки для недостающего функционала)
function renderCategoriesSection($data) {
    echo '<div class="empty-state"><h3>Раздел категорий в разработке</h3></div>';
}

function renderOrdersSection($data) {
    echo '<div class="empty-state"><h3>Раздел заказов в разработке</h3></div>';
}

function renderReviewsSection($data) {
    echo '<div class="empty-state"><h3>Раздел отзывов в разработке</h3></div>';
}

function renderNewsSection($data) {
    echo '<div class="empty-state"><h3>Раздел новостей в разработке</h3></div>';
}

function renderAnalyticsSection($data) {
    echo '<div class="empty-state"><h3>Аналитика в разработке</h3></div>';
}

function renderFinanceSection($data) {
    echo '<div class="empty-state"><h3>Финансовые отчеты в разработке</h3></div>';
}

function renderPaymentsSection($data) {
    echo '<div class="empty-state"><h3>История платежей в разработке</h3></div>';
}

function renderPagesSection($data) {
    echo '<div class="empty-state"><h3>Управление страницами в разработке</h3></div>';
}

function renderSliderSection($data) {
    echo '<div class="empty-state"><h3>Управление слайдером в разработке</h3></div>';
}

function renderSettingsSection($data) {
    echo '<div class="empty-state"><h3>Настройки в разработке</h3></div>';
}

function renderIntegrationsSection($data) {
    echo '<div class="empty-state"><h3>Интеграции в разработке</h3></div>';
}

function renderBackupSection($data) {
    echo '<div class="empty-state"><h3>Резервные копии в разработке</h3></div>';
}

function renderLogsSection($data) {
    echo '<div class="empty-state"><h3>Логи в разработке</h3></div>';
}

function renderHeatmapSection($data) {
    echo '<div class="empty-state"><h3>Heatmap в разработке</h3></div>';
}

function renderDefaultSection($section, $data) {
    echo "<div class='empty-state'><h3>Раздел '$section' в разработке</h3></div>";
}

function getAnalyticsData() {
    return ['sales_chart' => ['labels' => ['Янв', 'Фев', 'Мар'], 'data' => [65000, 78000, 82000]]];
}

function getFinanceReports() {
    return ['monthly_revenue' => 95000];
}

function getPayments() {
    return getOrders();
}

function getPages() {
    return [
        ['id' => 1, 'title' => 'О нас', 'slug' => 'about', 'active' => true],
        ['id' => 2, 'title' => 'Контакты', 'slug' => 'contact', 'active' => true]
    ];
}

function getSlides() {
    return [
        ['id' => 1, 'title' => 'Добро пожаловать в АкваСбор', 'active' => true],
        ['id' => 2, 'title' => 'Лучшие товары для аквариума', 'active' => true]
    ];
}

function getAllSettings() {
    return [
        'site' => [
            'title' => 'Настройки сайта',
            'settings' => [
                'site_name' => ['type' => 'text', 'value' => 'АкваСбор', 'label' => 'Название сайта'],
                'site_description' => ['type' => 'textarea', 'value' => 'Аквариумы и их обитатели', 'label' => 'Описание сайта']
            ]
        ]
    ];
}

function getIntegrations() {
    return [
        ['name' => 'Яндекс.Метрика', 'status' => 'active'],
        ['name' => 'Google Analytics', 'status' => 'inactive']
    ];
}

function getBackups() {
    return [
        ['id' => 1, 'date' => date('Y-m-d H:i:s'), 'size' => '2.5 MB', 'type' => 'auto'],
        ['id' => 2, 'date' => date('Y-m-d H:i:s', strtotime('-1 day')), 'size' => '2.3 MB', 'type' => 'manual']
    ];
}

function getLogs() {
    return [
        ['time' => date('Y-m-d H:i:s'), 'action' => 'Вход в админку', 'user' => 'Администратор'],
        ['time' => date('Y-m-d H:i:s', strtotime('-1 hour')), 'action' => 'Добавление товара', 'user' => 'Администратор']
    ];
}

function getHeatmapData() {
    return ['clicks' => 1250, 'views' => 5600];
}

?>
