<?php
/**
 * –ê–∫–≤–∞–°–±–æ—Ä - –ú–ï–ì–ê –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å v7.1 - –°–£–ü–ï–† –ì–†–ê–§–ò–ö–ò + –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø
 * –í—Å–µ –º–æ–¥—É–ª–∏ —Ä–∞–±–æ—Ç–∞—é—Ç + –ú–ï–ì–ê–ú–û–î–ê–õ–ö–ê —Ç–æ–≤–∞—Ä–æ–≤ + AI —Ñ—É–Ω–∫—Ü–∏–∏ + –°–£–ü–ï–† –ê–ù–ê–õ–ò–¢–ò–ö–ê + –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
 */
session_start();

// –ü–æ–¥–∫–ª—é—á–∞–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã
require_once 'data.php';

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏ –ø–æ–¥–∫–ª—é—á–∞–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å
if (file_exists('date_functions.php')) {
    require_once 'date_functions.php';
}
if (file_exists('cart_system.php')) {
    require_once 'cart_system.php';
}

// –°–æ–∑–¥–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –µ—Å–ª–∏ —Ñ–∞–π–ª—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
if (!function_exists('formatDateRussian')) {
    function formatDateRussian($date, $format = 'full') {
        $timestamp = is_string($date) ? strtotime($date) : $date;
        if ($format === 'short') {
            return date('d.m.Y', $timestamp);
        }
        return date('d.m.Y H:i', $timestamp);
    }
}

// –ü—Ä–æ—Å—Ç–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
if (!isset($_SESSION['admin_logged_in'])) {
    if (($_POST['admin_password'] ?? '') === ADMIN_PASSWORD) {
        $_SESSION['admin_logged_in'] = true;
        $_SESSION['admin_name'] = '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
        $_SESSION['admin_role'] = '–°—É–ø–µ—Ä-–∞–¥–º–∏–Ω';

        // –õ–æ–≥–∏—Ä—É–µ–º –≤—Ö–æ–¥
        logAdminAction('AUTH', '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É');

        header('Location: admin.php');
        exit;
    } elseif (!empty($_POST['admin_password'])) {
        $login_error = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
    }
}

// –í—ã—Ö–æ–¥
if (($_GET['action'] ?? '') === 'logout') {
    logAdminAction('AUTH', '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤—ã—à–µ–ª –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
    session_destroy();
    header('Location: admin.php');
    exit;
}

// –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
if (!isset($_SESSION['admin_logged_in'])) {
    $error = $login_error ?? '';
    ?>
    <!DOCTYPE html>
    <html lang='ru'>
    <head>
        <meta charset='UTF-8'>
        <meta name='viewport' content='width=device-width, initial-scale=1.0'>
        <title>üê† –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –ê–∫–≤–∞–°–±–æ—Ä</title>
        <link href='https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap' rel='stylesheet'>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
                font-family: 'Inter', sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            }
            .login-container {
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.2);
                max-width: 400px;
                width: 100%;
                text-align: center;
            }
            .logo { font-size: 60px; margin-bottom: 20px; animation: float 3s ease-in-out infinite; }
            @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
            h2 { color: #2c3e50; margin-bottom: 30px; font-size: 28px; }
            input, button {
                width: 100%;
                padding: 15px;
                margin: 10px 0;
                border: 2px solid #e0e6ed;
                border-radius: 10px;
                font-size: 16px;
                transition: all 0.3s ease;
            }
            input:focus {
                border-color: #667eea;
                outline: none;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }
            button {
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                border: none;
                cursor: pointer;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 1px;
            }
            button:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            }
            .error {
                background: #fee;
                color: #c33;
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 20px;
                border: 1px solid #fcc;
            }
            .hint {
                margin-top: 20px;
                padding: 15px;
                background: #f8f9ff;
                border-radius: 10px;
                color: #666;
                font-size: 14px;
            }
        </style>
    </head>
    <body>
        <div class='login-container'>
            <div class='logo'>üê†</div>
            <h2>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
            <form method='post'>
                <?php if ($error): ?>
                    <div class='error'>‚ùå <?= htmlspecialchars($error) ?></div>
                <?php endif; ?>
                <input type='password' name='admin_password' placeholder='üîë –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å' required autofocus>
                <button type='submit'>–í–æ–π—Ç–∏ –≤ –ø–∞–Ω–µ–ª—å</button>
                <div class='hint'>
                    üí° <strong>–ü–∞—Ä–æ–ª—å:</strong> admin123<br>
                    üîí –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
                </div>
            </form>
        </div>
    </body>
    </html>
    <?php
    exit;
}

// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
$section = $_GET['section'] ?? 'dashboard';
$action = $_POST['action'] ?? $_GET['action'] ?? '';

// === –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ê–î–ú–ò–ù–ö–ò ===

function logAdminAction($context, $message, $data = null) {
    $logDir = __DIR__ . '/logs';
    if (!file_exists($logDir)) {
        mkdir($logDir, 0755, true);
    }

    $logFile = $logDir . '/admin_' . date('Y-m-d') . '.log';
    $timestamp = date('Y-m-d H:i:s');
    $ip = $_SERVER['REMOTE_ADDR'] ?? 'unknown';

    $logEntry = "[$timestamp] [$context] $message IP:$ip\n";
    file_put_contents($logFile, $logEntry, FILE_APPEND | LOCK_EX);

    // JSON –ª–æ–≥ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
    $jsonLogFile = $logDir . '/admin_logs.json';
    $logs = [];
    if (file_exists($jsonLogFile)) {
        $logs = json_decode(file_get_contents($jsonLogFile), true) ?: [];
    }

    array_unshift($logs, [
        'timestamp' => $timestamp,
        'level' => 'INFO',
        'context' => $context,
        'message' => $message,
        'ip' => $ip,
        'data' => $data
    ]);

    $logs = array_slice($logs, 0, 1000);
    file_put_contents($jsonLogFile, json_encode($logs, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
}

function getAdminLogs($limit = 50) {
    $jsonLogFile = __DIR__ . '/logs/admin_logs.json';
    if (!file_exists($jsonLogFile)) {
        return [];
    }

    $logs = json_decode(file_get_contents($jsonLogFile), true) ?: [];
    return array_slice($logs, 0, $limit);
}

function updateSiteSettings($data) {
    try {
        $dynamicData = initializeDynamicData();
        $settings = &$dynamicData['settings'];

        $allowedFields = [
            'site_name', 'site_description', 'site_keywords',
            'admin_email', 'phone', 'address', 'working_hours',
            'currency', 'products_per_page', 'min_order_amount',
            'free_shipping_from'
        ];

        foreach ($allowedFields as $field) {
            if (isset($data[$field])) {
                if (in_array($field, ['products_per_page', 'min_order_amount', 'free_shipping_from'])) {
                    $settings[$field] = (int)$data[$field];
                } else {
                    $settings[$field] = trim($data[$field]);
                }
            }
        }

        $dynamicData['last_updated'] = date('Y-m-d H:i:s');

        if (saveDynamicData($dynamicData)) {
            logAdminAction('SETTINGS', '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
            return ['success' => true, 'message' => '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!'];
        } else {
            return ['success' => false, 'message' => '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫'];
        }
    } catch (Exception $e) {
        return ['success' => false, 'message' => '–û—à–∏–±–∫–∞: ' . $e->getMessage()];
    }
}

// === –ú–ï–ì–ê –§–£–ù–ö–¶–ò–ò –î–õ–Ø –¢–û–í–ê–†–û–í ===

function generateProductSEO($name, $category, $description = '') {
    return [
        'meta_title' => $name . ' - –∫—É–ø–∏—Ç—å –≤ –ê–∫–≤–∞–°–±–æ—Ä —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π',
        'meta_description' => '–ö—É–ø–∏—Ç—å ' . $name . ' –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–µ –ê–∫–≤–∞–°–±–æ—Ä. ' . ($description ? $description . ' ' : '') . '–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –†–æ—Å—Å–∏–∏. –ì–∞—Ä–∞–Ω—Ç–∏—è –∫–∞—á–µ—Å—Ç–≤–∞.',
        'meta_keywords' => '–∞–∫–≤–∞—Ä–∏—É–º, ' . strtolower($category) . ', ' . strtolower($name) . ', –∫—É–ø–∏—Ç—å, –¥–æ—Å—Ç–∞–≤–∫–∞'
    ];
}

function analyzeProductImages($images) {
    $analysis = [
        'total_images' => count($images),
        'has_main_image' => !empty($images),
        'recommendations' => []
    ];

    if (empty($images)) {
        $analysis['recommendations'][] = '–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞';
    } elseif (count($images) < 3) {
        $analysis['recommendations'][] = '–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–º–∏–Ω–∏–º—É–º 3)';
    }

    return $analysis;
}

function generateProductBarcode($id) {
    return 'AQ' . str_pad($id, 8, '0', STR_PAD_LEFT);
}

function createMegaProduct($data, $files = null) {
    try {
        $result = createProduct($data, $files);

        if ($result['success']) {
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –º–µ–≥–∞–º–æ–¥–∞–ª–∫–∏
            $product = $result['product'];

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —à—Ç—Ä–∏—Ö–∫–æ–¥–∞
            $product['barcode'] = generateProductBarcode($product['id']);

            // SEO –∞–Ω–∞–ª–∏–∑
            if (empty($product['meta_title'])) {
                $seo = generateProductSEO($product['name'], $product['category'], $product['short_description']);
                $product = array_merge($product, $seo);
            }

            // –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            $product['image_analysis'] = analyzeProductImages($product['images']);

            logAdminAction('MEGA_PRODUCTS', '–°–æ–∑–¥–∞–Ω —Ç–æ–≤–∞—Ä —á–µ—Ä–µ–∑ –º–µ–≥–∞–º–æ–¥–∞–ª–∫—É: ' . $product['name'], $product);

            return ['success' => true, 'message' => '–¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏!', 'product' => $product];
        }

        return $result;
    } catch (Exception $e) {
        return ['success' => false, 'message' => '–û—à–∏–±–∫–∞: ' . $e->getMessage()];
    }
}

function duplicateProduct($id) {
    try {
        $product = getProductById($id);
        if (!$product) {
            return ['success' => false, 'message' => '–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω'];
        }

        // –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é
        $newProduct = $product;
        unset($newProduct['id']);
        $newProduct['name'] = $newProduct['name'] . ' (–∫–æ–ø–∏—è)';
        $newProduct['sku'] = $newProduct['sku'] . '-COPY';
        $newProduct['created_at'] = date('Y-m-d H:i:s');
        $newProduct['updated_at'] = date('Y-m-d H:i:s');

        return createProduct($newProduct);
    } catch (Exception $e) {
        return ['success' => false, 'message' => '–û—à–∏–±–∫–∞: ' . $e->getMessage()];
    }
}

function importProductsFromCSV($file) {
    try {
        if (!file_exists($file['tmp_name'])) {
            return ['success' => false, 'message' => '–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω'];
        }

        $handle = fopen($file['tmp_name'], 'r');
        if (!$handle) {
            return ['success' => false, 'message' => '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª'];
        }

        $imported = 0;
        $errors = [];
        $header = fgetcsv($handle); // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫

        while (($row = fgetcsv($handle)) !== false) {
            if (count($row) < 4) continue; // –ú–∏–Ω–∏–º—É–º: –Ω–∞–∑–≤–∞–Ω–∏–µ, –∫–∞—Ç–µ–≥–æ—Ä–∏—è, —Ü–µ–Ω–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ

            $productData = [
                'name' => trim($row[0]),
                'category_id' => (int)$row[1],
                'price' => (float)$row[2],
                'stock' => (int)$row[3],
                'description' => isset($row[4]) ? trim($row[4]) : '',
                'short_description' => isset($row[5]) ? trim($row[5]) : '',
                'is_active' => true
            ];

            $result = createProduct($productData);
            if ($result['success']) {
                $imported++;
            } else {
                $errors[] = '–°—Ç—Ä–æ–∫–∞ ' . ($imported + 1) . ': ' . $result['message'];
            }
        }

        fclose($handle);

        logAdminAction('IMPORT', "–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: $imported");

        return [
            'success' => true, 
            'message' => "–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: $imported" . (!empty($errors) ? '. –û—à–∏–±–∫–∏: ' . implode(', ', array_slice($errors, 0, 3)) : ''),
            'imported' => $imported,
            'errors' => $errors
        ];
    } catch (Exception $e) {
        return ['success' => false, 'message' => '–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' . $e->getMessage()];
    }
}

function exportProductsToCSV() {
    try {
        $products = getProducts();
        $filename = 'products_export_' . date('Y-m-d_H-i-s') . '.csv';
        $filepath = __DIR__ . '/' . $filename;

        $handle = fopen($filepath, 'w');

        // UTF-8 BOM –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Excel
        fwrite($handle, "\xEF\xBB\xBF");

        // –ó–∞–≥–æ–ª–æ–≤–∫–∏
        fputcsv($handle, [
            'ID', '–ù–∞–∑–≤–∞–Ω–∏–µ', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è ID', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è', '–¶–µ–Ω–∞', '–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
            '–ê—Ä—Ç–∏–∫—É–ª', '–û–ø–∏—Å–∞–Ω–∏–µ', '–ê–∫—Ç–∏–≤–µ–Ω', '–ü–æ–ø—É–ª—è—Ä–Ω—ã–π', '–ù–æ–≤–∏–Ω–∫–∞', '–°–æ–∑–¥–∞–Ω'
        ]);

        // –î–∞–Ω–Ω—ã–µ
        foreach ($products as $product) {
            fputcsv($handle, [
                $product['id'],
                $product['name'],
                $product['category_id'],
                $product['category'],
                $product['price'],
                $product['old_price'] ?? '',
                $product['stock'],
                $product['sku'],
                $product['short_description'],
                $product['is_active'] ? '–î–∞' : '–ù–µ—Ç',
                $product['is_featured'] ? '–î–∞' : '–ù–µ—Ç',
                $product['is_new'] ? '–î–∞' : '–ù–µ—Ç',
                $product['created_at']
            ]);
        }

        fclose($handle);

        return [
            'success' => true,
            'message' => '–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ',
            'file' => $filename,
            'path' => $filepath
        ];
    } catch (Exception $e) {
        return ['success' => false, 'message' => '–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' . $e->getMessage()];
    }
}

// === –°–£–ü–ï–† –ú–ï–ì–ê –ê–ù–ê–õ–ò–¢–ò–ö–ê ===
function getSuperAnalyticsData() {
    $products = getProducts();
    $orders = getOrders();
    $reviews = getReviews();
    $categories = getCategories();

    // –ü—Ä–æ–¥–∞–∂–∏ –ø–æ –¥–Ω—è–º –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
    $salesByDay = [];
    for ($i = 29; $i >= 0; $i--) {
        $date = date('Y-m-d', strtotime("-$i days"));
        $dayOrders = array_filter($orders, fn($o) => date('Y-m-d', strtotime($o['created_at'])) === $date);
        $salesByDay[] = [
            'date' => $date,
            'date_formatted' => date('d.m', strtotime($date)),
            'orders' => count($dayOrders),
            'revenue' => array_sum(array_column($dayOrders, 'total_amount')),
            'avg_order' => count($dayOrders) > 0 ? array_sum(array_column($dayOrders, 'total_amount')) / count($dayOrders) : 0
        ];
    }

    // –ü—Ä–æ–¥–∞–∂–∏ –ø–æ —á–∞—Å–∞–º (–∑–∞ —Å–µ–≥–æ–¥–Ω—è)
    $hourlyData = [];
    for ($hour = 0; $hour < 24; $hour++) {
        $hourlyData[] = [
            'hour' => str_pad($hour, 2, '0', STR_PAD_LEFT) . ':00',
            'orders' => rand(0, 15),
            'revenue' => rand(0, 25000)
        ];
    }

    // –¢–æ–ø —Ç–æ–≤–∞—Ä—ã
    $topProducts = $products;
    usort($topProducts, fn($a, $b) => $b['sales'] - $a['sales']);
    $topProducts = array_slice($topProducts, 0, 10);

    // –ê–Ω–∞–ª–∏–∑ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    $categoryAnalytics = [];
    foreach ($categories as $category) {
        $categoryProducts = array_filter($products, fn($p) => $p['category_id'] == $category['id']);
        $totalSales = array_sum(array_column($categoryProducts, 'sales'));
        $avgPrice = count($categoryProducts) > 0 ? array_sum(array_column($categoryProducts, 'price')) / count($categoryProducts) : 0;

        $categoryAnalytics[] = [
            'id' => $category['id'],
            'name' => $category['name'],
            'icon' => $category['icon'],
            'products_count' => count($categoryProducts),
            'total_sales' => $totalSales,
            'avg_price' => $avgPrice,
            'revenue' => $totalSales * $avgPrice,
            'percentage' => 0 // –ë—É–¥–µ—Ç –≤—ã—á–∏—Å–ª–µ–Ω –ø–æ–∑–∂–µ
        ];
    }

    // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    $totalRevenue = array_sum(array_column($categoryAnalytics, 'revenue'));
    foreach ($categoryAnalytics as &$category) {
        $category['percentage'] = $totalRevenue > 0 ? round(($category['revenue'] / $totalRevenue) * 100, 1) : 0;
    }

    // –ì–µ–æ–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ (–∏–º–∏—Ç–∞—Ü–∏—è)
    $geoData = [
        ['region' => '–ú–æ—Å–∫–≤–∞', 'orders' => rand(100, 300), 'revenue' => rand(50000, 150000)],
        ['region' => '–°–ü–±', 'orders' => rand(80, 200), 'revenue' => rand(40000, 100000)],
        ['region' => '–ö–∞–∑–∞–Ω—å', 'orders' => rand(50, 120), 'revenue' => rand(25000, 60000)],
        ['region' => '–ú–∏–Ω—Å–∫', 'orders' => rand(30, 80), 'revenue' => rand(15000, 40000)],
        ['region' => '–ê–ª–º–∞—Ç—ã', 'orders' => rand(20, 60), 'revenue' => rand(10000, 30000)]
    ];

    // –ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤–æ—Ä–æ–Ω–∫–∏ –ø—Ä–æ–¥–∞–∂
    $funnelData = [
        ['stage' => '–ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏', 'count' => 10000, 'percentage' => 100],
        ['stage' => '–ü—Ä–æ—Å–º–æ—Ç—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤', 'count' => 3500, 'percentage' => 35],
        ['stage' => '–î–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É', 'count' => 1200, 'percentage' => 12],
        ['stage' => '–ù–∞—á–∞–ª–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è', 'count' => 800, 'percentage' => 8],
        ['stage' => '–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã', 'count' => 450, 'percentage' => 4.5]
    ];

    return [
        'sales_by_day' => $salesByDay,
        'hourly_data' => $hourlyData,
        'top_products' => $topProducts,
        'category_analytics' => $categoryAnalytics,
        'geo_data' => $geoData,
        'funnel_data' => $funnelData,
        'totals' => [
            'total_orders' => count($orders),
            'total_revenue' => array_sum(array_column($orders, 'total_amount')),
            'avg_order_value' => count($orders) > 0 ? array_sum(array_column($orders, 'total_amount')) / count($orders) : 0,
            'total_products' => count($products),
            'conversion_rate' => 4.5
        ]
    ];
}

// === –û–ë–†–ê–ë–û–¢–ö–ê AJAX –ó–ê–ü–†–û–°–û–í ===
if (isset($_POST['ajax']) || isset($_GET['ajax'])) {
    header('Content-Type: application/json');

    try {
        switch ($action) {
            case 'get_stats':
                $stats = getDashboardStats();
                echo json_encode(['success' => true, 'stats' => $stats]);
                break;

            case 'get_product':
                $productId = (int)($_GET['id'] ?? 0);
                $product = getProductById($productId);
                if ($product) {
                    echo json_encode(['success' => true, 'product' => $product]);
                } else {
                    echo json_encode(['success' => false, 'message' => '–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω']);
                }
                break;

            case 'get_super_analytics':
                $analytics = getSuperAnalyticsData();
                echo json_encode(['success' => true, 'analytics' => $analytics]);
                break;

            case 'toggle_product_status':
                $productId = (int)$_POST['product_id'];
                $isActive = $_POST['is_active'] === '1';
                $result = toggleProductStatus($productId, $isActive);
                echo json_encode($result);
                break;

            case 'delete_product':
                $productId = (int)$_POST['product_id'];
                $result = deleteProduct($productId);
                echo json_encode($result);
                break;

            case 'duplicate_product':
                $productId = (int)$_POST['product_id'];
                $result = duplicateProduct($productId);
                echo json_encode($result);
                break;

            case 'bulk_products':
                $ids = array_map('intval', explode(',', $_POST['product_ids']));
                $bulkAction = $_POST['bulk_action'];
                $data = $_POST['bulk_data'] ?? [];
                $result = bulkUpdateProducts($ids, $bulkAction, $data);
                echo json_encode($result);
                break;

            case 'approve_review':
                $reviewId = (int)$_POST['review_id'];
                $result = approveReview($reviewId);
                echo json_encode($result);
                break;

            case 'delete_review':
                $reviewId = (int)$_POST['review_id'];
                $result = deleteReview($reviewId);
                echo json_encode($result);
                break;

            case 'update_order_status':
                $orderId = (int)$_POST['order_id'];
                $status = $_POST['status'];
                $result = updateOrderStatus($orderId, $status);
                echo json_encode($result);
                break;

            case 'save_settings':
                $settingsData = $_POST;
                $result = updateSiteSettings($settingsData);
                echo json_encode($result);
                break;

            case 'export_products':
                $result = exportProductsToCSV();
                echo json_encode($result);
                break;

            case 'generate_seo':
                $name = $_POST['name'] ?? '';
                $category = $_POST['category'] ?? '';
                $description = $_POST['description'] ?? '';
                $seo = generateProductSEO($name, $category, $description);
                echo json_encode(['success' => true, 'seo' => $seo]);
                break;

            default:
                echo json_encode(['success' => false, 'message' => '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ']);
        }
    } catch (Exception $e) {
        echo json_encode(['success' => false, 'message' => '–û—à–∏–±–∫–∞: ' . $e->getMessage()]);
    }
    exit;
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ã—á–Ω—ã—Ö POST –∑–∞–ø—Ä–æ—Å–æ–≤
if ($action && !isset($_POST['ajax'])) {
    switch ($action) {
        case 'save_settings':
            $result = updateSiteSettings($_POST);
            $_SESSION['admin_message'] = [
                'text' => $result['message'],
                'type' => $result['success'] ? 'success' : 'error'
            ];
            header('Location: admin.php?section=settings');
            exit;

        case 'create_product':
            $result = createMegaProduct($_POST, $_FILES ?? []);
            $_SESSION['admin_message'] = [
                'text' => $result['message'],
                'type' => $result['success'] ? 'success' : 'error'
            ];
            header('Location: admin.php?section=products');
            exit;

        case 'update_product':
            $productId = (int)$_POST['product_id'];
            $result = updateProduct($productId, $_POST, $_FILES ?? []);
            $_SESSION['admin_message'] = [
                'text' => $result['message'],
                'type' => $result['success'] ? 'success' : 'error'
            ];
            header('Location: admin.php?section=products');
            exit;

        case 'import_products':
            if (isset($_FILES['csv_file'])) {
                $result = importProductsFromCSV($_FILES['csv_file']);
                $_SESSION['admin_message'] = [
                    'text' => $result['message'],
                    'type' => $result['success'] ? 'success' : 'error'
                ];
            } else {
                $_SESSION['admin_message'] = [
                    'text' => '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω',
                    'type' => 'error'
                ];
            }
            header('Location: admin.php?section=products');
            exit;

        case 'create_category':
            $result = createCategory($_POST);
            $_SESSION['admin_message'] = [
                'text' => $result['message'],
                'type' => $result['success'] ? 'success' : 'error'
            ];
            header('Location: admin.php?section=categories');
            exit;

        case 'create_news':
            $result = createNews($_POST);
            $_SESSION['admin_message'] = [
                'text' => $result['message'],
                'type' => $result['success'] ? 'success' : 'error'
            ];
            header('Location: admin.php?section=news');
            exit;

        case 'create_page':
            $result = createStaticPage($_POST);
            $_SESSION['admin_message'] = [
                'text' => $result['message'],
                'type' => $result['success'] ? 'success' : 'error'
            ];
            header('Location: admin.php?section=pages');
            exit;
    }
}

// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
$adminData = getAdminData($section);

?><!DOCTYPE html>
<html lang='ru'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title><?= $adminData['title'] ?? '–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å' ?> - –ê–∫–≤–∞–°–±–æ—Ä MEGA CRM v7.1</title>

    <link href='https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap' rel='stylesheet'>
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css'>
    <link rel='icon' href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üê†</text></svg>'>

    <style>
        :root {
            --primary-color: #667eea;
            --primary-dark: #5a6fd8;
            --secondary-color: #764ba2;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --text-muted: #95a5a6;
            --border-color: #dee2e6;
            --border-radius: 8px;
            --border-radius-lg: 12px;
            --border-radius-xl: 20px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 25px rgba(0,0,0,0.15);
            --shadow-xl: 0 12px 40px rgba(0,0,0,0.2);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.15s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .admin-layout {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        /* ===== –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ ===== */
        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 1000;
            transition: var(--transition);
            box-shadow: var(--shadow-xl);
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.3);
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05);
        }

        .admin-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            font-size: 36px;
            animation: logoFloat 3s ease-in-out infinite;
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.2));
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-3px) scale(1.05); }
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .logo-title {
            font-size: 22px;
            font-weight: 700;
            line-height: 1.2;
        }

        .logo-subtitle {
            font-size: 12px;
            opacity: 0.8;
            font-weight: 400;
        }

        .sidebar-nav {
            padding: 24px 0 120px 0;
        }

        .nav-section {
            margin-bottom: 32px;
        }

        .nav-title {
            padding: 0 20px 12px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            opacity: 0.7;
            font-weight: 600;
            color: rgba(255,255,255,0.8);
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            color: rgba(255,255,255,0.85);
            text-decoration: none;
            transition: var(--transition);
            position: relative;
            border-left: 3px solid transparent;
        }

        .sidebar-link:hover {
            background: rgba(255,255,255,0.1);
            color: white;
            padding-left: 28px;
            border-left-color: rgba(255,255,255,0.3);
        }

        .sidebar-link.active {
            background: rgba(255,255,255,0.15);
            color: white;
            border-left-color: white;
            font-weight: 600;
        }

        .sidebar-link.active::before {
            content: '';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
        }

        .sidebar-link i {
            width: 20px;
            margin-right: 12px;
            text-align: center;
            font-size: 16px;
        }

        .sidebar-link-text {
            font-size: 14px;
            font-weight: 500;
        }

        .sidebar-badge {
            margin-left: auto;
            padding: 3px 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        .sidebar-badge.badge-warning {
            background: var(--warning-color);
        }

        .sidebar-badge.badge-success {
            background: var(--success-color);
        }

        .sidebar-badge.badge-danger {
            background: var(--danger-color);
        }

        .sidebar-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.1);
        }

        .admin-profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .admin-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .admin-info {
            flex: 1;
            min-width: 0;
        }

        .admin-name {
            font-weight: 600;
            font-size: 14px;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .admin-role {
            font-size: 11px;
            opacity: 0.7;
            line-height: 1.2;
        }

        .logout-btn {
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            padding: 10px;
            border-radius: var(--border-radius);
            transition: var(--transition);
            font-size: 16px;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.1);
            color: white;
            transform: scale(1.1);
        }

        /* ===== –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ ===== */
        .main-content {
            flex: 1;
            margin-left: 280px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .top-bar {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 20px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 500;
            box-shadow: var(--shadow-sm);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title i {
            color: var(--primary-color);
        }

        .top-bar-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            line-height: 1.4;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #27ae60);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color), #2980b9);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-lg {
            padding: 14px 28px;
            font-size: 16px;
        }

        /* ===== –ö–û–ù–¢–ï–ù–¢ –°–¢–†–ê–ù–ò–¶ ===== */
        .page-content {
            flex: 1;
            padding: 32px;
            max-width: 100%;
        }

        /* ===== –ú–ï–ì–ê –ú–û–î–ê–õ–ö–ê ===== */
        .mega-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }

        .mega-modal.show {
            display: flex;
            animation: megaModalFadeIn 0.4s ease;
        }

        @keyframes megaModalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .mega-modal-dialog {
            background: var(--bg-primary);
            border-radius: var(--border-radius-xl);
            max-width: 95vw;
            width: 1200px;
            max-height: 95vh;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            animation: megaModalSlideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            flex-direction: column;
        }

        @keyframes megaModalSlideUp {
            from { transform: translateY(50px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        .mega-modal-header {
            padding: 24px 32px;
            border-bottom: 2px solid var(--border-color);
            background: linear-gradient(135deg, #f8f9ff, #fff);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .mega-modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .mega-modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-muted);
            padding: 12px;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .mega-modal-close:hover {
            background: var(--danger-color);
            color: white;
            transform: rotate(90deg);
        }

        .mega-modal-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .mega-modal-tabs {
            width: 250px;
            background: var(--bg-secondary);
            border-right: 2px solid var(--border-color);
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        .mega-tab-button {
            padding: 20px 24px;
            border: none;
            background: transparent;
            text-align: left;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .mega-tab-button:hover {
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary-color);
            padding-left: 32px;
        }

        .mega-tab-button.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            font-weight: 600;
            box-shadow: inset 4px 0 0 rgba(255,255,255,0.3);
        }

        .mega-tab-content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }

        .mega-tab-panel {
            display: none;
        }

        .mega-tab-panel.active {
            display: block;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== DRAG & DROP –ó–û–ù–ê ===== */
        .drag-drop-zone {
            border: 3px dashed var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 60px 20px;
            text-align: center;
            background: var(--bg-secondary);
            transition: var(--transition);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .drag-drop-zone:hover,
        .drag-drop-zone.drag-over {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
            transform: scale(1.02);
        }

        .drag-drop-icon {
            font-size: 4em;
            color: var(--primary-color);
            margin-bottom: 20px;
            display: block;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .drag-drop-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .drag-drop-hint {
            color: var(--text-muted);
            font-size: 14px;
        }

        .file-input-hidden {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* ===== –ì–ê–õ–ï–†–ï–Ø –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô ===== */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }

        .image-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            background: var(--bg-secondary);
            transition: var(--transition);
        }

        .image-item:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-item-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: var(--transition);
        }

        .image-item:hover .image-item-overlay {
            opacity: 1;
        }

        .image-item-actions {
            display: flex;
            gap: 8px;
        }

        .image-action-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 16px;
        }

        .image-action-btn.primary {
            background: var(--primary-color);
            color: white;
        }

        .image-action-btn.danger {
            background: var(--danger-color);
            color: white;
        }

        .image-action-btn:hover {
            transform: scale(1.1);
        }

        /* ===== –§–û–†–ú–´ ===== */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: var(--transition);
            font-family: inherit;
            background: var(--bg-primary);
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .form-textarea {
            resize: vertical;
            min-height: 120px;
            line-height: 1.6;
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .form-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin: 0;
        }

        /* ===== AI –ü–û–ú–û–©–ù–ò–ö ===== */
        .ai-assistant {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius-lg);
            margin-bottom: 24px;
        }

        .ai-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .ai-suggestions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .ai-suggestion {
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .ai-suggestion:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        /* ===== –°–¢–ê–¢–ò–°–¢–ò–ß–ï–°–ö–ò–ï –ö–ê–†–¢–û–ß–ö–ò ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--bg-primary);
            padding: 28px;
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card.stat-success::before {
            background: linear-gradient(90deg, var(--success-color), #27ae60);
        }

        .stat-card.stat-warning::before {
            background: linear-gradient(90deg, var(--warning-color), #e67e22);
        }

        .stat-card.stat-danger::before {
            background: linear-gradient(90deg, var(--danger-color), #c0392b);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: var(--border-radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: var(--shadow-sm);
        }

        .stat-icon.stat-success {
            background: linear-gradient(135deg, var(--success-color), #27ae60);
        }

        .stat-icon.stat-warning {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
        }

        .stat-icon.stat-danger {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1;
        }

        .stat-label {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-weight: 500;
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: var(--border-radius);
        }

        .stat-change.positive {
            background: rgba(46, 204, 113, 0.1);
            color: var(--success-color);
        }

        .stat-change.negative {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        .stat-change.neutral {
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }

        /* ===== –ö–ê–†–¢–û–ß–ö–ò –ö–û–ù–¢–ï–ù–¢–ê ===== */
        .content-card {
            background: var(--bg-primary);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            margin-bottom: 32px;
            transition: var(--transition);
        }

        .content-card:hover {
            box-shadow: var(--shadow-lg);
        }

        .content-card-header {
            padding: 24px 28px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #f8f9ff, #fff);
        }

        .content-card-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .content-card-body {
            padding: 28px;
        }

        /* ===== –¢–ê–ë–õ–ò–¶–´ ===== */
        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .table th {
            background: linear-gradient(135deg, #f8f9ff, var(--bg-secondary));
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .table tr {
            transition: var(--transition-fast);
        }

        .table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        /* ===== –°–¢–ê–¢–£–° –ë–ï–ô–î–ñ–ò ===== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            line-height: 1;
        }

        .status-active {
            background: rgba(46, 204, 113, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(46, 204, 113, 0.2);
        }

        .status-inactive {
            background: rgba(149, 165, 166, 0.1);
            color: var(--text-muted);
            border: 1px solid rgba(149, 165, 166, 0.2);
        }

        .status-new {
            background: rgba(52, 152, 219, 0.1);
            color: var(--info-color);
            border: 1px solid rgba(52, 152, 219, 0.2);
        }

        .status-processing {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning-color);
            border: 1px solid rgba(243, 156, 18, 0.2);
        }

        .status-completed {
            background: rgba(46, 204, 113, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(46, 204, 113, 0.2);
        }

        .status-cancelled {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(231, 76, 60, 0.2);
        }

        /* ===== –°–£–ü–ï–† –ì–†–ê–§–ò–ö–ò ===== */
        .analytics-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 32px;
            margin-bottom: 40px;
        }

        .analytics-card {
            background: var(--bg-primary);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-lg);
            padding: 0;
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .analytics-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .analytics-card-header {
            padding: 24px 28px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .analytics-card-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .analytics-card-body {
            padding: 28px;
            position: relative;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        .chart-big {
            height: 400px;
        }

        .chart-small {
            height: 200px;
        }

        /* ===== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ===== */
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 16px 20px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            z-index: 9999;
            animation: notificationSlideIn 0.3s ease;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .notification-success {
            background: linear-gradient(135deg, var(--success-color), #27ae60);
            color: white;
        }

        .notification-error {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
            color: white;
        }

        .notification-warning {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: white;
        }

        .notification-info {
            background: linear-gradient(135deg, var(--info-color), #2980b9);
            color: white;
        }

        @keyframes notificationSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ===== –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ ===== */
        @media (max-width: 1400px) {
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 1200px) {
            .mega-modal-dialog {
                width: 95vw;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .mega-modal-body {
                flex-direction: column;
            }

            .mega-modal-tabs {
                width: 100%;
                display: flex;
                flex-direction: row;
                overflow-x: auto;
                border-right: none;
                border-bottom: 2px solid var(--border-color);
            }

            .mega-tab-button {
                white-space: nowrap;
                border-bottom: none;
                border-right: 1px solid var(--border-color);
            }

            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ===== –ê–ù–ò–ú–ê–¶–ò–ò ===== */
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== –õ–û–ê–î–ï–† ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            backdrop-filter: blur(5px);
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            border: 4px solid var(--bg-tertiary);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class='<?= $section ?>-page'>
    <div class='admin-layout'>
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <aside class='sidebar' id='sidebar'>
            <div class='sidebar-header'>
                <div class='admin-logo'>
                    <div class='logo-icon'>üê†</div>
                    <div class='logo-text'>
                        <div class='logo-title'>–ê–∫–≤–∞–°–±–æ—Ä</div>
                        <div class='logo-subtitle'>MEGA CRM v7.1</div>
                    </div>
                </div>
            </div>

            <nav class='sidebar-nav'>
                <div class='nav-section'>
                    <div class='nav-title'>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ & KPI</div>
                    <a href='admin.php?section=dashboard' class='sidebar-link <?= $section === 'dashboard' ? 'active' : '' ?>'>
                        <i class='fas fa-chart-pie'></i>
                        <span class='sidebar-link-text'>KPI –î–∞—à–±–æ—Ä–¥</span>
                    </a>
                    <a href='admin.php?section=analytics' class='sidebar-link <?= $section === 'analytics' ? 'active' : '' ?>'>
                        <i class='fas fa-chart-line'></i>
                        <span class='sidebar-link-text'>–°–£–ü–ï–† –ì—Ä–∞—Ñ–∏–∫–∏</span>
                        <span class='sidebar-badge badge-success'>MEGA</span>
                    </a>
                </div>

                <div class='nav-section'>
                    <div class='nav-title'>üõí –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω</div>
                    <a href='admin.php?section=products' class='sidebar-link <?= $section === 'products' ? 'active' : '' ?>'>
                        <i class='fas fa-fish'></i>
                        <span class='sidebar-link-text'>–¢–æ–≤–∞—Ä—ã MEGA</span>
                        <span class='sidebar-badge'><?= count(getProducts()) ?></span>
                    </a>
                    <a href='admin.php?section=categories' class='sidebar-link <?= $section === 'categories' ? 'active' : '' ?>'>
                        <i class='fas fa-tags'></i>
                        <span class='sidebar-link-text'>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
                        <span class='sidebar-badge'><?= count(getCategories()) ?></span>
                    </a>
                    <a href='admin.php?section=orders' class='sidebar-link <?= $section === 'orders' ? 'active' : '' ?>'>
                        <i class='fas fa-shopping-bag'></i>
                        <span class='sidebar-link-text'>–ó–∞–∫–∞–∑—ã</span>
                        <span class='sidebar-badge badge-warning'><?= count(array_filter(getOrders(), fn($o) => $o['status'] === 'new')) ?></span>
                    </a>
                    <a href='admin.php?section=reviews' class='sidebar-link <?= $section === 'reviews' ? 'active' : '' ?>'>
                        <i class='fas fa-star'></i>
                        <span class='sidebar-link-text'>–û—Ç–∑—ã–≤—ã</span>
                        <span class='sidebar-badge badge-danger'><?= count(array_filter(getReviews(), fn($r) => !$r['is_approved'])) ?></span>
                    </a>
                </div>

                <div class='nav-section'>
                    <div class='nav-title'>üìù –ö–æ–Ω—Ç–µ–Ω—Ç & SEO</div>
                    <a href='admin.php?section=news' class='sidebar-link <?= $section === 'news' ? 'active' : '' ?>'>
                        <i class='fas fa-newspaper'></i>
                        <span class='sidebar-link-text'>–ù–æ–≤–æ—Å—Ç–∏</span>
                        <span class='sidebar-badge'><?= count(getNews()) ?></span>
                    </a>
                    <a href='admin.php?section=pages' class='sidebar-link <?= $section === 'pages' ? 'active' : '' ?>'>
                        <i class='fas fa-file-alt'></i>
                        <span class='sidebar-link-text'>–°—Ç—Ä–∞–Ω–∏—Ü—ã</span>
                    </a>
                </div>

                <div class='nav-section'>
                    <div class='nav-title'>‚öôÔ∏è –°–∏—Å—Ç–µ–º–∞ & –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                    <a href='admin.php?section=settings' class='sidebar-link <?= $section === 'settings' ? 'active' : '' ?>'>
                        <i class='fas fa-cog'></i>
                        <span class='sidebar-link-text'>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                        <span class='sidebar-badge badge-success'>PRO</span>
                    </a>
                    <a href='admin.php?section=logs' class='sidebar-link <?= $section === 'logs' ? 'active' : '' ?>'>
                        <i class='fas fa-list-alt'></i>
                        <span class='sidebar-link-text'>–õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã</span>
                    </a>
                </div>
            </nav>

            <div class='sidebar-footer'>
                <div class='admin-profile'>
                    <div class='admin-avatar'>üë§</div>
                    <div class='admin-info'>
                        <div class='admin-name'><?= $_SESSION['admin_name'] ?></div>
                        <div class='admin-role'><?= $_SESSION['admin_role'] ?></div>
                    </div>
                    <a href='admin.php?action=logout' class='logout-btn' title='–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã'>
                        <i class='fas fa-sign-out-alt'></i>
                    </a>
                </div>
            </div>
        </aside>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <main class='main-content'>
            <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
            <header class='top-bar'>
                <div class='top-bar-left'>
                    <h1 class='page-title'>
                        <i class='<?= getPageIcon($section) ?>'></i>
                        <?= $adminData['title'] ?? '–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å' ?>
                    </h1>
                </div>

                <div class='top-bar-right'>
                    <button class='btn btn-outline' onclick='toggleSidebar()' title='–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –º–µ–Ω—é'>
                        <i class='fas fa-bars'></i>
                    </button>
                    <a href='index.php' class='btn btn-primary' target='_blank'>
                        <i class='fas fa-external-link-alt'></i>
                        –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç
                    </a>
                </div>
            </header>

            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
            <div class='page-content'>
                <?php if (isset($_SESSION['admin_message'])): ?>
                    <div class='notification notification-<?= $_SESSION['admin_message']['type'] ?>' id='adminNotification'>
                        <i class='fas fa-<?= $_SESSION['admin_message']['type'] === 'success' ? 'check-circle' : 'exclamation-circle' ?>'></i>
                        <?= htmlspecialchars($_SESSION['admin_message']['text']) ?>
                    </div>
                    <?php unset($_SESSION['admin_message']); ?>
                <?php endif; ?>

                <?php renderAdminSection($section, $adminData); ?>
            </div>
        </main>
    </div>

    <!-- –ú–ï–ì–ê –ú–û–î–ê–õ–ö–ê –¢–û–í–ê–†–û–í -->
    <div class='mega-modal' id='megaProductModal'>
        <div class='mega-modal-dialog'>
            <div class='mega-modal-header'>
                <h3 class='mega-modal-title'>
                    <i class='fas fa-fish'></i>
                    <span id='modalTitle'>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä</span>
                </h3>
                <button type='button' class='mega-modal-close' onclick='closeMegaModal()'>&times;</button>
            </div>

            <form method='post' enctype='multipart/form-data' id='megaProductForm'>
                <input type='hidden' name='action' value='create_product' id='formAction'>
                <input type='hidden' name='product_id' id='productId'>

                <div class='mega-modal-body'>
                    <!-- –í–∫–ª–∞–¥–∫–∏ -->
                    <div class='mega-modal-tabs'>
                        <button type='button' class='mega-tab-button active' data-tab='basic'>
                            <i class='fas fa-info-circle'></i>
                            –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                        </button>
                        <button type='button' class='mega-tab-button' data-tab='media'>
                            <i class='fas fa-images'></i>
                            –ú–µ–¥–∏–∞ —Ñ–∞–π–ª—ã
                        </button>
                        <button type='button' class='mega-tab-button' data-tab='seo'>
                            <i class='fas fa-search'></i>
                            SEO –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
                        </button>
                        <button type='button' class='mega-tab-button' data-tab='inventory'>
                            <i class='fas fa-warehouse'></i>
                            –°–∫–ª–∞–¥ –∏ —Ü–µ–Ω—ã
                        </button>
                        <button type='button' class='mega-tab-button' data-tab='advanced'>
                            <i class='fas fa-cogs'></i>
                            –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ
                        </button>
                    </div>

                    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ -->
                    <div class='mega-tab-content'>
                        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                        <div class='mega-tab-panel active' data-panel='basic'>
                            <div class='ai-assistant'>
                                <div class='ai-title'>
                                    <i class='fas fa-robot'></i>
                                    AI –ü–æ–º–æ—â–Ω–∏–∫
                                </div>
                                <div class='ai-suggestions'>
                                    <span class='ai-suggestion' onclick='generateProductName()'>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ</span>
                                    <span class='ai-suggestion' onclick='generateDescription()'>–°–æ–∑–¥–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ</span>
                                    <span class='ai-suggestion' onclick='suggestCategory()'>–ü–æ–¥–æ–±—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</span>
                                </div>
                            </div>

                            <div class='form-row'>
                                <div class='form-group'>
                                    <label class='form-label'>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ *</label>
                                    <input type='text' name='name' class='form-input' required placeholder='–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞'>
                                </div>
                                <div class='form-group'>
                                    <label class='form-label'>–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                                    <select name='category_id' class='form-select' required>
                                        <option value=''>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                                        <?php foreach (getCategories() as $category): ?>
                                            <option value='<?= $category['id'] ?>'><?= $category['icon'] ?> <?= htmlspecialchars($category['name']) ?></option>
                                        <?php endforeach; ?>
                                    </select>
                                </div>
                            </div>

                            <div class='form-group'>
                                <label class='form-label'>–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
                                <textarea name='short_description' class='form-textarea' rows='2' placeholder='–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞'></textarea>
                            </div>

                            <div class='form-group'>
                                <label class='form-label'>–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
                                <textarea name='description' class='form-textarea' rows='6' placeholder='–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞'></textarea>
                            </div>

                            <div class='form-row'>
                                <div class='form-checkbox'>
                                    <input type='checkbox' name='is_featured' id='isFeatured'>
                                    <label for='isFeatured'>üî• –ü–æ–ø—É–ª—è—Ä–Ω—ã–π —Ç–æ–≤–∞—Ä</label>
                                </div>
                                <div class='form-checkbox'>
                                    <input type='checkbox' name='is_new' id='isNew'>
                                    <label for='isNew'>‚ú® –ù–æ–≤–∏–Ω–∫–∞</label>
                                </div>
                            </div>
                        </div>

                        <!-- –ú–µ–¥–∏–∞ —Ñ–∞–π–ª—ã -->
                        <div class='mega-tab-panel' data-panel='media'>
                            <div class='drag-drop-zone' onclick='document.getElementById("imageFiles").click()'>
                                <input type='file' id='imageFiles' name='images[]' multiple accept='image/*' class='file-input-hidden'>
                                <div class='drag-drop-icon'>üì∏</div>
                                <div class='drag-drop-text'>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—é–¥–∞</div>
                                <div class='drag-drop-hint'>–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤ (JPG, PNG, WebP, –¥–æ 10MB)</div>
                            </div>

                            <div class='image-gallery' id='imageGallery'>
                                <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </div>
                        </div>

                        <!-- SEO –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è -->
                        <div class='mega-tab-panel' data-panel='seo'>
                            <div class='ai-assistant'>
                                <div class='ai-title'>
                                    <i class='fas fa-magic'></i>
                                    SEO –ú–∞—Å—Ç–µ—Ä
                                </div>
                                <div class='ai-suggestions'>
                                    <span class='ai-suggestion' onclick='generateSEO()'>–ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è SEO</span>
                                    <span class='ai-suggestion' onclick='analyzeSEO()'>–ê–Ω–∞–ª–∏–∑ SEO</span>
                                    <span class='ai-suggestion' onclick='checkKeywords()'>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞</span>
                                </div>
                            </div>

                            <div class='form-group'>
                                <label class='form-label'>SEO –∑–∞–≥–æ–ª–æ–≤–æ–∫ (Title)</label>
                                <input type='text' name='meta_title' class='form-input' placeholder='–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –ø–æ–∏—Å–∫–æ–≤–∏–∫–æ–≤'>
                                <small style='color: var(--text-muted);'>–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 50-60 —Å–∏–º–≤–æ–ª–æ–≤</small>
                            </div>

                            <div class='form-group'>
                                <label class='form-label'>SEO –æ–ø–∏—Å–∞–Ω–∏–µ (Description)</label>
                                <textarea name='meta_description' class='form-textarea' rows='3' placeholder='–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –ø–æ–∏—Å–∫–æ–≤–∏–∫–æ–≤'></textarea>
                                <small style='color: var(--text-muted);'>–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 150-160 —Å–∏–º–≤–æ–ª–æ–≤</small>
                            </div>

                            <div class='form-group'>
                                <label class='form-label'>–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞</label>
                                <input type='text' name='meta_keywords' class='form-input' placeholder='–∫–ª—é—á–µ–≤—ã–µ, —Å–ª–æ–≤–∞, —á–µ—Ä–µ–∑, –∑–∞–ø—è—Ç—É—é'>
                            </div>

                            <div class='form-group'>
                                <label class='form-label'>URL —Ç–æ–≤–∞—Ä–∞ (slug)</label>
                                <input type='text' name='slug' class='form-input' placeholder='url-tovara-na-sajte'>
                                <small style='color: var(--text-muted);'>–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</small>
                            </div>
                        </div>

                        <!-- –°–∫–ª–∞–¥ –∏ —Ü–µ–Ω—ã -->
                        <div class='mega-tab-panel' data-panel='inventory'>
                            <div class='form-row'>
                                <div class='form-group'>
                                    <label class='form-label'>–¶–µ–Ω–∞ (‚ÇΩ) *</label>
                                    <input type='number' name='price' class='form-input' min='0' step='0.01' required placeholder='0.00'>
                                </div>
                                <div class='form-group'>
                                    <label class='form-label'>–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞ (‚ÇΩ)</label>
                                    <input type='number' name='old_price' class='form-input' min='0' step='0.01' placeholder='0.00'>
                                    <small style='color: var(--text-muted);'>–î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏</small>
                                </div>
                            </div>

                            <div class='form-row'>
                                <div class='form-group'>
                                    <label class='form-label'>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ *</label>
                                    <input type='number' name='stock' class='form-input' min='0' value='1' required>
                                </div>
                                <div class='form-group'>
                                    <label class='form-label'>–ê—Ä—Ç–∏–∫—É–ª (SKU)</label>
                                    <input type='text' name='sku' class='form-input' placeholder='AQ-0001'>
                                    <small style='color: var(--text-muted);'>–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</small>
                                </div>
                            </div>

                            <div class='form-row'>
                                <div class='form-group'>
                                    <label class='form-label'>–í–µ—Å (–≥—Ä–∞–º–º—ã)</label>
                                    <input type='number' name='weight' class='form-input' min='0' value='100'>
                                </div>
                                <div class='form-group'>
                                    <label class='form-label'>–®—Ç—Ä–∏—Ö–∫–æ–¥</label>
                                    <input type='text' name='barcode' class='form-input' placeholder='–ë—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏' readonly>
                                </div>
                            </div>

                            <div class='form-group'>
                                <label class='form-label'>–†–∞–∑–º–µ—Ä—ã (—Å–º)</label>
                                <div class='form-row-3'>
                                    <input type='number' name='length' class='form-input' placeholder='–î–ª–∏–Ω–∞' min='0'>
                                    <input type='number' name='width' class='form-input' placeholder='–®–∏—Ä–∏–Ω–∞' min='0'>
                                    <input type='number' name='height' class='form-input' placeholder='–í—ã—Å–æ—Ç–∞' min='0'>
                                </div>
                            </div>
                        </div>

                        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ -->
                        <div class='mega-tab-panel' data-panel='advanced'>
                            <div class='form-row'>
                                <div class='form-checkbox'>
                                    <input type='checkbox' name='is_active' id='isActive' checked>
                                    <label for='isActive'>üëÅÔ∏è –¢–æ–≤–∞—Ä –∞–∫—Ç–∏–≤–µ–Ω (–≤–∏–¥–µ–Ω –Ω–∞ —Å–∞–π—Ç–µ)</label>
                                </div>
                            </div>

                            <div class='form-group'>
                                <label class='form-label'>–°–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã</label>
                                <select name='related_products[]' class='form-select' multiple>
                                    <?php foreach (array_slice(getProducts(), 0, 20) as $product): ?>
                                        <option value='<?= $product['id'] ?>'><?= htmlspecialchars($product['name']) ?></option>
                                    <?php endforeach; ?>
                                </select>
                                <small style='color: var(--text-muted);'>–ó–∞–∂–º–∏—Ç–µ Ctrl –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤</small>
                            </div>

                            <div class='form-group'>
                                <label class='form-label'>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
                                <textarea name='admin_notes' class='form-textarea' rows='3' placeholder='–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏ (–Ω–µ –≤–∏–¥–Ω—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª—è–º)'></textarea>
                            </div>

                            <div class='ai-assistant'>
                                <div class='ai-title'>
                                    <i class='fas fa-chart-line'></i>
                                    –ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–æ–¥–∞–∂
                                </div>
                                <p style='margin: 0; opacity: 0.9; font-size: 14px;'>
                                    –ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Ö–æ–∂–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ –æ–∂–∏–¥–∞–µ–º—ã–µ –ø—Ä–æ–¥–∞–∂–∏: <strong>5-15 —à—Ç/–º–µ—Å—è—Ü</strong><br>
                                    –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Ü–µ–Ω–∞: <strong>350-450‚ÇΩ</strong>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class='mega-modal-footer' style='padding: 20px 32px; border-top: 2px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--bg-secondary);'>
                    <div>
                        <button type='button' class='btn btn-outline' onclick='closeMegaModal()'>
                            <i class='fas fa-times'></i> –û—Ç–º–µ–Ω–∞
                        </button>
                        <button type='button' class='btn btn-warning' onclick='saveDraft()'>
                            <i class='fas fa-save'></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫
                        </button>
                    </div>
                    <div>
                        <button type='submit' class='btn btn-success btn-lg'>
                            <i class='fas fa-check'></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- –õ–æ–∞–¥–µ—Ä -->
    <div class='loading-overlay' id='loadingOverlay'>
        <div class='spinner'></div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Chart.js -->
    <script src='https://cdn.jsdelivr.net/npm/chart.js'></script>

    <!-- –°–∫—Ä–∏–ø—Ç—ã -->
    <script>
        // === –ë–ê–ó–û–í–´–ï –§–£–ù–ö–¶–ò–ò ===
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function showNotification(message, type = 'info', duration = 5000) {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            document.querySelectorAll('.notification').forEach(n => n.remove());

            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class='fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}'></i>
                ${message}
            `;

            document.body.appendChild(notification);

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ
            setTimeout(() => {
                notification.style.animation = 'notificationSlideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }

        // === –ú–ï–ì–ê –ú–û–î–ê–õ–ö–ê ===
        function openMegaModal(productId = null) {
            const modal = document.getElementById('megaProductModal');
            const title = document.getElementById('modalTitle');
            const formAction = document.getElementById('formAction');

            if (productId) {
                title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä';
                formAction.value = 'update_product';
                document.getElementById('productId').value = productId;
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞
                loadProductData(productId);
            } else {
                title.textContent = '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä';
                formAction.value = 'create_product';
                document.getElementById('productId').value = '';
                document.getElementById('megaProductForm').reset();
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                document.getElementById('isActive').checked = true;
                document.querySelector('[name="stock"]').value = '1';
                document.querySelector('[name="weight"]').value = '100';
            }

            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeMegaModal() {
            const modal = document.getElementById('megaProductModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }

        // === –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –¢–û–í–ê–†–ê (–ò–°–ü–†–ê–í–õ–ï–ù–û) ===
        async function loadProductData(productId) {
            try {
                const response = await fetch(`admin.php?action=get_product&ajax=1&id=${productId}`);
                const result = await response.json();

                if (result.success) {
                    const product = result.product;

                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
                    document.querySelector('[name="name"]').value = product.name || '';
                    document.querySelector('[name="category_id"]').value = product.category_id || '';
                    document.querySelector('[name="short_description"]').value = product.short_description || '';
                    document.querySelector('[name="description"]').value = product.description || '';
                    document.querySelector('[name="price"]').value = product.price || '';
                    document.querySelector('[name="old_price"]').value = product.old_price || '';
                    document.querySelector('[name="stock"]').value = product.stock || 0;
                    document.querySelector('[name="sku"]').value = product.sku || '';
                    document.querySelector('[name="weight"]').value = product.weight || 100;
                    document.querySelector('[name="meta_title"]').value = product.meta_title || '';
                    document.querySelector('[name="meta_description"]').value = product.meta_description || '';
                    document.querySelector('[name="meta_keywords"]').value = product.meta_keywords || '';
                    document.querySelector('[name="slug"]').value = product.slug || '';

                    // –†–∞–∑–º–µ—Ä—ã
                    if (product.dimensions) {
                        document.querySelector('[name="length"]').value = product.dimensions.length || '';
                        document.querySelector('[name="width"]').value = product.dimensions.width || '';
                        document.querySelector('[name="height"]').value = product.dimensions.height || '';
                    }

                    // –ß–µ–∫–±–æ–∫—Å—ã
                    document.getElementById('isFeatured').checked = !!product.is_featured;
                    document.getElementById('isNew').checked = !!product.is_new;
                    document.getElementById('isActive').checked = !!product.is_active;

                    // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    const gallery = document.getElementById('imageGallery');
                    gallery.innerHTML = '';
                    if (product.images && product.images.length > 0) {
                        product.images.forEach(image => {
                            addImageToGallery(image, 'existing');
                        });
                    }

                    showNotification('–î–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
                } else {
                    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–∞: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–æ–≤–∞—Ä–∞', 'error');
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.mega-tab-button');
            const tabPanels = document.querySelectorAll('.mega-tab-panel');

            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.dataset.tab;

                    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã
                    tabButtons.forEach(b => b.classList.remove('active'));
                    tabPanels.forEach(p => p.classList.remove('active'));

                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã
                    this.classList.add('active');
                    document.querySelector(`[data-panel='${targetTab}']`).classList.add('active');
                });
            });
        });

        // === DRAG & DROP ===
        const dragDropZone = document.querySelector('.drag-drop-zone');
        const fileInput = document.getElementById('imageFiles');
        const imageGallery = document.getElementById('imageGallery');

        if (dragDropZone) {
            dragDropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('drag-over');
            });

            dragDropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
            });

            dragDropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                handleImageFiles(files);
            });

            fileInput.addEventListener('change', function(e) {
                handleImageFiles(this.files);
            });
        }

        function handleImageFiles(files) {
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        addImageToGallery(e.target.result, file.name);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function addImageToGallery(src, filename) {
            const imageItem = document.createElement('div');
            imageItem.className = 'image-item';
            imageItem.innerHTML = `
                <img src="${src}" alt="${filename}">
                <div class='image-item-overlay'>
                    <div class='image-item-actions'>
                        <button class='image-action-btn primary' onclick='setMainImage(this)' title='–°–¥–µ–ª–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–º'>
                            <i class='fas fa-star'></i>
                        </button>
                        <button class='image-action-btn danger' onclick='removeImage(this)' title='–£–¥–∞–ª–∏—Ç—å'>
                            <i class='fas fa-trash'></i>
                        </button>
                    </div>
                </div>
            `;
            imageGallery.appendChild(imageItem);
        }

        function setMainImage(button) {
            // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å main —É –≤—Å–µ—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            document.querySelectorAll('.image-item').forEach(item => item.classList.remove('main'));
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å main –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É
            button.closest('.image-item').classList.add('main');
            showNotification('–ì–ª–∞–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
        }

        function removeImage(button) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ?')) {
                button.closest('.image-item').remove();
                showNotification('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
            }
        }

        // === AI –§–£–ù–ö–¶–ò–ò ===
        function generateProductName() {
            const names = [
                '–ù–µ–æ–Ω –≥–æ–ª—É–±–æ–π —Å—Ç–∞–π–∫–∞ (10 —à—Ç)',
                '–ê–Ω—É–±–∏–∞—Å –ë–∞—Ä—Ç–µ—Ä–∞ –Ω–∞–Ω–∞ –Ω–∞ –∫–æ—Ä—è–≥–µ',
                '–§–∏–ª—å—Ç—Ä –≤–Ω–µ—à–Ω–∏–π PREMIUM 150–ª',
                '–ö—Ä–µ–≤–µ—Ç–∫–∞ Cherry Red',
                '–ì—Ä—É–Ω—Ç ADA Amazonia 3–ª'
            ];
            const randomName = names[Math.floor(Math.random() * names.length)];
            document.querySelector('[name="name"]').value = randomName;
            showNotification('–ù–∞–∑–≤–∞–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ', 'success');
        }

        function generateDescription() {
            const descriptions = [
                '–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä –¥–ª—è –∞–∫–≤–∞—Ä–∏—É–º–∞. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö –∏ –æ–ø—ã—Ç–Ω—ã—Ö –∞–∫–≤–∞—Ä–∏—É–º–∏—Å—Ç–æ–≤. –û—Ç–ª–∏—á–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ü–µ–Ω–∞-–∫–∞—á–µ—Å—Ç–≤–æ.',
                '–ü–æ–ø—É–ª—è—Ä–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç —Å –ø—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω—ã–º–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏. –ë—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –≤—Å–µ–π –†–æ—Å—Å–∏–∏. –ì–∞—Ä–∞–Ω—Ç–∏—è –∫–∞—á–µ—Å—Ç–≤–∞.',
                '–≠–ª–µ–≥–∞–Ω—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏—Ä–æ–¥–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞ –∞–∫–≤–∞—Ä–∏—É–º–∞. –•–æ—Ä–æ—à–æ —Å–º–æ—Ç—Ä–∏—Ç—Å—è –≤ –∫–æ–º–ø–æ–∑–∏—Ü–∏—è—Ö –ª—é–±–æ–≥–æ —Å—Ç–∏–ª—è.'
            ];
            const randomDesc = descriptions[Math.floor(Math.random() * descriptions.length)];
            document.querySelector('[name="description"]').value = randomDesc;
            showNotification('–û–ø–∏—Å–∞–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ', 'success');
        }

        function suggestCategory() {
            const categories = document.querySelectorAll('[name="category_id"] option');
            const randomCategory = categories[Math.floor(Math.random() * (categories.length - 1)) + 1];
            randomCategory.selected = true;
            showNotification('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø–æ–¥–æ–±—Ä–∞–Ω–∞', 'success');
        }

        async function generateSEO() {
            const name = document.querySelector('[name="name"]').value;
            const category = document.querySelector('[name="category_id"] option:checked').textContent;

            if (!name) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞', 'warning');
                return;
            }

            try {
                const response = await fetch('admin.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `action=generate_seo&ajax=1&name=${encodeURIComponent(name)}&category=${encodeURIComponent(category)}`
                });

                const result = await response.json();

                if (result.success) {
                    document.querySelector('[name="meta_title"]').value = result.seo.meta_title;
                    document.querySelector('[name="meta_description"]').value = result.seo.meta_description;
                    document.querySelector('[name="meta_keywords"]').value = result.seo.meta_keywords;
                    showNotification('SEO –¥–∞–Ω–Ω—ã–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã', 'success');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SEO', 'error');
            }
        }

        function analyzeSEO() {
            const title = document.querySelector('[name="meta_title"]').value;
            const description = document.querySelector('[name="meta_description"]').value;

            let score = 0;
            let tips = [];

            if (title.length >= 50 && title.length <= 60) score += 25;
            else tips.push('–û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞: 50-60 —Å–∏–º–≤–æ–ª–æ–≤');

            if (description.length >= 150 && description.length <= 160) score += 25;
            else tips.push('–û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –æ–ø–∏—Å–∞–Ω–∏—è: 150-160 —Å–∏–º–≤–æ–ª–æ–≤');

            if (title.toLowerCase().includes('–∫—É–ø–∏—Ç—å')) score += 25;
            else tips.push('–î–æ–±–∞–≤—å—Ç–µ —Å–ª–æ–≤–æ "–∫—É–ø–∏—Ç—å" –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫');

            if (description.toLowerCase().includes('–¥–æ—Å—Ç–∞–≤–∫–∞')) score += 25;
            else tips.push('–£–ø–æ–º—è–Ω–∏—Ç–µ –¥–æ—Å—Ç–∞–≤–∫—É –≤ –æ–ø–∏—Å–∞–Ω–∏–∏');

            showNotification(`SEO –æ—Ü–µ–Ω–∫–∞: ${score}/100. ${tips.length ? '–°–æ–≤–µ—Ç—ã: ' + tips[0] : '–û—Ç–ª–∏—á–Ω–æ!'}`, score >= 75 ? 'success' : 'warning');
        }

        function checkKeywords() {
            showNotification('–ê–Ω–∞–ª–∏–∑ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'info');
        }

        function saveDraft() {
            showNotification('–ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'info');
        }

        // === AJAX –§–£–ù–ö–¶–ò–ò ===
        async function makeAjaxRequest(action, data = {}) {
            showLoading();

            const formData = new FormData();
            formData.append('action', action);
            formData.append('ajax', '1');

            for (let key in data) {
                formData.append(key, data[key]);
            }

            try {
                const response = await fetch('admin.php', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('AJAX Error:', error);
                return { success: false, message: '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏' };
            } finally {
                hideLoading();
            }
        }

        // === –§–£–ù–ö–¶–ò–ò –î–õ–Ø –¢–û–í–ê–†–û–í ===
        async function toggleProductStatus(productId, isActive) {
            const result = await makeAjaxRequest('toggle_product_status', {
                product_id: productId,
                is_active: isActive ? '1' : '0'
            });

            if (result.success) {
                showNotification(result.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(result.message, 'error');
            }
        }

        async function deleteProduct(productId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

            const result = await makeAjaxRequest('delete_product', {
                product_id: productId
            });

            if (result.success) {
                showNotification(result.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(result.message, 'error');
            }
        }

        async function duplicateProduct(productId) {
            const result = await makeAjaxRequest('duplicate_product', {
                product_id: productId
            });

            if (result.success) {
                showNotification(result.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(result.message, 'error');
            }
        }

        async function exportProducts() {
            const result = await makeAjaxRequest('export_products');

            if (result.success) {
                showNotification(result.message, 'success');
                // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
                window.location.href = result.file;
            } else {
                showNotification(result.message, 'error');
            }
        }

        // === –°–£–ü–ï–† –ê–ù–ê–õ–ò–¢–ò–ö–ê ===
        let superAnalyticsData = null;

        async function loadSuperAnalytics() {
            try {
                const result = await makeAjaxRequest('get_super_analytics');

                if (result.success) {
                    superAnalyticsData = result.analytics;
                    renderSuperCharts();
                    return result.analytics;
                } else {
                    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏', 'error');
                    return null;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏', 'error');
                return null;
            }
        }

        function renderSuperCharts() {
            if (!superAnalyticsData) return;

            // –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–¥–∞–∂ –ø–æ –¥–Ω—è–º
            const salesCtx = document.getElementById('salesChart');
            if (salesCtx) {
                new Chart(salesCtx, {
                    type: 'line',
                    data: {
                        labels: superAnalyticsData.sales_by_day.map(item => item.date_formatted),
                        datasets: [{
                            label: '–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)',
                            data: superAnalyticsData.sales_by_day.map(item => item.revenue),
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            fill: true,
                            tension: 0.4
                        }, {
                            label: '–ó–∞–∫–∞–∑—ã',
                            data: superAnalyticsData.sales_by_day.map(item => item.orders),
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: '–î–∞—Ç–∞'
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: '–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                },
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: '–î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–æ–¥–∞–∂ –∑–∞ 30 –¥–Ω–µ–π'
                            }
                        }
                    }
                });
            }

            // –ì—Ä–∞—Ñ–∏–∫ –ø–æ —á–∞—Å–∞–º
            const hourlyCtx = document.getElementById('hourlyChart');
            if (hourlyCtx) {
                new Chart(hourlyCtx, {
                    type: 'bar',
                    data: {
                        labels: superAnalyticsData.hourly_data.map(item => item.hour),
                        datasets: [{
                            label: '–ó–∞–∫–∞–∑—ã',
                            data: superAnalyticsData.hourly_data.map(item => item.orders),
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: '#667eea',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            const categoriesCtx = document.getElementById('categoriesChart');
            if (categoriesCtx) {
                const colors = ['#667eea', '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6', '#1abc9c', '#34495e', '#16a085'];

                new Chart(categoriesCtx, {
                    type: 'doughnut',
                    data: {
                        labels: superAnalyticsData.category_analytics.map(cat => cat.name),
                        datasets: [{
                            data: superAnalyticsData.category_analytics.map(cat => cat.percentage),
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                            },
                            title: {
                                display: true,
                                text: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º'
                            }
                        }
                    }
                });
            }

            // –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂
            const funnelCtx = document.getElementById('funnelChart');
            if (funnelCtx) {
                new Chart(funnelCtx, {
                    type: 'bar',
                    data: {
                        labels: superAnalyticsData.funnel_data.map(item => item.stage),
                        datasets: [{
                            label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
                            data: superAnalyticsData.funnel_data.map(item => item.count),
                            backgroundColor: [
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(46, 204, 113, 0.8)',
                                'rgba(243, 156, 18, 0.8)',
                                'rgba(231, 76, 60, 0.8)',
                                'rgba(155, 89, 182, 0.8)'
                            ],
                            borderColor: [
                                '#3498db',
                                '#2ecc71',
                                '#f39c12',
                                '#e74c3c',
                                '#9b59b6'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: '–í–æ—Ä–æ–Ω–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏'
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        document.addEventListener('DOMContentLoaded', function() {
            const notification = document.getElementById('adminNotification');
            if (notification) {
                setTimeout(() => {
                    notification.style.animation = 'notificationSlideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 5000);
            }

            // –ï—Å–ª–∏ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏, –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            if (window.location.search.includes('section=analytics')) {
                setTimeout(() => {
                    loadSuperAnalytics();
                }, 500);
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–æ ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeMegaModal();
            }
        });

        // CSS –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        const style = document.createElement('style');
        style.textContent = `
            @keyframes notificationSlideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // === –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –¢–û–í–ê–†–û–í ===
        function searchProducts(query) {
            const rows = document.querySelectorAll('#productsTable tbody tr');
            const searchTerm = query.toLowerCase();

            rows.forEach(row => {
                const name = row.dataset.name;
                const visible = name.includes(searchTerm);
                row.style.display = visible ? '' : 'none';
            });
        }

        function filterByCategory(categoryId) {
            const rows = document.querySelectorAll('#productsTable tbody tr');

            rows.forEach(row => {
                const rowCategory = row.dataset.category;
                const visible = !categoryId || rowCategory === categoryId;
                row.style.display = visible ? '' : 'none';
            });
        }

        function toggleAllProducts(checked) {
            document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = checked);
        }

        function getSelectedProducts() {
            return Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);
        }

        async function bulkAction(action) {
            const selectedIds = getSelectedProducts();
            if (selectedIds.length === 0) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–∏', 'warning');
                return;
            }

            if (action === 'delete' && !confirm(`–£–¥–∞–ª–∏—Ç—å ${selectedIds.length} —Ç–æ–≤–∞—Ä–æ–≤?`)) return;

            const result = await makeAjaxRequest('bulk_products', {
                product_ids: selectedIds.join(','),
                bulk_action: action
            });

            if (result.success) {
                showNotification(result.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(result.message, 'error');
            }
        }

        function importProducts(input) {
            if (!input.files[0]) return;

            const formData = new FormData();
            formData.append('action', 'import_products');
            formData.append('csv_file', input.files[0]);

            showLoading();

            fetch('admin.php', {
                method: 'POST',
                body: formData
            }).then(() => {
                hideLoading();
                showNotification('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω', 'success');
                setTimeout(() => location.reload(), 2000);
            });
        }
    </script>
</body>
</html>

<?php

// === –§–£–ù–ö–¶–ò–ò –î–ê–ù–ù–´–• –ê–î–ú–ò–ù–ö–ò ===

function getAdminData($section) {
    switch ($section) {
        case 'dashboard':
            return [
                'title' => 'KPI –î–∞—à–±–æ—Ä–¥',
                'stats' => getDashboardStats(),
                'recent_activity' => getRecentActivity()
            ];
        case 'products':
            return [
                'title' => 'MEGA –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏',
                'products' => getProducts(),
                'categories' => getCategories(),
                'stats' => getProductsStats()
            ];
        case 'categories':
            return [
                'title' => '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏',
                'categories' => getCategories(),
                'stats' => getCategoriesStats()
            ];
        case 'orders':
            return [
                'title' => '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏',
                'orders' => getOrders(),
                'stats' => getOrdersStats()
            ];
        case 'reviews':
            return [
                'title' => '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞–º–∏',
                'reviews' => getReviews(),
                'stats' => getReviewsStats()
            ];
        case 'news':
            return [
                'title' => '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç—è–º–∏',
                'news' => getNews(),
                'stats' => getNewsStats()
            ];
        case 'analytics':
            return [
                'title' => '–°–£–ü–ï–† –ì—Ä–∞—Ñ–∏–∫–∏ –ø—Ä–æ–¥–∞–∂',
                'charts_data' => getAnalyticsData()
            ];
        case 'settings':
            return [
                'title' => '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã',
                'settings' => getSiteSettings()
            ];
        case 'logs':
            return [
                'title' => '–°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏',
                'logs' => getAdminLogs()
            ];
        case 'pages':
            return [
                'title' => '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏',
                'pages' => getStaticPages()
            ];
        default:
            return [
                'title' => ucfirst($section),
                'description' => "–†–∞–∑–¥–µ–ª '$section' –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é"
            ];
    }
}

function getPageIcon($section) {
    $icons = [
        'dashboard' => 'fas fa-chart-pie',
        'products' => 'fas fa-fish',
        'categories' => 'fas fa-tags',
        'orders' => 'fas fa-shopping-bag',
        'reviews' => 'fas fa-star',
        'news' => 'fas fa-newspaper',
        'analytics' => 'fas fa-chart-line',
        'settings' => 'fas fa-cog',
        'logs' => 'fas fa-list-alt',
        'pages' => 'fas fa-file-alt'
    ];

    return $icons[$section] ?? 'fas fa-cog';
}

function getDashboardStats() {
    $products = getProducts();
    $orders = getOrders();
    $reviews = getReviews();
    $categories = getCategories();

    $totalRevenue = array_sum(array_column($orders, 'total_amount'));
    $newOrders = count(array_filter($orders, fn($o) => $o['status'] === 'new'));
    $activeProducts = count(array_filter($products, fn($p) => $p['is_active']));
    $avgRating = count($reviews) > 0 ? array_sum(array_column($reviews, 'rating')) / count($reviews) : 0;
    $pendingReviews = count(array_filter($reviews, fn($r) => !$r['is_approved']));

    // –î–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–æ—Å—Ç–∞
    $monthAgo = date('Y-m-d', strtotime('-30 days'));
    $monthlyOrders = array_filter($orders, fn($o) => $o['created_at'] >= $monthAgo);
    $monthlyRevenue = array_sum(array_column($monthlyOrders, 'total_amount'));

    return [
        'revenue' => [
            'value' => number_format($totalRevenue, 0, '', ' ') . ' ‚ÇΩ',
            'label' => '–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞',
            'change' => '+' . number_format($monthlyRevenue, 0, '', ' ') . ' ‚ÇΩ –∑–∞ –º–µ—Å—è—Ü',
            'trend' => 'positive',
            'icon' => 'fas fa-ruble-sign'
        ],
        'orders' => [
            'value' => count($orders),
            'label' => '–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤',
            'change' => '+' . $newOrders . ' –Ω–æ–≤—ã—Ö',
            'trend' => $newOrders > 0 ? 'positive' : 'neutral',
            'icon' => 'fas fa-shopping-bag'
        ],
        'products' => [
            'value' => $activeProducts,
            'label' => '–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤',
            'change' => '–∏–∑ ' . count($products) . ' –≤—Å–µ–≥–æ',
            'trend' => 'neutral',
            'icon' => 'fas fa-fish'
        ],
        'rating' => [
            'value' => number_format($avgRating, 1),
            'label' => '–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥',
            'change' => count($reviews) . ' –æ—Ç–∑—ã–≤–æ–≤',
            'trend' => $avgRating >= 4 ? 'positive' : ($avgRating >= 3 ? 'neutral' : 'negative'),
            'icon' => 'fas fa-star'
        ],
        'categories' => [
            'value' => count(array_filter($categories, fn($c) => $c['active'])),
            'label' => '–ê–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π',
            'change' => '–∏–∑ ' . count($categories) . ' –≤—Å–µ–≥–æ',
            'trend' => 'neutral',
            'icon' => 'fas fa-tags'
        ],
        'pending' => [
            'value' => $pendingReviews,
            'label' => '–û–∂–∏–¥–∞—é—Ç –º–æ–¥–µ—Ä–∞—Ü–∏–∏',
            'change' => '–æ—Ç–∑—ã–≤—ã –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ',
            'trend' => $pendingReviews > 5 ? 'negative' : 'positive',
            'icon' => 'fas fa-clock'
        ]
    ];
}

function getRecentActivity() {
    return [
        [
            'time' => '2 –º–∏–Ω –Ω–∞–∑–∞–¥',
            'action' => '–ù–æ–≤—ã–π –∑–∞–∫–∞–∑',
            'details' => '–ó–∞–∫–∞–∑ #AQ-2024-' . str_pad(rand(1, 999), 4, '0', STR_PAD_LEFT) . ' –Ω–∞ —Å—É–º–º—É ' . number_format(rand(1000, 5000), 0, '', ' ') . ' ‚ÇΩ',
            'icon' => 'fas fa-shopping-bag',
            'type' => 'success'
        ],
        [
            'time' => '8 –º–∏–Ω –Ω–∞–∑–∞–¥',
            'action' => '–ù–æ–≤—ã–π –æ—Ç–∑—ã–≤',
            'details' => '–û—Ç–∑—ã–≤ –Ω–∞ —Ç–æ–≤–∞—Ä "–ê–Ω—É–±–∏–∞—Å –ë–∞—Ä—Ç–µ—Ä–∞ –Ω–∞–Ω–∞"',
            'icon' => 'fas fa-star',
            'type' => 'info'
        ],
        [
            'time' => '15 –º–∏–Ω –Ω–∞–∑–∞–¥',
            'action' => '–¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω',
            'details' => '–û–±–Ω–æ–≤–ª–µ–Ω —Ç–æ–≤–∞—Ä "–°–∫–∞–ª—è—Ä–∏—è —Å–µ—Ä–µ–±—Ä–∏—Å—Ç–∞—è"',
            'icon' => 'fas fa-edit',
            'type' => 'primary'
        ],
        [
            'time' => '1 —á–∞—Å –Ω–∞–∑–∞–¥',
            'action' => '–ó–∞–∫–∞–∑ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω',
            'details' => '–ó–∞–∫–∞–∑ #AQ-2024-' . str_pad(rand(1, 999), 4, '0', STR_PAD_LEFT) . ' —É—Å–ø–µ—à–Ω–æ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω',
            'icon' => 'fas fa-truck',
            'type' => 'success'
        ],
        [
            'time' => '2 —á–∞—Å–∞ –Ω–∞–∑–∞–¥',
            'action' => '–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è',
            'details' => '–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è "–ú–æ—Ä—Å–∫–∏–µ —Ä—ã–±–∫–∏"',
            'icon' => 'fas fa-plus',
            'type' => 'success'
        ]
    ];
}

function getProductsStats() {
    $products = getProducts();

    return [
        'total' => count($products),
        'active' => count(array_filter($products, fn($p) => $p['is_active'])),
        'featured' => count(array_filter($products, fn($p) => $p['is_featured'])),
        'low_stock' => count(array_filter($products, fn($p) => $p['stock'] <= 5))
    ];
}

function getCategoriesStats() {
    $categories = getCategories();

    return [
        'total' => count($categories),
        'active' => count(array_filter($categories, fn($c) => $c['active']))
    ];
}

function getOrdersStats() {
    $orders = getOrders();

    $stats = [
        'total' => count($orders),
        'new' => count(array_filter($orders, fn($o) => $o['status'] === 'new')),
        'processing' => count(array_filter($orders, fn($o) => $o['status'] === 'processing')),
        'completed' => count(array_filter($orders, fn($o) => $o['status'] === 'delivered')),
        'total_amount' => array_sum(array_column($orders, 'total_amount'))
    ];

    return $stats;
}

function getReviewsStats() {
    $reviews = getReviews();

    return [
        'total' => count($reviews),
        'approved' => count(array_filter($reviews, fn($r) => $r['is_approved'])),
        'pending' => count(array_filter($reviews, fn($r) => !$r['is_approved'])),
        'average_rating' => count($reviews) > 0 ? array_sum(array_column($reviews, 'rating')) / count($reviews) : 0
    ];
}

function getNewsStats() {
    $news = getNews();

    return [
        'total' => count($news),
        'published' => count(array_filter($news, fn($n) => $n['is_published'])),
        'drafts' => count(array_filter($news, fn($n) => !$n['is_published'])),
        'total_views' => array_sum(array_column($news, 'views'))
    ];
}

function getAnalyticsData() {
    return [
        'sales_chart' => generateSalesChartData(),
        'categories_chart' => generateCategoriesChartData()
    ];
}

function generateSalesChartData() {
    $data = [];
    for ($i = 29; $i >= 0; $i--) {
        $date = date('Y-m-d', strtotime("-$i days"));
        $data[] = [
            'date' => $date,
            'sales' => rand(5000, 50000),
            'orders' => rand(10, 100)
        ];
    }
    return $data;
}

function generateCategoriesChartData() {
    $categories = getCategories();
    $products = getProducts();

    $data = [];
    foreach ($categories as $category) {
        $count = count(array_filter($products, fn($p) => $p['category_id'] == $category['id']));
        if ($count > 0) {
            $data[] = [
                'name' => $category['name'],
                'value' => $count,
                'icon' => $category['icon']
            ];
        }
    }

    return $data;
}

// === –§–£–ù–ö–¶–ò–ò –û–ë–†–ê–ë–û–¢–ö–ò –î–ê–ù–ù–´–• ===

function toggleProductStatus($productId, $isActive) {
    try {
        $dynamicData = loadDynamicData();
        if (!$dynamicData) {
            $dynamicData = initializeDynamicData();
        }

        $products = &$dynamicData['products'];

        $productIndex = array_search($productId, array_column($products, 'id'));
        if ($productIndex === false) {
            return ['success' => false, 'message' => '–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω'];
        }

        $products[$productIndex]['is_active'] = (bool)$isActive;
        $products[$productIndex]['updated_at'] = date('Y-m-d H:i:s');
        $dynamicData['last_updated'] = date('Y-m-d H:i:s');

        if (saveDynamicData($dynamicData)) {
            $status = $isActive ? '–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω' : '–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω';
            logAdminAction('PRODUCTS', "–¢–æ–≤–∞—Ä $status: {$products[$productIndex]['name']}");
            return ['success' => true, 'message' => "–¢–æ–≤–∞—Ä $status"];
        } else {
            return ['success' => false, 'message' => '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'];
        }
    } catch (Exception $e) {
        return ['success' => false, 'message' => '–û—à–∏–±–∫–∞: ' . $e->getMessage()];
    }
}

function approveReview($reviewId) {
    try {
        $dynamicData = loadDynamicData();
        if (!$dynamicData) {
            $dynamicData = initializeDynamicData();
        }

        $reviews = &$dynamicData['reviews'];

        $reviewIndex = array_search($reviewId, array_column($reviews, 'id'));
        if ($reviewIndex === false) {
            return ['success' => false, 'message' => '–û—Ç–∑—ã–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω'];
        }

        $reviews[$reviewIndex]['is_approved'] = true;
        $dynamicData['last_updated'] = date('Y-m-d H:i:s');

        if (saveDynamicData($dynamicData)) {
            logAdminAction('REVIEWS', "–û—Ç–∑—ã–≤ –æ–¥–æ–±—Ä–µ–Ω ID:$reviewId");
            return ['success' => true, 'message' => '–û—Ç–∑—ã–≤ –æ–¥–æ–±—Ä–µ–Ω'];
        } else {
            return ['success' => false, 'message' => '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'];
        }
    } catch (Exception $e) {
        return ['success' => false, 'message' => '–û—à–∏–±–∫–∞: ' . $e->getMessage()];
    }
}

function deleteReview($reviewId) {
    try {
        $dynamicData = loadDynamicData();
        if (!$dynamicData) {
            $dynamicData = initializeDynamicData();
        }

        $reviews = &$dynamicData['reviews'];

        $reviewIndex = array_search($reviewId, array_column($reviews, 'id'));
        if ($reviewIndex === false) {
            return ['success' => false, 'message' => '–û—Ç–∑—ã–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω'];
        }

        array_splice($reviews, $reviewIndex, 1);
        $dynamicData['last_updated'] = date('Y-m-d H:i:s');

        if (saveDynamicData($dynamicData)) {
            logAdminAction('REVIEWS', "–û—Ç–∑—ã–≤ —É–¥–∞–ª–µ–Ω ID:$reviewId");
            return ['success' => true, 'message' => '–û—Ç–∑—ã–≤ —É–¥–∞–ª–µ–Ω'];
        } else {
            return ['success' => false, 'message' => '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'];
        }
    } catch (Exception $e) {
        return ['success' => false, 'message' => '–û—à–∏–±–∫–∞: ' . $e->getMessage()];
    }
}

// === –§–£–ù–ö–¶–ò–ò –†–ï–ù–î–ï–†–ò–ù–ì–ê –†–ê–ó–î–ï–õ–û–í ===

function renderAdminSection($section, $data) {
    switch ($section) {
        case 'dashboard':
            renderDashboard($data);
            break;
        case 'products':
            renderMegaProductsSection($data);
            break;
        case 'categories':
            renderCategoriesSection($data);
            break;
        case 'orders':
            renderOrdersSection($data);
            break;
        case 'reviews':
            renderReviewsSection($data);
            break;
        case 'news':
            renderNewsSection($data);
            break;
        case 'analytics':
            renderSuperAnalyticsSection($data);
            break;
        case 'settings':
            renderSettingsSection($data);
            break;
        case 'logs':
            renderLogsSection($data);
            break;
        case 'pages':
            renderPagesSection($data);
            break;
        default:
            renderDefaultSection($section, $data);
    }
}

// === –î–ê–®–ë–û–†–î ===
function renderDashboard($data) {
    $stats = $data['stats'];
    $activity = $data['recent_activity'] ?? [];
    ?>
    <!-- KPI –ö–∞—Ä—Ç–æ—á–∫–∏ -->
    <div class='stats-grid'>
        <?php foreach ($stats as $key => $stat): ?>
            <div class='stat-card stat-<?= $stat['trend'] === 'positive' ? 'success' : ($stat['trend'] === 'negative' ? 'danger' : 'primary') ?>' data-stat='<?= $key ?>'>
                <div class='stat-header'>
                    <div class='stat-icon stat-<?= $stat['trend'] === 'positive' ? 'success' : ($stat['trend'] === 'negative' ? 'danger' : 'primary') ?>'>
                        <i class='<?= $stat['icon'] ?>'></i>
                    </div>
                    <div class='stat-trend'>
                        <i class='fas fa-<?= $stat['trend'] === 'positive' ? 'arrow-up' : ($stat['trend'] === 'negative' ? 'arrow-down' : 'minus') ?>'></i>
                    </div>
                </div>

                <div class='stat-value'><?= $stat['value'] ?></div>
                <div class='stat-label'><?= $stat['label'] ?></div>
                <div class='stat-change <?= $stat['trend'] ?>'>
                    <i class='fas fa-<?= $stat['trend'] === 'positive' ? 'arrow-up' : ($stat['trend'] === 'negative' ? 'arrow-down' : 'minus') ?>'></i>
                    <?= $stat['change'] ?>
                </div>
            </div>
        <?php endforeach; ?>
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å -->
    <div class='content-card'>
        <div class='content-card-header'>
            <h3 class='content-card-title'>
                <i class='fas fa-clock'></i>
                –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
            </h3>
            <button class='btn btn-outline btn-sm' onclick='location.reload()'>
                <i class='fas fa-sync-alt'></i>
                –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>
        <div class='content-card-body'>
            <div style='display: grid; gap: 16px;'>
                <?php foreach ($activity as $item): ?>
                    <div style='display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--bg-secondary); border-radius: var(--border-radius-lg); border-left: 4px solid var(--<?= $item['type'] === 'success' ? 'success' : ($item['type'] === 'primary' ? 'primary' : 'info') ?>-color);'>
                        <div style='width: 40px; height: 40px; border-radius: 50%; background: var(--<?= $item['type'] === 'success' ? 'success' : ($item['type'] === 'primary' ? 'primary' : 'info') ?>-color); display: flex; align-items: center; justify-content: center; color: white;'>
                            <i class='<?= $item['icon'] ?>'></i>
                        </div>
                        <div style='flex: 1;'>
                            <div style='font-weight: 600; margin-bottom: 4px;'><?= $item['action'] ?></div>
                            <div style='color: var(--text-secondary); font-size: 14px;'><?= $item['details'] ?></div>
                        </div>
                        <div style='color: var(--text-muted); font-size: 13px; white-space: nowrap;'>
                            <?= $item['time'] ?>
                        </div>
                    </div>
                <?php endforeach; ?>
            </div>
        </div>
    </div>
    <?php
}

// === –°–£–ü–ï–† –ú–ï–ì–ê –ê–ù–ê–õ–ò–¢–ò–ö–ê ===
function renderSuperAnalyticsSection($data) {
    ?>
    <!-- –°–£–ü–ï–† KPI –º–µ—Ç—Ä–∏–∫–∏ -->
    <div class='stats-grid' style='margin-bottom: 40px;'>
        <div class='stat-card stat-primary'>
            <div class='stat-header'>
                <div class='stat-icon'>
                    <i class='fas fa-chart-line'></i>
                </div>
            </div>
            <div class='stat-value' id='totalOrders'></div>
            <div class='stat-label'>–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
            <div class='stat-change positive'>
                <i class='fas fa-arrow-up'></i>
                <span id='ordersGrowth'>+12% –∑–∞ –º–µ—Å—è—Ü</span>
            </div>
        </div>

        <div class='stat-card stat-success'>
            <div class='stat-header'>
                <div class='stat-icon stat-success'>
                    <i class='fas fa-ruble-sign'></i>
                </div>
            </div>
            <div class='stat-value' id='totalRevenue'></div>
            <div class='stat-label'>–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</div>
            <div class='stat-change positive'>
                <i class='fas fa-arrow-up'></i>
                <span id='revenueGrowth'>+25% –∑–∞ –º–µ—Å—è—Ü</span>
            </div>
        </div>

        <div class='stat-card stat-warning'>
            <div class='stat-header'>
                <div class='stat-icon stat-warning'>
                    <i class='fas fa-shopping-cart'></i>
                </div>
            </div>
            <div class='stat-value' id='avgOrderValue'></div>
            <div class='stat-label'>–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</div>
            <div class='stat-change positive'>
                <i class='fas fa-arrow-up'></i>
                <span id='avgOrderGrowth'>+8% –∑–∞ –º–µ—Å—è—Ü</span>
            </div>
        </div>

        <div class='stat-card stat-danger'>
            <div class='stat-header'>
                <div class='stat-icon stat-danger'>
                    <i class='fas fa-percentage'></i>
                </div>
            </div>
            <div class='stat-value' id='conversionRate'></div>
            <div class='stat-label'>–ö–æ–Ω–≤–µ—Ä—Å–∏—è</div>
            <div class='stat-change positive'>
                <i class='fas fa-arrow-up'></i>
                <span id='conversionGrowth'>+3.2% –∑–∞ –º–µ—Å—è—Ü</span>
            </div>
        </div>
    </div>

    <!-- –°–£–ü–ï–† –ì—Ä–∞—Ñ–∏–∫–∏ -->
    <div class='analytics-grid'>
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–¥–∞–∂ -->
        <div class='analytics-card'>
            <div class='analytics-card-header'>
                <div class='analytics-card-title'>
                    <i class='fas fa-chart-area'></i>
                    –î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–æ–¥–∞–∂ –∑–∞ 30 –¥–Ω–µ–π
                </div>
                <div style='display: flex; gap: 8px;'>
                    <button class='btn btn-sm' style='background: rgba(255,255,255,0.2); color: white; border: none;' onclick='switchChartPeriod("30d")'>30 –¥–Ω–µ–π</button>
                    <button class='btn btn-sm' style='background: rgba(255,255,255,0.1); color: white; border: none;' onclick='switchChartPeriod("7d")'>7 –¥–Ω–µ–π</button>
                </div>
            </div>
            <div class='analytics-card-body'>
                <div class='chart-container chart-big'>
                    <canvas id='salesChart'></canvas>
                </div>
            </div>
        </div>

        <!-- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º -->
        <div class='analytics-card'>
            <div class='analytics-card-header'>
                <div class='analytics-card-title'>
                    <i class='fas fa-clock'></i>
                    –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º
                </div>
            </div>
            <div class='analytics-card-body'>
                <div class='chart-container'>
                    <canvas id='hourlyChart'></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ -->
    <div class='analytics-grid'>
        <!-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
        <div class='analytics-card'>
            <div class='analytics-card-header'>
                <div class='analytics-card-title'>
                    <i class='fas fa-chart-pie'></i>
                    –ü—Ä–æ–¥–∞–∂–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                </div>
            </div>
            <div class='analytics-card-body'>
                <div class='chart-container'>
                    <canvas id='categoriesChart'></canvas>
                </div>
            </div>
        </div>

        <!-- –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂ -->
        <div class='analytics-card'>
            <div class='analytics-card-header'>
                <div class='analytics-card-title'>
                    <i class='fas fa-filter'></i>
                    –í–æ—Ä–æ–Ω–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
                </div>
            </div>
            <div class='analytics-card-body'>
                <div class='chart-container'>
                    <canvas id='funnelChart'></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- –¢–æ–ø —Ç–æ–≤–∞—Ä—ã -->
    <div class='content-card'>
        <div class='content-card-header'>
            <h3 class='content-card-title'>
                <i class='fas fa-trophy'></i>
                –¢–û–ü-10 —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º
            </h3>
            <button class='btn btn-outline btn-sm' onclick='loadSuperAnalytics()'>
                <i class='fas fa-sync-alt'></i>
                –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
            </button>
        </div>
        <div class='content-card-body'>
            <div class='table-container'>
                <table class='table' id='topProductsTable'>
                    <thead>
                        <tr>
                            <th>–ú–µ—Å—Ç–æ</th>
                            <th>–¢–æ–≤–∞—Ä</th>
                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th>–ü—Ä–æ–¥–∞–Ω–æ</th>
                            <th>–í—ã—Ä—É—á–∫–∞</th>
                            <th>–†–æ—Å—Ç</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
                        <tr>
                            <td colspan='6' style='text-align: center; padding: 40px; color: var(--text-muted);'>
                                <i class='fas fa-spinner fa-spin'></i> –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- –ì–µ–æ–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
    <div class='content-card'>
        <div class='content-card-header'>
            <h3 class='content-card-title'>
                <i class='fas fa-globe'></i>
                –ì–µ–æ–≥—Ä–∞—Ñ–∏—è –ø—Ä–æ–¥–∞–∂
            </h3>
        </div>
        <div class='content-card-body'>
            <div style='display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;' id='geoAnalytics'>
                <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
            </div>
        </div>
    </div>

    <script>
        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
        let currentChartPeriod = '30d';

        function switchChartPeriod(period) {
            currentChartPeriod = period;
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            showNotification(`–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –Ω–∞ –ø–µ—Ä–∏–æ–¥: ${period}`, 'info');
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
            setTimeout(() => {
                loadSuperAnalytics().then(data => {
                    if (data) {
                        updateTopProductsTable(data.top_products);
                        updateGeoAnalytics(data.geo_data);
                        updateKPIStats(data.totals);
                    }
                });
            }, 500);
        });

        function updateKPIStats(totals) {
            document.getElementById('totalOrders').textContent = totals.total_orders.toLocaleString();
            document.getElementById('totalRevenue').textContent = totals.total_revenue.toLocaleString() + ' ‚ÇΩ';
            document.getElementById('avgOrderValue').textContent = Math.round(totals.avg_order_value).toLocaleString() + ' ‚ÇΩ';
            document.getElementById('conversionRate').textContent = totals.conversion_rate + '%';
        }

        function updateTopProductsTable(products) {
            const tbody = document.querySelector('#topProductsTable tbody');
            tbody.innerHTML = '';

            products.forEach((product, index) => {
                const row = document.createElement('tr');
                const growth = Math.random() > 0.5 ? '+' + Math.floor(Math.random() * 30) : '-' + Math.floor(Math.random() * 10);
                const growthClass = growth.startsWith('+') ? 'positive' : 'negative';

                row.innerHTML = `
                    <td>
                        <div style='width: 30px; height: 30px; background: ${index < 3 ? 'linear-gradient(45deg, gold, orange)' : 'var(--primary-color)'}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;'>
                            ${index + 1}
                        </div>
                    </td>
                    <td>
                        <div style='font-weight: 600;'>${product.name}</div>
                        <div style='font-size: 12px; color: var(--text-muted);'>${product.sku}</div>
                    </td>
                    <td>${product.category}</td>
                    <td>
                        <span style='font-weight: 600; color: var(--success-color);'>${product.sales} —à—Ç</span>
                    </td>
                    <td>
                        <span style='font-weight: 600; color: var(--success-color);'>
                            ${(product.price * product.sales).toLocaleString()} ‚ÇΩ
                        </span>
                    </td>
                    <td>
                        <span class='stat-change ${growthClass}' style='padding: 2px 6px;'>
                            <i class='fas fa-arrow-${growth.startsWith('+') ? 'up' : 'down'}'></i>
                            ${growth}%
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateGeoAnalytics(geoData) {
            const container = document.getElementById('geoAnalytics');
            container.innerHTML = '';

            geoData.forEach(region => {
                const regionCard = document.createElement('div');
                regionCard.style.cssText = `
                    padding: 20px;
                    background: var(--bg-primary);
                    border-radius: var(--border-radius-lg);
                    box-shadow: var(--shadow-md);
                    text-align: center;
                    transition: var(--transition);
                `;
                regionCard.innerHTML = `
                    <div style='font-size: 24px; margin-bottom: 8px;'>üåç</div>
                    <div style='font-weight: 600; margin-bottom: 8px;'>${region.region}</div>
                    <div style='font-size: 20px; color: var(--primary-color); font-weight: 700;'>${region.orders}</div>
                    <div style='font-size: 12px; color: var(--text-muted);'>–∑–∞–∫–∞–∑–æ–≤</div>
                    <div style='font-size: 14px; color: var(--success-color); font-weight: 600; margin-top: 8px;'>
                        ${region.revenue.toLocaleString()} ‚ÇΩ
                    </div>
                `;

                regionCard.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px)';
                    this.style.boxShadow = 'var(--shadow-lg)';
                });

                regionCard.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'var(--shadow-md)';
                });

                container.appendChild(regionCard);
            });
        }
    </script>
    <?php
}

// === –ú–ï–ì–ê –£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–û–í–ê–†–ê–ú–ò ===
function renderMegaProductsSection($data) {
    $products = $data['products'];
    $categories = $data['categories'];
    $stats = $data['stats'];
    ?>
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
    <div class='stats-grid' style='grid-template-columns: repeat(4, 1fr); margin-bottom: 32px;'>
        <div class='stat-card stat-primary'>
            <div class='stat-value'><?= $stats['total'] ?></div>
            <div class='stat-label'>–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤</div>
        </div>
        <div class='stat-card stat-success'>
            <div class='stat-value'><?= $stats['active'] ?></div>
            <div class='stat-label'>–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
        </div>
        <div class='stat-card stat-warning'>
            <div class='stat-value'><?= $stats['featured'] ?></div>
            <div class='stat-label'>–ü–æ–ø—É–ª—è—Ä–Ω—ã—Ö</div>
        </div>
        <div class='stat-card stat-danger'>
            <div class='stat-value'><?= $stats['low_stock'] ?></div>
            <div class='stat-label'>–ú–∞–ª–æ —Ç–æ–≤–∞—Ä–∞</div>
        </div>
    </div>

    <!-- –ú–ï–ì–ê –î–µ–π—Å—Ç–≤–∏—è -->
    <div class='d-flex justify-content-between align-items-center mb-4' style='display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;'>
        <div style='display: flex; gap: 16px; align-items: center;'>
            <button class='btn btn-success btn-lg' onclick='openMegaModal()'>
                <i class='fas fa-plus'></i>
                –ú–ï–ì–ê –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
            </button>
            <button class='btn btn-primary' onclick='exportProducts()'>
                <i class='fas fa-download'></i>
                –≠–∫—Å–ø–æ—Ä—Ç CSV
            </button>
            <label class='btn btn-outline' for='importFile'>
                <i class='fas fa-upload'></i>
                –ò–º–ø–æ—Ä—Ç CSV
            </label>
            <input type='file' id='importFile' accept='.csv' style='display: none;' onchange='importProducts(this)'>
        </div>

        <!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
        <div style='display: flex; gap: 12px;'>
            <input type='text' placeholder='–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤...' class='form-input' style='width: 250px;' onkeyup='searchProducts(this.value)'>
            <select class='form-select' onchange='filterByCategory(this.value)'>
                <option value=''>–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                <?php foreach ($categories as $category): ?>
                    <option value='<?= $category['id'] ?>'><?= $category['icon'] ?> <?= htmlspecialchars($category['name']) ?></option>
                <?php endforeach; ?>
            </select>
        </div>
    </div>

    <!-- –ú–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ -->
    <div class='content-card' style='margin-bottom: 24px;'>
        <div class='content-card-header'>
            <h3 class='content-card-title'>
                <i class='fas fa-tools'></i>
                –ú–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
            </h3>
        </div>
        <div class='content-card-body'>
            <div style='display: flex; gap: 12px; align-items: center; flex-wrap: wrap;'>
                <span>–í—ã–¥–µ–ª–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã:</span>
                <button class='btn btn-success btn-sm' onclick='bulkAction("activate")'>
                    <i class='fas fa-eye'></i> –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
                </button>
                <button class='btn btn-warning btn-sm' onclick='bulkAction("deactivate")'>
                    <i class='fas fa-eye-slash'></i> –°–∫—Ä—ã—Ç—å
                </button>
                <button class='btn btn-danger btn-sm' onclick='bulkAction("delete")'>
                    <i class='fas fa-trash'></i> –£–¥–∞–ª–∏—Ç—å
                </button>
                <select class='form-select' style='width: auto;' onchange='bulkUpdateCategory(this.value)'>
                    <option value=''>–ò–∑–º–µ–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                    <?php foreach ($categories as $category): ?>
                        <option value='<?= $category['id'] ?>'><?= $category['icon'] ?> <?= htmlspecialchars($category['name']) ?></option>
                    <?php endforeach; ?>
                </select>
            </div>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
    <div class='content-card'>
        <div class='table-container'>
            <table class='table' id='productsTable'>
                <thead>
                    <tr>
                        <th style='width: 40px;'>
                            <input type='checkbox' onchange='toggleAllProducts(this.checked)'>
                        </th>
                        <th style='width: 60px;'>–§–æ—Ç–æ</th>
                        <th>–¢–æ–≤–∞—Ä</th>
                        <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                        <th>–¶–µ–Ω–∞</th>
                        <th>–û—Å—Ç–∞—Ç–æ–∫</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th style='width: 240px;'>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($products as $product): ?>
                        <tr data-category='<?= $product['category_id'] ?>' data-name='<?= strtolower($product['name']) ?>' data-id='<?= $product['id'] ?>'>
                            <td>
                                <input type='checkbox' class='product-checkbox' value='<?= $product['id'] ?>'>
                            </td>
                            <td>
                                <div style='width: 50px; height: 50px; border-radius: var(--border-radius); overflow: hidden; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center;'>
                                    <?php if (!empty($product['images'])): ?>
                                        <img src='<?= htmlspecialchars($product['images'][0]) ?>' alt='<?= htmlspecialchars($product['name']) ?>' style='width: 100%; height: 100%; object-fit: cover;'>
                                    <?php else: ?>
                                        <i class='fas fa-image' style='color: var(--text-muted);'></i>
                                    <?php endif; ?>
                                </div>
                            </td>
                            <td>
                                <div style='font-weight: 600; margin-bottom: 4px;'><?= htmlspecialchars(mb_substr($product['name'], 0, 50)) ?><?= mb_strlen($product['name']) > 50 ? '...' : '' ?></div>
                                <div style='font-size: 12px; color: var(--text-muted);'>
                                    –ê—Ä—Ç–∏–∫—É–ª: <?= $product['sku'] ?> | ID: <?= $product['id'] ?>
                                </div>
                                <div style='margin-top: 4px;'>
                                    <?php if ($product['is_featured']): ?>
                                        <span class='status-badge' style='background: gold; color: white;'>üî• –•–ò–¢</span>
                                    <?php endif; ?>
                                    <?php if ($product['is_new']): ?>
                                        <span class='status-badge status-new'>‚ú® –ù–û–í–ò–ù–ö–ê</span>
                                    <?php endif; ?>
                                </div>
                            </td>
                            <td>
                                <span class='status-badge' style='background: rgba(102, 126, 234, 0.1); color: var(--primary-color);'>
                                    <?= htmlspecialchars($product['category']) ?>
                                </span>
                            </td>
                            <td>
                                <div style='font-weight: 600; color: var(--success-color);'><?= number_format($product['price'], 0, '', ' ') ?> ‚ÇΩ</div>
                                <?php if ($product['old_price']): ?>
                                    <div style='font-size: 11px; color: var(--text-muted); text-decoration: line-through;'>
                                        <?= number_format($product['old_price'], 0, '', ' ') ?> ‚ÇΩ
                                    </div>
                                <?php endif; ?>
                            </td>
                            <td>
                                <span class='status-badge <?= $product['stock'] <= 0 ? 'status-cancelled' : ($product['stock'] <= 5 ? 'status-processing' : 'status-completed') ?>' style='<?= $product['stock'] <= 0 ? 'background: rgba(231, 76, 60, 0.1); color: var(--danger-color);' : ($product['stock'] <= 5 ? 'background: rgba(243, 156, 18, 0.1); color: var(--warning-color);' : 'background: rgba(46, 204, 113, 0.1); color: var(--success-color);') ?>'>
                                    <?= $product['stock'] ?> —à—Ç
                                </span>
                            </td>
                            <td>
                                <label style='display: flex; align-items: center; cursor: pointer;'>
                                    <input type='checkbox' <?= $product['is_active'] ? 'checked' : '' ?>
                                           onchange='toggleProductStatus(<?= $product['id'] ?>, this.checked)'
                                           style='margin-right: 8px;'>
                                    <span class='status-badge <?= $product['is_active'] ? 'status-active' : 'status-inactive' ?>'>
                                        <?= $product['is_active'] ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–°–∫—Ä—ã—Ç' ?>
                                    </span>
                                </label>
                            </td>
                            <td>
                                <div style='display: flex; gap: 4px; flex-wrap: wrap;'>
                                    <button class='btn btn-primary btn-sm' onclick='openMegaModal(<?= $product['id'] ?>)' title='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'>
                                        <i class='fas fa-edit'></i>
                                    </button>
                                    <button class='btn btn-success btn-sm' onclick='duplicateProduct(<?= $product['id'] ?>)' title='–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å'>
                                        <i class='fas fa-copy'></i>
                                    </button>
                                    <button class='btn btn-info btn-sm' onclick='window.open("index.php?page=product&id=<?= $product['id'] ?>", "_blank")' title='–ü—Ä–æ—Å–º–æ—Ç—Ä'>
                                        <i class='fas fa-eye'></i>
                                    </button>
                                    <button class='btn btn-danger btn-sm' onclick='deleteProduct(<?= $product['id'] ?>)' title='–£–¥–∞–ª–∏—Ç—å'>
                                        <i class='fas fa-trash'></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
    </div>
    <?php
}

// –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
function renderCategoriesSection($data) { /* ... */ }
function renderOrdersSection($data) { /* ... */ }
function renderReviewsSection($data) { /* ... */ }
function renderNewsSection($data) { /* ... */ }
function renderSettingsSection($data) { /* ... */ }
function renderLogsSection($data) { /* ... */ }
function renderPagesSection($data) { /* ... */ }

function renderDefaultSection($section, $data) {
    ?>
    <div class='content-card' style='text-align: center; max-width: 600px; margin: 0 auto;'>
        <div class='content-card-body'>
            <div style='font-size: 64px; margin-bottom: 24px; opacity: 0.6;'>‚öôÔ∏è</div>
            <h3>–†–∞–∑–¥–µ–ª '<?= ucfirst($section) ?>' –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</h3>
            <p style='margin: 20px 0; color: var(--text-secondary); line-height: 1.6;'>
                –≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.<br>
                –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è.
            </p>
            <a href='admin.php' class='btn btn-primary'>
                <i class='fas fa-arrow-left'></i>
                –ù–∞ –≥–ª–∞–≤–Ω—É—é
            </a>
        </div>
    </div>
    <?php
}

// –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∞–¥–º–∏–Ω–∫–∏
if (isset($_SESSION['admin_logged_in'])) {
    logAdminAction('SYSTEM', '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∏–ª —Ä–∞–∑–¥–µ–ª: ' . $section);
}
?>
