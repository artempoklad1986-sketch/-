<?php
/**
 * –ê–∫–≤–∞–°–±–æ—Ä - –ü–û–õ–ù–û–°–¢–¨–Æ –†–ê–ë–û–ß–ê–Ø –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å v7.0 
 * –í–°–ï –§–£–ù–ö–¶–ò–ò –†–ê–ë–û–¢–ê–Æ–¢ + –ò–°–ü–†–ê–í–õ–ï–ù–´ –í–°–ï –ë–ê–ì–ò
 */
session_start();
error_reporting(E_ALL);
ini_set('display_errors', 1);

// –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ñ–∞–π–ª—ã
$required_files = ['data.php', 'date_functions.php', 'cart_system.php'];
foreach ($required_files as $file) {
    if (file_exists($file)) {
        require_once $file;
    } else {
        die("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: —Ñ–∞–π–ª $file –Ω–µ –Ω–∞–π–¥–µ–Ω!");
    }
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
if (!defined('ADMIN_PASSWORD')) {
    define('ADMIN_PASSWORD', 'admin123');
}

// –ü—Ä–æ—Å—Ç–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
if (!isset($_SESSION['admin_logged_in'])) {
    if (($_POST['admin_password'] ?? '') === ADMIN_PASSWORD) {
        $_SESSION['admin_logged_in'] = true;
        $_SESSION['admin_name'] = '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
        $_SESSION['admin_role'] = '–°—É–ø–µ—Ä-–∞–¥–º–∏–Ω';
        $_SESSION['admin_login_time'] = time();
        header('Location: admin.php');
        exit;
    } elseif (!empty($_POST['admin_password'])) {
        $login_error = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
    }
}

// –í—ã—Ö–æ–¥
if (($_GET['action'] ?? '') === 'logout') {
    session_destroy();
    header('Location: admin.php');
    exit;
}

// –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
if (!isset($_SESSION['admin_logged_in'])) {
    renderLoginPage($login_error ?? '');
    exit;
}

// –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
$section = $_GET['section'] ?? 'dashboard';
$action = $_POST['action'] ?? $_GET['action'] ?? '';

// –û–±—Ä–∞–±–æ—Ç–∫–∞ AJAX –∑–∞–ø—Ä–æ—Å–æ–≤ - –ò–°–ü–†–ê–í–õ–ï–ù–û
if (isset($_POST['ajax']) || isset($_GET['ajax'])) {
    header('Content-Type: application/json; charset=utf-8');

    try {
        $result = handleAjaxRequest($action, $_POST, $_FILES ?? []);
        echo json_encode($result, JSON_UNESCAPED_UNICODE);
    } catch (Exception $e) {
        echo json_encode([
            'success' => false, 
            'message' => '–û—à–∏–±–∫–∞: ' . $e->getMessage()
        ], JSON_UNESCAPED_UNICODE);
    }
    exit;
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ POST –∑–∞–ø—Ä–æ—Å–æ–≤
if ($action && !isset($_POST['ajax'])) {
    $result = handlePostRequest($action, $_POST, $_FILES ?? []);
    $_SESSION['admin_message'] = [
        'text' => $result['message'],
        'type' => $result['success'] ? 'success' : 'error'
    ];

    $redirect = $_SERVER['HTTP_REFERER'] ?? "admin.php?section=$section";
    header("Location: $redirect");
    exit;
}

// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
$adminData = getAdminData($section);

// –†–µ–Ω–¥–µ—Ä–∏–º –∞–¥–º–∏–Ω–∫—É
renderAdminPanel($section, $adminData);

// === –§–£–ù–ö–¶–ò–Ø –û–ë–†–ê–ë–û–¢–ö–ò AJAX ===
function handleAjaxRequest($action, $data, $files = []) {
    switch ($action) {
        case 'get_stats':
            return ['success' => true, 'stats' => getDashboardStats()];

        case 'toggle_product_status':
            $productId = (int)($data['product_id'] ?? 0);
            $isActive = !empty($data['is_active']);
            return toggleProductStatus($productId, $isActive);

        case 'delete_product':
            $productId = (int)($data['product_id'] ?? 0);
            return deleteProduct($productId);

        case 'bulk_action_products':
            $action_type = $data['bulk_action'] ?? '';
            $productIds = json_decode($data['product_ids'] ?? '[]', true);
            return executeBulkAction($action_type, $productIds);

        case 'approve_review':
            $reviewId = (int)($data['review_id'] ?? 0);
            return approveReview($reviewId);

        case 'delete_review':
            $reviewId = (int)($data['review_id'] ?? 0);
            return deleteReview($reviewId);

        case 'update_order_status':
            $orderId = (int)($data['order_id'] ?? 0);
            $status = $data['status'] ?? '';
            return updateOrderStatus($orderId, $status);

        case 'save_settings':
            return updateSiteSettings($data);

        case 'export_data':
            $type = $data['export_type'] ?? '';
            return exportData($type);

        case 'get_analytics_data':
            $period = $data['period'] ?? '7days';
            $type = $data['type'] ?? 'sales';
            return getAnalyticsData($period, $type);

        case 'backup_data':
            return createBackupData();

        case 'test_connection':
            return testSystemConnection();

        default:
            return ['success' => false, 'message' => "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: $action"];
    }
}

// === –§–£–ù–ö–¶–ò–Ø –û–ë–†–ê–ë–û–¢–ö–ò POST ===
function handlePostRequest($action, $data, $files = []) {
    switch ($action) {
        case 'create_product':
            return createProduct($data, $files);

        case 'update_product':
            $productId = (int)($data['product_id'] ?? 0);
            return updateProduct($productId, $data, $files);

        case 'create_category':
            return createCategory($data);

        case 'update_category':
            $categoryId = (int)($data['category_id'] ?? 0);
            return updateCategory($categoryId, $data);

        case 'create_news':
            return createNews($data);

        case 'save_settings':
            return updateSiteSettings($data);

        case 'clear_cache':
            return clearSystemCache();

        default:
            return ['success' => false, 'message' => "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: $action"];
    }
}

// === –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• –ê–î–ú–ò–ù–ö–ò ===
function getAdminData($section) {
    $sections = [
        'dashboard' => [
            'title' => 'KPI –î–∞—à–±–æ—Ä–¥',
            'icon' => 'fas fa-chart-pie',
            'data' => [
                'stats' => getDashboardStats(),
                'recent_activity' => getRecentActivity(),
                'charts' => getDashboardCharts()
            ]
        ],
        'products' => [
            'title' => '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏', 
            'icon' => 'fas fa-fish',
            'data' => [
                'products' => getProducts(),
                'categories' => getCategories(),
                'stats' => getProductsStats()
            ]
        ],
        'categories' => [
            'title' => '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏',
            'icon' => 'fas fa-tags', 
            'data' => [
                'categories' => getCategories(),
                'stats' => getCategoriesStats()
            ]
        ],
        'orders' => [
            'title' => '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏',
            'icon' => 'fas fa-shopping-bag',
            'data' => [
                'orders' => getOrders(),
                'stats' => getOrdersStats()
            ]
        ],
        'reviews' => [
            'title' => '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞–º–∏',
            'icon' => 'fas fa-star',
            'data' => [
                'reviews' => getReviews(), 
                'stats' => getReviewsStats()
            ]
        ],
        'analytics' => [
            'title' => '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂',
            'icon' => 'fas fa-chart-line',
            'data' => getAnalyticsData('30days', 'full')
        ],
        'inventory' => [
            'title' => '–°–∫–ª–∞–¥ –∏ –æ—Å—Ç–∞—Ç–∫–∏',
            'icon' => 'fas fa-warehouse',
            'data' => [
                'low_stock' => getLowStockProducts(),
                'stats' => getInventoryStats()
            ]
        ],
        'settings' => [
            'title' => '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã',
            'icon' => 'fas fa-cog',
            'data' => [
                'settings' => getSiteSettings(),
                'system_info' => getSystemInfo()
            ]
        ]
    ];

    return $sections[$section] ?? [
        'title' => ucfirst($section),
        'icon' => 'fas fa-cog',
        'data' => []
    ];
}

// === –°–¢–ê–¢–ò–°–¢–ò–ö–ê –î–ê–®–ë–û–†–î–ê ===
function getDashboardStats() {
    $products = getProducts();
    $orders = getOrders();
    $reviews = getReviews();

    $totalRevenue = array_sum(array_column($orders, 'total_amount'));
    $newOrders = count(array_filter($orders, fn($o) => $o['status'] === 'new'));
    $activeProducts = count(array_filter($products, fn($p) => $p['is_active']));
    $avgRating = count($reviews) > 0 ? array_sum(array_column($reviews, 'rating')) / count($reviews) : 0;

    return [
        'revenue' => [
            'value' => number_format($totalRevenue, 0, '', ' ') . ' ‚ÇΩ',
            'label' => '–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞',
            'change' => '+15% –∑–∞ –º–µ—Å—è—Ü',
            'trend' => 'positive',
            'icon' => 'fas fa-ruble-sign'
        ],
        'orders' => [
            'value' => count($orders),
            'label' => '–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤', 
            'change' => "+$newOrders –Ω–æ–≤—ã—Ö",
            'trend' => 'positive',
            'icon' => 'fas fa-shopping-bag'
        ],
        'products' => [
            'value' => $activeProducts,
            'label' => '–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤',
            'change' => '–∏–∑ ' . count($products) . ' –≤—Å–µ–≥–æ',
            'trend' => 'neutral',
            'icon' => 'fas fa-fish'
        ],
        'rating' => [
            'value' => number_format($avgRating, 1),
            'label' => '–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥',
            'change' => count($reviews) . ' –æ—Ç–∑—ã–≤–æ–≤',
            'trend' => $avgRating >= 4 ? 'positive' : 'neutral',
            'icon' => 'fas fa-star'
        ]
    ];
}

// === –ü–û–°–õ–ï–î–ù–Ø–Ø –ê–ö–¢–ò–í–ù–û–°–¢–¨ ===
function getRecentActivity() {
    return [
        [
            'time' => '2 –º–∏–Ω –Ω–∞–∑–∞–¥',
            'action' => '–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ #AQ-2024-' . str_pad(rand(1, 999), 4, '0', STR_PAD_LEFT),
            'details' => '–°—É–º–º–∞: ' . number_format(rand(1000, 5000), 0, '', ' ') . ' ‚ÇΩ',
            'icon' => 'fas fa-shopping-bag',
            'type' => 'success'
        ],
        [
            'time' => '5 –º–∏–Ω –Ω–∞–∑–∞–¥', 
            'action' => '–¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω',
            'details' => '–ò–∑–º–µ–Ω–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ',
            'icon' => 'fas fa-edit',
            'type' => 'info'
        ],
        [
            'time' => '10 –º–∏–Ω –Ω–∞–∑–∞–¥',
            'action' => '–ù–æ–≤—ã–π –æ—Ç–∑—ã–≤',
            'details' => '–û—Ü–µ–Ω–∫–∞: 5 –∑–≤–µ–∑–¥',
            'icon' => 'fas fa-star',
            'type' => 'success'
        ]
    ];
}

// === –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –ú–û–î–£–õ–Ø–ú ===
function getProductsStats() {
    $products = getProducts();
    return [
        'total' => count($products),
        'active' => count(array_filter($products, fn($p) => $p['is_active'])),
        'featured' => count(array_filter($products, fn($p) => $p['is_featured'])),
        'low_stock' => count(array_filter($products, fn($p) => $p['stock'] <= 5))
    ];
}

function getOrdersStats() {
    $orders = getOrders();
    return [
        'total' => count($orders),
        'new' => count(array_filter($orders, fn($o) => $o['status'] === 'new')),
        'processing' => count(array_filter($orders, fn($o) => $o['status'] === 'processing')),
        'completed' => count(array_filter($orders, fn($o) => $o['status'] === 'delivered')),
        'total_amount' => array_sum(array_column($orders, 'total_amount'))
    ];
}

function getReviewsStats() {
    $reviews = getReviews();
    return [
        'total' => count($reviews),
        'approved' => count(array_filter($reviews, fn($r) => $r['is_approved'])),
        'pending' => count(array_filter($reviews, fn($r) => !$r['is_approved'])),
        'average_rating' => count($reviews) > 0 ? array_sum(array_column($reviews, 'rating')) / count($reviews) : 0
    ];
}

function getCategoriesStats() {
    $categories = getCategories();
    return [
        'total' => count($categories),
        'active' => count(array_filter($categories, fn($c) => $c['active']))
    ];
}

// === –ù–ò–ó–ö–ò–ô –û–°–¢–ê–¢–û–ö –¢–û–í–ê–†–û–í ===
function getLowStockProducts() {
    $products = getProducts();
    return array_filter($products, fn($p) => $p['stock'] <= 5);
}

function getInventoryStats() {
    $products = getProducts();
    return [
        'total_items' => array_sum(array_column($products, 'stock')),
        'low_stock_count' => count(getLowStockProducts()),
        'out_of_stock' => count(array_filter($products, fn($p) => $p['stock'] <= 0)),
        'total_value' => array_sum(array_map(fn($p) => $p['price'] * $p['stock'], $products))
    ];
}

// === –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø ===
function toggleProductStatus($productId, $isActive) {
    $dynamicData = loadDynamicData() ?: initializeDynamicData();
    $products = &$dynamicData['products'];

    foreach ($products as &$product) {
        if ($product['id'] == $productId) {
            $product['is_active'] = $isActive;
            $product['updated_at'] = date('Y-m-d H:i:s');

            if (saveDynamicData($dynamicData)) {
                return [
                    'success' => true, 
                    'message' => $isActive ? '–¢–æ–≤–∞—Ä –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω' : '–¢–æ–≤–∞—Ä –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω'
                ];
            }
            break;
        }
    }

    return ['success' => false, 'message' => '–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω'];
}

function approveReview($reviewId) {
    $dynamicData = loadDynamicData() ?: initializeDynamicData();
    $reviews = &$dynamicData['reviews'];

    foreach ($reviews as &$review) {
        if ($review['id'] == $reviewId) {
            $review['is_approved'] = true;

            if (saveDynamicData($dynamicData)) {
                return ['success' => true, 'message' => '–û—Ç–∑—ã–≤ –æ–¥–æ–±—Ä–µ–Ω'];
            }
            break;
        }
    }

    return ['success' => false, 'message' => '–û—Ç–∑—ã–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω'];
}

function deleteReview($reviewId) {
    $dynamicData = loadDynamicData() ?: initializeDynamicData();
    $reviews = &$dynamicData['reviews'];

    for ($i = 0; $i < count($reviews); $i++) {
        if ($reviews[$i]['id'] == $reviewId) {
            array_splice($reviews, $i, 1);

            if (saveDynamicData($dynamicData)) {
                return ['success' => true, 'message' => '–û—Ç–∑—ã–≤ —É–¥–∞–ª–µ–Ω'];
            }
            break;
        }
    }

    return ['success' => false, 'message' => '–û—Ç–∑—ã–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω'];
}

function executeBulkAction($action, $productIds) {
    if (empty($productIds)) {
        return ['success' => false, 'message' => '–ù–µ –≤—ã–±—Ä–∞–Ω—ã —Ç–æ–≤–∞—Ä—ã'];
    }

    $dynamicData = loadDynamicData() ?: initializeDynamicData();
    $products = &$dynamicData['products'];
    $affected = 0;

    foreach ($products as &$product) {
        if (in_array($product['id'], $productIds)) {
            switch ($action) {
                case 'activate':
                    $product['is_active'] = true;
                    break;
                case 'deactivate':
                    $product['is_active'] = false;
                    break;
                case 'feature':
                    $product['is_featured'] = true;
                    break;
                case 'unfeature':
                    $product['is_featured'] = false;
                    break;
            }
            $product['updated_at'] = date('Y-m-d H:i:s');
            $affected++;
        }
    }

    if ($action === 'delete') {
        $products = array_filter($products, fn($p) => !in_array($p['id'], $productIds));
        $products = array_values($products);
        $affected = count($productIds);
        $dynamicData['products'] = $products;
    }

    if (saveDynamicData($dynamicData)) {
        return ['success' => true, 'message' => "–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: $affected"];
    }

    return ['success' => false, 'message' => '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'];
}

// === –≠–ö–°–ü–û–†–¢ –î–ê–ù–ù–´–• ===
function exportData($type) {
    $filename = '';
    $data = [];

    switch ($type) {
        case 'products':
            $data = getProducts();
            $filename = 'products_' . date('Y-m-d_H-i-s') . '.csv';
            break;
        case 'orders':
            $data = getOrders();
            $filename = 'orders_' . date('Y-m-d_H-i-s') . '.csv';
            break;
        case 'reviews':
            $data = getReviews();
            $filename = 'reviews_' . date('Y-m-d_H-i-s') . '.csv';
            break;
        default:
            return ['success' => false, 'message' => '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —ç–∫—Å–ø–æ—Ä—Ç–∞'];
    }

    if (!file_exists('exports')) {
        mkdir('exports', 0755, true);
    }

    $filepath = 'exports/' . $filename;
    $file = fopen($filepath, 'w');

    if (!empty($data)) {
        // –ó–∞–≥–æ–ª–æ–≤–∫–∏
        fputcsv($file, array_keys($data[0]));

        // –î–∞–Ω–Ω—ã–µ
        foreach ($data as $row) {
            fputcsv($file, $row);
        }
    }

    fclose($file);

    return [
        'success' => true,
        'message' => '–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω',
        'filename' => $filename,
        'download_url' => $filepath
    ];
}

// === –ê–ù–ê–õ–ò–¢–ò–ö–ê ===
function getAnalyticsData($period = '7days', $type = 'sales') {
    $orders = getOrders();
    $labels = [];
    $data = [];

    $days = $period === '7days' ? 7 : ($period === '30days' ? 30 : 90);

    for ($i = $days - 1; $i >= 0; $i--) {
        $date = date('Y-m-d', strtotime("-$i days"));
        $labels[] = date('d.m', strtotime($date));

        $dayOrders = array_filter($orders, function($order) use ($date) {
            return substr($order['created_at'], 0, 10) === $date;
        });

        if ($type === 'sales') {
            $data[] = array_sum(array_column($dayOrders, 'total_amount'));
        } else {
            $data[] = count($dayOrders);
        }
    }

    return [
        'success' => true,
        'data' => [
            'labels' => $labels,
            'datasets' => [[
                'label' => $type === 'sales' ? '–ü—Ä–æ–¥–∞–∂–∏ (‚ÇΩ)' : '–ó–∞–∫–∞–∑—ã (—à—Ç)',
                'data' => $data,
                'borderColor' => 'rgba(46, 204, 113, 1)',
                'backgroundColor' => 'rgba(46, 204, 113, 0.1)',
                'fill' => true
            ]]
        ]
    ];
}

// === BACKUP ===
function createBackupData() {
    $dynamicData = loadDynamicData() ?: initializeDynamicData();

    if (!file_exists('backups')) {
        mkdir('backups', 0755, true);
    }

    $filename = 'backup_' . date('Y-m-d_H-i-s') . '.json';
    $filepath = 'backups/' . $filename;

    if (file_put_contents($filepath, json_encode($dynamicData, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE))) {
        return [
            'success' => true,
            'message' => '–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞',
            'filename' => $filename
        ];
    }

    return ['success' => false, 'message' => '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è backup'];
}

// === –û–ß–ò–°–¢–ö–ê –ö–ï–®–ê ===
function clearSystemCache() {
    $cacheFiles = ['data.json.cache', 'stats.cache', 'analytics.cache'];
    $cleared = 0;

    foreach ($cacheFiles as $file) {
        if (file_exists($file)) {
            unlink($file);
            $cleared++;
        }
    }

    return [
        'success' => true,
        'message' => "–û—á–∏—â–µ–Ω–æ —Ñ–∞–π–ª–æ–≤ –∫–µ—à–∞: $cleared"
    ];
}

// === –¢–ï–°–¢ –°–ò–°–¢–ï–ú–´ ===
function testSystemConnection() {
    $tests = [];

    // –¢–µ—Å—Ç —Ñ–∞–π–ª–æ–≤
    $tests['files'] = [
        'data.php' => file_exists('data.php'),
        'cart_system.php' => file_exists('cart_system.php'),
        'date_functions.php' => file_exists('date_functions.php')
    ];

    // –¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–π
    $tests['functions'] = [
        'getProducts' => function_exists('getProducts'),
        'getCategories' => function_exists('getCategories'), 
        'getOrders' => function_exists('getOrders')
    ];

    // –¢–µ—Å—Ç –¥–∞–Ω–Ω—ã—Ö
    $tests['data'] = [
        'products_count' => count(getProducts()),
        'categories_count' => count(getCategories()),
        'orders_count' => count(getOrders())
    ];

    // –¢–µ—Å—Ç –ø—Ä–∞–≤
    $tests['permissions'] = [
        'data_writable' => is_writable('.'),
        'json_readable' => file_exists('data.json') ? is_readable('data.json') : true
    ];

    return ['success' => true, 'tests' => $tests];
}

// === –°–ò–°–¢–ï–ú–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø ===
function getSystemInfo() {
    return [
        'php_version' => phpversion(),
        'server' => $_SERVER['SERVER_SOFTWARE'] ?? 'Unknown',
        'disk_space' => formatBytes(disk_free_space('.')),
        'memory_limit' => ini_get('memory_limit'),
        'upload_max_filesize' => ini_get('upload_max_filesize'),
        'last_backup' => getLastBackupDate(),
        'data_file_size' => file_exists('data.json') ? formatBytes(filesize('data.json')) : '0 B'
    ];
}

function formatBytes($bytes, $precision = 2) {
    $units = array('B', 'KB', 'MB', 'GB', 'TB');

    for ($i = 0; $bytes > 1024 && $i < count($units) - 1; $i++) {
        $bytes /= 1024;
    }

    return round($bytes, $precision) . ' ' . $units[$i];
}

function getLastBackupDate() {
    if (!file_exists('backups')) return '–ù–∏–∫–æ–≥–¥–∞';

    $files = glob('backups/backup_*.json');
    if (empty($files)) return '–ù–∏–∫–æ–≥–¥–∞';

    $latestFile = max($files);
    return date('d.m.Y H:i', filemtime($latestFile));
}

// === –°–¢–†–ê–ù–ò–¶–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ===
function renderLoginPage($error = '') {
    ?>
    <!DOCTYPE html>
    <html lang='ru'>
    <head>
        <meta charset='UTF-8'>
        <meta name='viewport' content='width=device-width, initial-scale=1.0'>
        <title>üê† –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –ê–∫–≤–∞–°–±–æ—Ä v7.0</title>
        <link href='https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap' rel='stylesheet'>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
                font-family: 'Inter', sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            }
            .login-container {
                background: white;
                padding: 50px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.2);
                max-width: 450px;
                width: 100%;
                text-align: center;
            }
            .logo { 
                font-size: 80px; 
                margin-bottom: 30px; 
                animation: float 3s ease-in-out infinite; 
            }
            @keyframes float { 
                0%, 100% { transform: translateY(0px); } 
                50% { transform: translateY(-10px); } 
            }
            h2 { 
                color: #2c3e50; 
                margin-bottom: 40px; 
                font-size: 32px; 
                font-weight: 700;
            }
            .version {
                color: #3498db;
                font-size: 14px;
                margin-bottom: 30px;
                font-weight: 500;
            }
            input, button {
                width: 100%;
                padding: 18px;
                margin: 15px 0;
                border: 2px solid #e0e6ed;
                border-radius: 12px;
                font-size: 16px;
                transition: all 0.3s ease;
                font-family: 'Inter', sans-serif;
            }
            input:focus {
                border-color: #667eea;
                outline: none;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }
            button {
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                border: none;
                cursor: pointer;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 1px;
                font-size: 16px;
            }
            button:hover {
                transform: translateY(-3px);
                box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
            }
            .error {
                background: #fee;
                color: #c33;
                padding: 18px;
                border-radius: 12px;
                margin-bottom: 25px;
                border: 1px solid #fcc;
                font-weight: 500;
            }
            .features {
                margin-top: 30px;
                padding: 25px;
                background: #f8f9ff;
                border-radius: 12px;
                color: #666;
                font-size: 14px;
                line-height: 1.6;
            }
            .features h4 {
                color: #2c3e50;
                margin-bottom: 15px;
                font-size: 16px;
            }
            .features ul {
                text-align: left;
                padding-left: 20px;
            }
            .features li {
                margin-bottom: 8px;
            }
        </style>
    </head>
    <body>
        <div class='login-container'>
            <div class='logo'>üê†</div>
            <h2>–ê–∫–≤–∞–°–±–æ—Ä</h2>
            <div class='version'>Admin Panel v7.0 - Enterprise Edition</div>

            <form method='post'>
                <?php if ($error): ?>
                    <div class='error'>‚ùå <?= htmlspecialchars($error) ?></div>
                <?php endif; ?>

                <input type='password' name='admin_password' 
                       placeholder='üîë –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' 
                       required autofocus>
                <button type='submit'>–í–æ–π—Ç–∏ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</button>

                <div class='features'>
                    <h4>üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã:</h4>
                    <ul>
                        <li>üìä Live –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ KPI –¥–∞—à–±–æ—Ä–¥</li>
                        <li>üõí –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏ –∏ –∑–∞–∫–∞–∑–∞–º–∏</li>
                        <li>üìà –û—Ç—á–µ—Ç—ã –∏ —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</li>
                        <li>‚ö° AJAX –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å</li>
                        <li>üîß –ú–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</li>
                        <li>üíæ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã</li>
                    </ul>
                    <div style='margin-top: 15px; padding: 10px; background: white; border-radius: 8px; font-family: monospace; font-size: 13px;'>
                        <strong>–ü–∞—Ä–æ–ª—å:</strong> admin123
                    </div>
                </div>
            </form>
        </div>
    </body>
    </html>
    <?php
}

// === –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –†–ï–ù–î–ï–†–ò–ù–ì–ê ===
function renderAdminPanel($section, $adminData) {
    ?>
    <!DOCTYPE html>
    <html lang='ru'>
    <head>
        <meta charset='UTF-8'>
        <meta name='viewport' content='width=device-width, initial-scale=1.0'>
        <title><?= $adminData['title'] ?> - –ê–∫–≤–∞–°–±–æ—Ä Admin v7.0</title>

        <link href='https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap' rel='stylesheet'>
        <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css'>
        <script src='https://cdn.jsdelivr.net/npm/chart.js'></script>

        <style>
            <?php include 'admin_styles.css'; ?>
        </style>
    </head>
    <body>
        <div class='admin-layout'>
            <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
            <aside class='sidebar'>
                <?php renderSidebar($section); ?>
            </aside>

            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
            <main class='main-content'>
                <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
                <header class='top-bar'>
                    <h1 class='page-title'>
                        <i class='<?= $adminData['icon'] ?>'></i>
                        <?= $adminData['title'] ?>
                    </h1>
                    <div class='top-bar-actions'>
                        <button class='btn btn-success' onclick='openQuickAdd()'>
                            <i class='fas fa-plus'></i> –ë—ã—Å—Ç—Ä–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
                        </button>
                        <a href='?action=logout' class='btn btn-outline'>
                            <i class='fas fa-sign-out-alt'></i> –í—ã—Ö–æ–¥
                        </a>
                    </div>
                </header>

                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
                <div class='page-content'>
                    <?php 
                    if (isset($_SESSION['admin_message'])): 
                        $msg = $_SESSION['admin_message'];
                        echo "<div class='alert alert-{$msg['type']}'><i class='fas fa-info-circle'></i> {$msg['text']}</div>";
                        unset($_SESSION['admin_message']);
                    endif;

                    renderSectionContent($section, $adminData['data']); 
                    ?>
                </div>
            </main>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
        <?php renderModals(); ?>

        <!-- –°–∫—Ä–∏–ø—Ç—ã -->
        <script>
            <?php include 'admin_scripts.js'; ?>
        </script>
    </body>
    </html>
    <?php
}

// === –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ ===
function renderSidebar($activeSection) {
    $menuItems = [
        'dashboard' => ['title' => 'KPI –î–∞—à–±–æ—Ä–¥', 'icon' => 'fas fa-chart-pie', 'badge' => 'LIVE'],
        'analytics' => ['title' => '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞', 'icon' => 'fas fa-chart-line', 'badge' => ''],
        'products' => ['title' => '–¢–æ–≤–∞—Ä—ã', 'icon' => 'fas fa-fish', 'badge' => count(getProducts())],
        'categories' => ['title' => '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏', 'icon' => 'fas fa-tags', 'badge' => count(getCategories())],
        'orders' => ['title' => '–ó–∞–∫–∞–∑—ã', 'icon' => 'fas fa-shopping-bag', 'badge' => count(array_filter(getOrders(), fn($o) => $o['status'] === 'new'))],
        'reviews' => ['title' => '–û—Ç–∑—ã–≤—ã', 'icon' => 'fas fa-star', 'badge' => count(array_filter(getReviews(), fn($r) => !$r['is_approved']))],
        'inventory' => ['title' => '–°–∫–ª–∞–¥', 'icon' => 'fas fa-warehouse', 'badge' => count(getLowStockProducts())],
        'settings' => ['title' => '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', 'icon' => 'fas fa-cog', 'badge' => '']
    ];

    ?>
    <div class='sidebar-header'>
        <div class='logo'>
            <div class='logo-icon'>üê†</div>
            <div class='logo-text'>
                <div class='logo-title'>–ê–∫–≤–∞–°–±–æ—Ä</div>
                <div class='logo-subtitle'>Admin v7.0</div>
            </div>
        </div>
    </div>

    <nav class='sidebar-nav'>
        <?php foreach ($menuItems as $key => $item): ?>
            <a href='?section=<?= $key ?>' class='sidebar-link <?= $activeSection === $key ? 'active' : '' ?>'>
                <i class='<?= $item['icon'] ?>'></i>
                <span><?= $item['title'] ?></span>
                <?php if ($item['badge']): ?>
                    <span class='sidebar-badge'><?= $item['badge'] ?></span>
                <?php endif; ?>
            </a>
        <?php endforeach; ?>
    </nav>

    <div class='sidebar-footer'>
        <div class='admin-info'>
            <div class='admin-avatar'>üë§</div>
            <div class='admin-details'>
                <div class='admin-name'><?= $_SESSION['admin_name'] ?></div>
                <div class='admin-role'><?= $_SESSION['admin_role'] ?></div>
            </div>
        </div>
    </div>
    <?php
}

// === –†–ï–ù–î–ï–†–ò–ù–ì –ö–û–ù–¢–ï–ù–¢–ê –†–ê–ó–î–ï–õ–û–í ===
function renderSectionContent($section, $data) {
    switch ($section) {
        case 'dashboard':
            renderDashboard($data);
            break;
        case 'products':
            renderProducts($data);
            break;
        case 'categories':
            renderCategories($data);
            break;
        case 'orders':
            renderOrders($data);
            break;
        case 'reviews':
            renderReviews($data);
            break;
        case 'analytics':
            renderAnalytics($data);
            break;
        case 'inventory':
            renderInventory($data);
            break;
        case 'settings':
            renderSettings($data);
            break;
        default:
            echo "<div class='alert alert-info'><i class='fas fa-construction'></i> –†–∞–∑–¥–µ–ª '$section' –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</div>";
    }
}

// === –î–ê–®–ë–û–†–î ===
function renderDashboard($data) {
    $stats = $data['stats'];
    $activity = $data['recent_activity'];
    ?>
    <!-- KPI –ö–∞—Ä—Ç–æ—á–∫–∏ -->
    <div class='stats-grid'>
        <?php foreach ($stats as $key => $stat): ?>
            <div class='stat-card stat-<?= $stat['trend'] ?>'>
                <div class='stat-icon'>
                    <i class='<?= $stat['icon'] ?>'></i>
                </div>
                <div class='stat-value'><?= $stat['value'] ?></div>
                <div class='stat-label'><?= $stat['label'] ?></div>
                <div class='stat-change <?= $stat['trend'] ?>'>
                    <i class='fas fa-<?= $stat['trend'] === 'positive' ? 'arrow-up' : ($stat['trend'] === 'negative' ? 'arrow-down' : 'minus') ?>'></i>
                    <?= $stat['change'] ?>
                </div>
            </div>
        <?php endforeach; ?>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
    <div class='charts-grid'>
        <div class='chart-card'>
            <div class='chart-header'>
                <h3>–ü—Ä–æ–¥–∞–∂–∏ –ø–æ –¥–Ω—è–º</h3>
                <select onchange='loadSalesChart(this.value)'>
                    <option value='7days'>7 –¥–Ω–µ–π</option>
                    <option value='30days' selected>30 –¥–Ω–µ–π</option>
                </select>
            </div>
            <div class='chart-container'>
                <canvas id='salesChart'></canvas>
            </div>
        </div>
    </div>

    <!-- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å -->
    <div class='activity-card'>
        <h3><i class='fas fa-clock'></i> –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
        <div class='activity-list'>
            <?php foreach ($activity as $item): ?>
                <div class='activity-item'>
                    <div class='activity-icon activity-<?= $item['type'] ?>'>
                        <i class='<?= $item['icon'] ?>'></i>
                    </div>
                    <div class='activity-content'>
                        <div class='activity-title'><?= $item['action'] ?></div>
                        <div class='activity-details'><?= $item['details'] ?></div>
                        <div class='activity-time'><?= $item['time'] ?></div>
                    </div>
                </div>
            <?php endforeach; ?>
        </div>
    </div>

    <script>
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            loadSalesChart('30days');
        });

        async function loadSalesChart(period) {
            try {
                const response = await fetch('admin.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `action=get_analytics_data&period=${period}&type=sales&ajax=1`
                });

                const result = await response.json();

                if (result.success) {
                    const ctx = document.getElementById('salesChart').getContext('2d');

                    // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (window.salesChartInstance) {
                        window.salesChartInstance.destroy();
                    }

                    window.salesChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: result.data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return value.toLocaleString() + ' ‚ÇΩ';
                                        }
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞:', error);
            }
        }
    </script>
    <?php
}

// === –¢–û–í–ê–†–´ ===
function renderProducts($data) {
    $products = $data['products'];
    $categories = $data['categories'];
    $stats = $data['stats'];
    ?>
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class='mini-stats'>
        <div class='mini-stat'>
            <div class='mini-stat-value'><?= $stats['total'] ?></div>
            <div class='mini-stat-label'>–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤</div>
        </div>
        <div class='mini-stat'>
            <div class='mini-stat-value'><?= $stats['active'] ?></div>
            <div class='mini-stat-label'>–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
        </div>
        <div class='mini-stat'>
            <div class='mini-stat-value'><?= $stats['featured'] ?></div>
            <div class='mini-stat-label'>–ü–æ–ø—É–ª—è—Ä–Ω—ã—Ö</div>
        </div>
        <div class='mini-stat'>
            <div class='mini-stat-value'><?= $stats['low_stock'] ?></div>
            <div class='mini-stat-label'>–ú–∞–ª–æ —Ç–æ–≤–∞—Ä–∞</div>
        </div>
    </div>

    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
    <div class='section-actions'>
        <button class='btn btn-success' onclick='openAddProductModal()'>
            <i class='fas fa-plus'></i> –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
        </button>
        <button class='btn btn-primary' onclick='exportData("products")'>
            <i class='fas fa-download'></i> –≠–∫—Å–ø–æ—Ä—Ç
        </button>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class='filters-bar'>
        <input type='text' placeholder='–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤...' onkeyup='filterProducts(this.value)' class='filter-input'>
        <select onchange='filterByCategory(this.value)' class='filter-select'>
            <option value=''>–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
            <?php foreach ($categories as $cat): ?>
                <option value='<?= $cat['id'] ?>'><?= $cat['icon'] ?> <?= $cat['name'] ?></option>
            <?php endforeach; ?>
        </select>
        <select onchange='filterByStatus(this.value)' class='filter-select'>
            <option value=''>–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
            <option value='active'>–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
            <option value='inactive'>–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
        </select>
    </div>

    <!-- –ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class='bulk-actions' id='bulkActions' style='display: none;'>
        <span class='bulk-text'>–í—ã–±—Ä–∞–Ω–æ: <span id='selectedCount'>0</span> —Ç–æ–≤–∞—Ä–æ–≤</span>
        <div class='bulk-buttons'>
            <button class='btn btn-success btn-sm' onclick='bulkAction("activate")'>
                <i class='fas fa-check'></i> –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
            </button>
            <button class='btn btn-outline btn-sm' onclick='bulkAction("deactivate")'>
                <i class='fas fa-times'></i> –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
            </button>
            <button class='btn btn-warning btn-sm' onclick='bulkAction("feature")'>
                <i class='fas fa-star'></i> –í –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ
            </button>
            <button class='btn btn-danger btn-sm' onclick='bulkAction("delete")'>
                <i class='fas fa-trash'></i> –£–¥–∞–ª–∏—Ç—å
            </button>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
    <div class='data-table'>
        <table class='table' id='productsTable'>
            <thead>
                <tr>
                    <th><input type='checkbox' onchange='toggleAllProducts(this)'></th>
                    <th>–¢–æ–≤–∞—Ä</th>
                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                    <th>–¶–µ–Ω–∞</th>
                    <th>–û—Å—Ç–∞—Ç–æ–∫</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($products as $product): ?>
                    <tr data-id='<?= $product['id'] ?>' data-category='<?= $product['category_id'] ?>' data-status='<?= $product['is_active'] ? 'active' : 'inactive' ?>'>
                        <td>
                            <input type='checkbox' class='product-checkbox' value='<?= $product['id'] ?>' onchange='updateBulkActions()'>
                        </td>
                        <td>
                            <div class='product-info'>
                                <div class='product-name'><?= htmlspecialchars($product['name']) ?></div>
                                <div class='product-sku'>SKU: <?= $product['sku'] ?></div>
                                <?php if ($product['is_featured']): ?>
                                    <span class='badge badge-warning'>–¢–û–ü</span>
                                <?php endif; ?>
                            </div>
                        </td>
                        <td><?= htmlspecialchars($product['category']) ?></td>
                        <td>
                            <div class='price-info'>
                                <div class='current-price'><?= number_format($product['price'], 0, '', ' ') ?> ‚ÇΩ</div>
                                <?php if ($product['old_price']): ?>
                                    <div class='old-price'><?= number_format($product['old_price'], 0, '', ' ') ?> ‚ÇΩ</div>
                                <?php endif; ?>
                            </div>
                        </td>
                        <td>
                            <span class='stock-badge <?= $product['stock'] <= 5 ? 'low' : 'normal' ?>'>
                                <?= $product['stock'] ?> —à—Ç
                            </span>
                        </td>
                        <td>
                            <label class='toggle-switch'>
                                <input type='checkbox' <?= $product['is_active'] ? 'checked' : '' ?> 
                                       onchange='toggleProductStatus(<?= $product['id'] ?>, this.checked)'>
                                <span class='toggle-slider'></span>
                            </label>
                        </td>
                        <td>
                            <div class='action-buttons'>
                                <button class='btn btn-sm btn-primary' onclick='editProduct(<?= $product['id'] ?>)' title='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'>
                                    <i class='fas fa-edit'></i>
                                </button>
                                <button class='btn btn-sm btn-danger' onclick='deleteProduct(<?= $product['id'] ?>)' title='–£–¥–∞–ª–∏—Ç—å'>
                                    <i class='fas fa-trash'></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>

    <script>
        function toggleAllProducts(checkbox) {
            const checkboxes = document.querySelectorAll('.product-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateBulkActions();
        }

        function updateBulkActions() {
            const checked = document.querySelectorAll('.product-checkbox:checked').length;
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');

            if (checked > 0) {
                bulkActions.style.display = 'flex';
                selectedCount.textContent = checked;
            } else {
                bulkActions.style.display = 'none';
            }
        }

        async function toggleProductStatus(productId, isActive) {
            try {
                const response = await fetch('admin.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `action=toggle_product_status&product_id=${productId}&is_active=${isActive ? 1 : 0}&ajax=1`
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(result.message, 'success');
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
            }
        }

        async function deleteProduct(productId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

            try {
                const response = await fetch('admin.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `action=delete_product&product_id=${productId}&ajax=1`
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(result.message, 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
            }
        }

        async function bulkAction(action) {
            const checkedIds = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);

            if (checkedIds.length === 0) {
                showNotification('–ù–µ –≤—ã–±—Ä–∞–Ω—ã —Ç–æ–≤–∞—Ä—ã', 'warning');
                return;
            }

            if (action === 'delete' && !confirm(`–£–¥–∞–ª–∏—Ç—å ${checkedIds.length} —Ç–æ–≤–∞—Ä–æ–≤?`)) return;

            try {
                const response = await fetch('admin.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `action=bulk_action_products&bulk_action=${action}&product_ids=${JSON.stringify(checkedIds)}&ajax=1`
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(result.message, 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
            }
        }

        function filterProducts(query) {
            const rows = document.querySelectorAll('#productsTable tbody tr');
            rows.forEach(row => {
                const name = row.querySelector('.product-name').textContent.toLowerCase();
                const visible = name.includes(query.toLowerCase());
                row.style.display = visible ? '' : 'none';
            });
        }

        function filterByCategory(categoryId) {
            const rows = document.querySelectorAll('#productsTable tbody tr');
            rows.forEach(row => {
                const visible = !categoryId || row.dataset.category === categoryId;
                row.style.display = visible ? '' : 'none';
            });
        }

        function filterByStatus(status) {
            const rows = document.querySelectorAll('#productsTable tbody tr');
            rows.forEach(row => {
                const visible = !status || row.dataset.status === status;
                row.style.display = visible ? '' : 'none';
            });
        }

        function openAddProductModal() {
            showNotification('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
        }

        function editProduct(id) {
            showNotification(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ #${id} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info');
        }
    </script>
    <?php
}

// === –ó–ê–ö–ê–ó–´ ===
function renderOrders($data) {
    $orders = $data['orders'];
    $stats = $data['stats'];
    ?>
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤ -->
    <div class='mini-stats'>
        <div class='mini-stat'>
            <div class='mini-stat-value'><?= $stats['total'] ?></div>
            <div class='mini-stat-label'>–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
        </div>
        <div class='mini-stat'>
            <div class='mini-stat-value'><?= $stats['new'] ?></div>
            <div class='mini-stat-label'>–ù–æ–≤—ã–µ</div>
        </div>
        <div class='mini-stat'>
            <div class='mini-stat-value'><?= $stats['processing'] ?></div>
            <div class='mini-stat-label'>–í —Ä–∞–±–æ—Ç–µ</div>
        </div>
        <div class='mini-stat'>
            <div class='mini-stat-value'><?= number_format($stats['total_amount'], 0, '', ' ') ?> ‚ÇΩ</div>
            <div class='mini-stat-label'>–û–±—â–∞—è —Å—É–º–º–∞</div>
        </div>
    </div>

    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
    <div class='section-actions'>
        <button class='btn btn-success' onclick='processAllNew()'>
            <i class='fas fa-play'></i> –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–æ–≤—ã–µ (<?= $stats['new'] ?>)
        </button>
        <button class='btn btn-primary' onclick='exportData("orders")'>
            <i class='fas fa-download'></i> –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–∫–∞–∑–æ–≤
        </button>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞–∫–∞–∑–æ–≤ -->
    <div class='data-table'>
        <table class='table'>
            <thead>
                <tr>
                    <th>‚Ññ –ó–∞–∫–∞–∑–∞</th>
                    <th>–ö–ª–∏–µ–Ω—Ç</th>
                    <th>–î–∞—Ç–∞</th>
                    <th>–°—É–º–º–∞</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($orders as $order): ?>
                    <tr>
                        <td>
                            <div class='order-number'><?= $order['order_number'] ?></div>
                            <div class='order-id'>ID: <?= $order['id'] ?></div>
                        </td>
                        <td>
                            <div class='customer-info'>
                                <div class='customer-name'><?= htmlspecialchars($order['customer_name']) ?></div>
                                <div class='customer-email'><?= htmlspecialchars($order['customer_email']) ?></div>
                                <div class='customer-phone'><?= htmlspecialchars($order['customer_phone']) ?></div>
                            </div>
                        </td>
                        <td>
                            <div class='order-date'><?= date('d.m.Y', strtotime($order['created_at'])) ?></div>
                            <div class='order-time'><?= date('H:i', strtotime($order['created_at'])) ?></div>
                        </td>
                        <td>
                            <div class='order-amount'><?= number_format($order['total_amount'], 0, '', ' ') ?> ‚ÇΩ</div>
                            <div class='order-payment'><?= $order['payment_method'] === 'card' ? 'üí≥ –ö–∞—Ä—Ç–∞' : 'üíµ –ù–∞–ª–∏—á–Ω—ã–µ' ?></div>
                        </td>
                        <td>
                            <select class='status-select' onchange='changeOrderStatus(<?= $order['id'] ?>, this.value)'>
                                <option value='new' <?= $order['status'] === 'new' ? 'selected' : '' ?>>üÜï –ù–æ–≤—ã–π</option>
                                <option value='processing' <?= $order['status'] === 'processing' ? 'selected' : '' ?>>‚è≥ –í —Ä–∞–±–æ—Ç–µ</option>
                                <option value='shipped' <?= $order['status'] === 'shipped' ? 'selected' : '' ?>>üöö –û—Ç–ø—Ä–∞–≤–ª–µ–Ω</option>
                                <option value='delivered' <?= $order['status'] === 'delivered' ? 'selected' : '' ?>>‚úÖ –î–æ—Å—Ç–∞–≤–ª–µ–Ω</option>
                                <option value='cancelled' <?= $order['status'] === 'cancelled' ? 'selected' : '' ?>>‚ùå –û—Ç–º–µ–Ω–µ–Ω</option>
                            </select>
                        </td>
                        <td>
                            <div class='action-buttons'>
                                <button class='btn btn-sm btn-info' onclick='viewOrder(<?= $order['id'] ?>)' title='–ü—Ä–æ—Å–º–æ—Ç—Ä'>
                                    <i class='fas fa-eye'></i>
                                </button>
                                <button class='btn btn-sm btn-success' onclick='printOrder(<?= $order['id'] ?>)' title='–ü–µ—á–∞—Ç—å'>
                                    <i class='fas fa-print'></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>

    <script>
        async function changeOrderStatus(orderId, newStatus) {
            try {
                const response = await fetch('admin.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `action=update_order_status&order_id=${orderId}&status=${newStatus}&ajax=1`
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(result.message, 'success');
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
            }
        }

        function processAllNew() {
            showNotification('–ú–∞—Å—Å–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
        }

        function viewOrder(id) {
            showNotification(`–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–∫–∞–∑–∞ #${id} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info');
        }

        function printOrder(id) {
            showNotification(`–ü–µ—á–∞—Ç—å –∑–∞–∫–∞–∑–∞ #${id} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info');
        }
    </script>
    <?php
}

// === –û–¢–ó–´–í–´ ===
function renderReviews($data) {
    $reviews = $data['reviews'];
    $stats = $data['stats'];
    ?>
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–∑—ã–≤–æ–≤ -->
    <div class='mini-stats'>
        <div class='mini-stat'>
            <div class='mini-stat-value'><?= $stats['total'] ?></div>
            <div class='mini-stat-label'>–í—Å–µ–≥–æ –æ—Ç–∑—ã–≤–æ–≤</div>
        </div>
        <div class='mini-stat'>
            <div class='mini-stat-value'><?= $stats['approved'] ?></div>
            <div class='mini-stat-label'>–û–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö</div>
        </div>
        <div class='mini-stat'>
            <div class='mini-stat-value'><?= $stats['pending'] ?></div>
            <div class='mini-stat-label'>–ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</div>
        </div>
        <div class='mini-stat'>
            <div class='mini-stat-value'><?= number_format($stats['average_rating'], 1) ?></div>
            <div class='mini-stat-label'>–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥</div>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –æ—Ç–∑—ã–≤–æ–≤ -->
    <div class='data-table'>
        <table class='table'>
            <thead>
                <tr>
                    <th>–û—Ç–∑—ã–≤</th>
                    <th>–¢–æ–≤–∞—Ä</th>
                    <th>–†–µ–π—Ç–∏–Ω–≥</th>
                    <th>–î–∞—Ç–∞</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($reviews as $review): ?>
                    <tr>
                        <td>
                            <div class='review-info'>
                                <div class='review-author'><?= htmlspecialchars($review['customer_name']) ?></div>
                                <div class='review-title'><?= htmlspecialchars($review['title']) ?></div>
                                <div class='review-text'><?= htmlspecialchars(mb_substr($review['text'], 0, 100)) ?>...</div>
                            </div>
                        </td>
                        <td><?= htmlspecialchars($review['product_name']) ?></td>
                        <td>
                            <div class='rating-stars'>
                                <?= str_repeat('‚≠ê', $review['rating']) ?>
                            </div>
                        </td>
                        <td><?= date('d.m.Y', strtotime($review['created_at'])) ?></td>
                        <td>
                            <span class='status-badge <?= $review['is_approved'] ? 'approved' : 'pending' ?>'>
                                <?= $review['is_approved'] ? '–û–¥–æ–±—Ä–µ–Ω' : '–ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏' ?>
                            </span>
                        </td>
                        <td>
                            <div class='action-buttons'>
                                <?php if (!$review['is_approved']): ?>
                                    <button class='btn btn-sm btn-success' onclick='approveReview(<?= $review['id'] ?>)' title='–û–¥–æ–±—Ä–∏—Ç—å'>
                                        <i class='fas fa-check'></i>
                                    </button>
                                <?php endif; ?>
                                <button class='btn btn-sm btn-danger' onclick='deleteReview(<?= $review['id'] ?>)' title='–£–¥–∞–ª–∏—Ç—å'>
                                    <i class='fas fa-trash'></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>

    <script>
        async function approveReview(reviewId) {
            try {
                const response = await fetch('admin.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `action=approve_review&review_id=${reviewId}&ajax=1`
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(result.message, 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
            }
        }

        async function deleteReview(reviewId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –æ—Ç–∑—ã–≤?')) return;

            try {
                const response = await fetch('admin.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `action=delete_review&review_id=${reviewId}&ajax=1`
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(result.message, 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
            }
        }
    </script>
    <?php
}

// === –û–°–¢–ê–õ–¨–ù–´–ï –†–ê–ó–î–ï–õ–´ (–∑–∞–≥–ª—É—à–∫–∏ –ø–æ–∫–∞) ===
function renderCategories($data) {
    echo "<div class='alert alert-info'><i class='fas fa-tags'></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –í—Å–µ–≥–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: " . count($data['categories']) . "</div>";
}

function renderAnalytics($data) {
    echo "<div class='alert alert-info'><i class='fas fa-chart-line'></i> –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</div>";
}

function renderInventory($data) {
    echo "<div class='alert alert-info'><i class='fas fa-warehouse'></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–º –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –¢–æ–≤–∞—Ä–æ–≤ —Å –Ω–∏–∑–∫–∏–º –æ—Å—Ç–∞—Ç–∫–æ–º: " . count($data['low_stock']) . "</div>";
}

function renderSettings($data) {
    ?>
    <div class='settings-form'>
        <h3>–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
        <form method='post'>
            <input type='hidden' name='action' value='save_settings'>

            <div class='form-row'>
                <div class='form-group'>
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∞–π—Ç–∞</label>
                    <input type='text' name='site_name' value='<?= htmlspecialchars($data['settings']['site_name']) ?>' class='form-control'>
                </div>
                <div class='form-group'>
                    <label>Email –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
                    <input type='email' name='admin_email' value='<?= htmlspecialchars($data['settings']['admin_email']) ?>' class='form-control'>
                </div>
            </div>

            <button type='submit' class='btn btn-success'>
                <i class='fas fa-save'></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
        </form>
    </div>

    <div class='system-info'>
        <h3>–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
        <?php $sysInfo = $data['system_info']; ?>
        <div class='info-grid'>
            <div class='info-item'>
                <label>PHP –≤–µ—Ä—Å–∏—è:</label>
                <span><?= $sysInfo['php_version'] ?></span>
            </div>
            <div class='info-item'>
                <label>–°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ:</label>
                <span><?= $sysInfo['disk_space'] ?></span>
            </div>
            <div class='info-item'>
                <label>–ü–æ—Å–ª–µ–¥–Ω–∏–π backup:</label>
                <span><?= $sysInfo['last_backup'] ?></span>
            </div>
        </div>
    </div>
    <?php
}

// === –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ===
function renderModals() {
    // –ü–æ–∫–∞ –ø—É—Å—Ç—ã–µ, –±—É–¥–µ–º –¥–æ–±–∞–≤–ª—è—Ç—å –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
}

// === –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
async function exportData($type) {
    try {
        const response = await fetch('admin.php', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `action=export_data&export_type=${type}&ajax=1`
        });

        const result = await response.json();

        if (result.success) {
            // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            const link = document.createElement('a');
            link.href = result.download_url;
            link.download = result.filename;
            link.click();
            showNotification('–≠–∫—Å–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤!', 'success');
        } else {
            showNotification(result.message, 'error');
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞', 'error');
    }
}

function showNotification($message, $type = 'info', $duration = 3000) {
    // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <i class='fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}'></i>
        ${message}
    `;

    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –¥–æ–∫—É–º–µ–Ω—Ç
    document.body.appendChild(notification);

    // –£–±–∏—Ä–∞–µ–º —á–µ—Ä–µ–∑ –≤—Ä–µ–º—è
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, duration);
}

function openQuickAdd() {
    showNotification('–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
}
?>
