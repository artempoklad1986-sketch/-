<?php
/**
 * –§–∞–π–ª–æ–≤–∞—è JSON –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –≤–∏–∑–∏—Ç–æ–∫
 * @author ART-FOTO Team
 * @version 2.0 MEGA
 */

class Database {
    private $dataPath;
    private $uploadsPath;
    private $templatesPath;
    private $projectsPath;

    public function __construct() {
        $this->dataPath = __DIR__ . '/data/';
        $this->uploadsPath = $this->dataPath . 'uploads/';
        $this->templatesPath = $this->dataPath . 'templates/';
        $this->projectsPath = $this->dataPath . 'projects/';

        $this->initDirectories();
    }

    private function initDirectories() {
        $dirs = [
            $this->dataPath,
            $this->uploadsPath,
            $this->templatesPath,
            $this->projectsPath,
            __DIR__ . '/backups/'
        ];

        foreach ($dirs as $dir) {
            if (!is_dir($dir)) {
                mkdir($dir, 0755, true);
            }
        }

        $htaccess = $this->dataPath . '.htaccess';
        if (!file_exists($htaccess)) {
            file_put_contents($htaccess, "Options -Indexes\nDeny from all");
        }
    }

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
    public function saveProject($userId, $projectData) {
        $userId = $this->sanitize($userId);
        $userDir = $this->projectsPath . $userId . '/';

        if (!is_dir($userDir)) {
            mkdir($userDir, 0755, true);
        }

        $projectId = $projectData['id'] ?? $this->generateId();
        $projectData['id'] = $projectId;
        $projectData['userId'] = $userId;
        $projectData['updated'] = date('Y-m-d H:i:s');

        if (!isset($projectData['created'])) {
            $projectData['created'] = $projectData['updated'];
        }

        $file = $userDir . $projectId . '.json';
        $result = file_put_contents($file, json_encode($projectData, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));

        return [
            'success' => $result !== false,
            'id' => $projectId,
            'message' => '–ü—Ä–æ–µ–∫—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω'
        ];
    }

    // –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
    public function getProject($userId, $projectId) {
        $userId = $this->sanitize($userId);
        $projectId = $this->sanitize($projectId);
        $file = $this->projectsPath . $userId . '/' . $projectId . '.json';

        if (file_exists($file)) {
            $data = json_decode(file_get_contents($file), true);
            return [
                'success' => true,
                'data' => $data
            ];
        }

        return [
            'success' => false,
            'error' => '–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'
        ];
    }

    // –°–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    public function getUserProjects($userId) {
        $userId = $this->sanitize($userId);
        $userDir = $this->projectsPath . $userId . '/';

        if (!is_dir($userDir)) {
            return [
                'success' => true,
                'data' => []
            ];
        }

        $projects = [];
        foreach (glob($userDir . '*.json') as $file) {
            $data = json_decode(file_get_contents($file), true);
            $projects[] = [
                'id' => $data['id'],
                'name' => $data['name'] ?? '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
                'preview' => $data['preview'] ?? null,
                'created' => $data['created'] ?? null,
                'updated' => $data['updated'] ?? null,
                'category' => $data['category'] ?? 'other'
            ];
        }

        usort($projects, function($a, $b) {
            return strtotime($b['updated']) - strtotime($a['updated']);
        });

        return [
            'success' => true,
            'data' => $projects
        ];
    }

    // –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
    public function deleteProject($userId, $projectId) {
        $userId = $this->sanitize($userId);
        $projectId = $this->sanitize($projectId);
        $file = $this->projectsPath . $userId . '/' . $projectId . '.json';

        if (file_exists($file)) {
            $result = unlink($file);
            return [
                'success' => $result,
                'message' => '–ü—Ä–æ–µ–∫—Ç —É–¥–∞–ª—ë–Ω'
            ];
        }

        return [
            'success' => false,
            'error' => '–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'
        ];
    }

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    public function uploadImage($userId, $file) {
        $userId = $this->sanitize($userId);
        $userDir = $this->uploadsPath . $userId . '/';

        if (!is_dir($userDir)) {
            mkdir($userDir, 0755, true);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
        $allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml'];
        if (!in_array($file['type'], $allowedTypes)) {
            return [
                'success' => false,
                'error' => '–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞'
            ];
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ (–º–∞–∫—Å 10MB)
        if ($file['size'] > 10485760) {
            return [
                'success' => false,
                'error' => '–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 10MB)'
            ];
        }

        $hash = md5_file($file['tmp_name']);
        $ext = pathinfo($file['name'], PATHINFO_EXTENSION);
        $filename = $hash . '.' . $ext;
        $filepath = $userDir . $filename;

        if (move_uploaded_file($file['tmp_name'], $filepath)) {
            return [
                'success' => true,
                'url' => '/data/uploads/' . $userId . '/' . $filename,
                'filename' => $filename
            ];
        }

        return [
            'success' => false,
            'error' => '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'
        ];
    }

    // –ü–æ–ª—É—á–∏—Ç—å —à–∞–±–ª–æ–Ω—ã
    public function getTemplates($category = null) {
        if ($category) {
            $file = $this->templatesPath . $category . '.json';
            if (file_exists($file)) {
                $data = json_decode(file_get_contents($file), true);
                return [
                    'success' => true,
                    'data' => $data
                ];
            }
            return [
                'success' => false,
                'error' => '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'
            ];
        }

        // –í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        $templates = [];
        foreach (glob($this->templatesPath . '*.json') as $file) {
            $categoryName = basename($file, '.json');
            $data = json_decode(file_get_contents($file), true);
            $templates[$categoryName] = $data;
        }

        return [
            'success' => true,
            'data' => $templates
        ];
    }

    // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    public function getCategories() {
        $categories = [
            'medical' => [
                'name' => '–ú–µ–¥–∏—Ü–∏–Ω–∞',
                'icon' => '‚öïÔ∏è',
                'description' => '–í—Ä–∞—á–∏, –∫–ª–∏–Ω–∏–∫–∏, –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Ü–µ–Ω—Ç—Ä—ã'
            ],
            'business' => [
                'name' => '–ë–∏–∑–Ω–µ—Å',
                'icon' => 'üíº',
                'description' => '–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –≤–∏–∑–∏—Ç–∫–∏ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞'
            ],
            'creative' => [
                'name' => '–ö—Ä–µ–∞—Ç–∏–≤',
                'icon' => 'üé®',
                'description' => '–î–∏–∑–∞–π–Ω–µ—Ä—ã, —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ã, —Ö—É–¥–æ–∂–Ω–∏–∫–∏'
            ],
            'restaurant' => [
                'name' => '–†–µ—Å—Ç–æ—Ä–∞–Ω—ã',
                'icon' => 'üçΩÔ∏è',
                'description' => '–ö–∞—Ñ–µ, —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã, –¥–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã'
            ],
            'realty' => [
                'name' => '–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å',
                'icon' => 'üè†',
                'description' => '–†–∏–µ–ª—Ç–æ—Ä—ã, –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏'
            ],
            'beauty' => [
                'name' => '–ö—Ä–∞—Å–æ—Ç–∞',
                'icon' => 'üíÖ',
                'description' => '–°–∞–ª–æ–Ω—ã –∫—Ä–∞—Å–æ—Ç—ã, –º–∞—Å—Ç–µ—Ä–∞'
            ]
        ];

        return [
            'success' => true,
            'data' => $categories
        ];
    }

    // –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
    public function createBackup() {
        $backupDir = __DIR__ . '/backups/';
        $date = date('Y-m-d_H-i-s');
        $zipFile = $backupDir . "backup_{$date}.zip";

        $zip = new ZipArchive();
        if ($zip->open($zipFile, ZipArchive::CREATE | ZipArchive::OVERWRITE) === TRUE) {

            $files = new RecursiveIteratorIterator(
                new RecursiveDirectoryIterator($this->dataPath),
                RecursiveIteratorIterator::LEAVES_ONLY
            );

            foreach ($files as $file) {
                if (!$file->isDir()) {
                    $filePath = $file->getRealPath();
                    $relativePath = 'data/' . substr($filePath, strlen($this->dataPath));
                    $zip->addFile($filePath, $relativePath);
                }
            }

            $zip->close();

            // –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã (–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10)
            $backups = glob($backupDir . 'backup_*.zip');
            if (count($backups) > 10) {
                usort($backups, function($a, $b) {
                    return filemtime($a) - filemtime($b);
                });
                foreach (array_slice($backups, 0, -10) as $old) {
                    unlink($old);
                }
            }

            return [
                'success' => true,
                'file' => $zipFile,
                'size' => filesize($zipFile)
            ];
        }

        return [
            'success' => false,
            'error' => '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞'
        ];
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    private function sanitize($string) {
        return preg_replace('/[^a-zA-Z0-9_-]/', '', $string);
    }

    private function generateId() {
        return uniqid('card_', true);
    }
}
