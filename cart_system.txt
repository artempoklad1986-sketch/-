<?php
$categories = getCategories();

// Обработка формы добавления товара
if ($_SERVER['REQUEST_METHOD'] === 'POST' && !isset($_POST['action'])) {
    $productData = [
        'name' => trim($_POST['name'] ?? ''),
        'latin_name' => trim($_POST['latin_name'] ?? ''),
        'price' => (float)($_POST['price'] ?? 0),
        'old_price' => (float)($_POST['old_price'] ?? 0),
        'description' => trim($_POST['description'] ?? ''),
        'short_description' => trim($_POST['short_description'] ?? ''),
        'category_id' => (int)($_POST['category_id'] ?? 0),
        'difficulty' => trim($_POST['difficulty'] ?? 'легко'),
        'care_level' => trim($_POST['care_level'] ?? 'начинающий'),
        'size' => trim($_POST['size'] ?? ''),
        'temperature' => trim($_POST['temperature'] ?? ''),
        'ph_level' => trim($_POST['ph_level'] ?? ''),
        'lighting' => trim($_POST['lighting'] ?? ''),
        'tags' => trim($_POST['tags'] ?? ''),
        'meta_title' => trim($_POST['meta_title'] ?? ''),
        'meta_description' => trim($_POST['meta_description'] ?? ''),
        'stock_quantity' => (int)($_POST['stock_quantity'] ?? 0),
        'sku' => trim($_POST['sku'] ?? ''),
        'manufacturer' => trim($_POST['manufacturer'] ?? ''),
        'country' => trim($_POST['country'] ?? ''),
        'warranty_months' => (int)($_POST['warranty_months'] ?? 0),
        'main_image' => $_POST['main_image'] ?? '',
        'gallery' => $_POST['gallery'] ?? '[]',
        'badges' => $_POST['badges'] ?? '[]',
        'status' => 1
    ];

    if (addProduct($productData)) {
        $success = "Товар успешно создан!";
    } else {
        $error = "Ошибка создания товара";
    }
}
?>

<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="h3 mb-1 text-gray-800">Создать товар</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="?page=dashboard">Главная</a></li>
                    <li class="breadcrumb-item"><a href="?page=products">Товары</a></li>
                    <li class="breadcrumb-item active">Создать товар</li>
                </ol>
            </nav>
        </div>
        <div>
            <a href="?page=products" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i>Назад к товарам
            </a>
        </div>
    </div>
</div>

<?php if (isset($success)): ?>
    <div class="alert alert-success alert-dismissible fade show">
        <i class="fas fa-check-circle me-2"></i><?= $success ?>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
<?php endif; ?>

<?php if (isset($error)): ?>
    <div class="alert alert-danger alert-dismissible fade show">
        <i class="fas fa-exclamation-triangle me-2"></i><?= $error ?>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
<?php endif; ?>

<div class="row">
    <!-- Основная форма -->
    <div class="col-xl-8 col-lg-7">
        <form method="POST" id="productForm">

            <!-- Основная информация -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Основная информация</h6>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-robot me-1"></i>ИИ Помощник
                        </button>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" href="#" onclick="aiGenerateAll()">
                                <i class="fas fa-magic me-2"></i>Заполнить всё автоматически
                            </a>
                            <a class="dropdown-item" href="#" onclick="aiSuggestName()">
                                <i class="fas fa-tag me-2"></i>Предложить название
                            </a>
                            <a class="dropdown-item" href="#" onclick="showTemplates()">
                                <i class="fas fa-templates me-2"></i>Шаблоны товаров
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group mb-3">
                                <label class="form-label fw-semibold">
                                    Название товара <span class="text-danger">*</span>
                                    <i class="fas fa-question-circle text-muted ms-1" title="Введите полное название товара. Хорошее название поможет покупателям найти товар"></i>
                                </label>
                                <input type="text" class="form-control form-control-lg" name="name" id="productName" required 
                                       placeholder="Например: Анубиас нана - неприхотливое аквариумное растение">
                                <div class="form-text d-flex justify-content-between">
                                    <span>Символов: <span id="nameLength" class="fw-bold text-primary">0</span>/100</span>
                                    <span id="nameSeoScore"></span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label class="form-label fw-semibold">Артикул (SKU)</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" name="sku" id="productSKU" placeholder="Автогенерация">
                                    <button type="button" class="btn btn-outline-secondary" onclick="generateSKU()" title="Сгенерировать артикул">
                                        <i class="fas fa-sync"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label class="form-label fw-semibold">Категория <span class="text-danger">*</span></label>
                                <select class="form-select" name="category_id" id="productCategory" required>
                                    <option value="">Выберите категорию</option>
                                    <?php foreach ($categories as $category): ?>
                                        <option value="<?= $category['id'] ?>"><?= htmlspecialchars($category['name']) ?></option>
                                    <?php endforeach; ?>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label class="form-label fw-semibold">
                                    Цена <span class="text-danger">*</span>
                                    <button type="button" class="btn btn-sm btn-outline-warning ms-1" onclick="aiSuggestPrice()" title="ИИ предложит оптимальную цену">
                                        <i class="fas fa-robot"></i>
                                    </button>
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="price" id="productPrice" required 
                                           min="0" step="0.01" placeholder="0">
                                    <span class="input-group-text">₽</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label class="form-label fw-semibold">Старая цена (для скидки)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="old_price" id="productOldPrice" 
                                           min="0" step="0.01" placeholder="0">
                                    <span class="input-group-text">₽</span>
                                </div>
                                <div class="form-text" id="discountInfo"></div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label fw-semibold">Латинское/научное название</label>
                                <input type="text" class="form-control" name="latin_name" id="productLatinName"
                                       placeholder="Например: Anubias barteri var. nana">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group mb-3">
                                <label class="form-label fw-semibold">Сложность ухода</label>
                                <select class="form-select" name="difficulty">
                                    <option value="легко">🟢 Легко</option>
                                    <option value="средне">🟡 Средне</option>
                                    <option value="сложно">🔴 Сложно</option>
                                    <option value="экспертный">🟣 Экспертный</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group mb-3">
                                <label class="form-label fw-semibold">Количество на складе</label>
                                <input type="number" class="form-control" name="stock_quantity" 
                                       min="0" value="0" placeholder="0">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Описания -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Описания и контент</h6>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="aiGenerateDescription()">
                            <i class="fas fa-robot me-1"></i>ИИ генерация
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-success" onclick="aiImproveDescription()">
                            <i class="fas fa-magic me-1"></i>Улучшить
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="showDescriptionTemplates()">
                            <i class="fas fa-file-text me-1"></i>Шаблоны
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label class="form-label fw-semibold">Краткое описание</label>
                        <textarea class="form-control" name="short_description" id="productShortDescription" rows="2" 
                                  placeholder="Краткое описание для каталога (до 150 символов)"></textarea>
                        <div class="form-text">
                            <span>Символов: <span id="shortDescLength">0</span>/150</span>
                            <span class="ms-3 text-muted">Отображается в каталоге товаров</span>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label class="form-label fw-semibold">
                            Полное описание <span class="text-danger">*</span>
                            <button type="button" class="btn btn-sm btn-outline-warning ms-1" onclick="aiAnalyzeDescription()" title="ИИ анализ читабельности">
                                <i class="fas fa-search"></i>
                            </button>
                        </label>
                        <textarea class="form-control" name="description" id="productDescription" rows="8" required
                                  placeholder="Подробное описание товара. Расскажите о преимуществах, особенностях использования, уходе..."></textarea>
                        <div class="form-text d-flex justify-content-between">
                            <span>Символов: <span id="descLength" class="fw-bold">0</span></span>
                            <span>Читабельность: <span id="readabilityScore" class="fw-bold">—</span></span>
                            <span>SEO: <span id="seoAnalysis" class="fw-bold">—</span></span>
                        </div>
                    </div>

                    <div class="form-group mb-0">
                        <label class="form-label fw-semibold">
                            Теги (через запятую)
                            <button type="button" class="btn btn-sm btn-outline-info ms-1" onclick="aiGenerateTags()" title="ИИ предложит теги">
                                <i class="fas fa-hashtag"></i>
                            </button>
                        </label>
                        <input type="text" class="form-control" name="tags" id="productTags"
                               placeholder="аквариум, растения, декор, неприхотливые">
                        <div class="form-text">Помогают покупателям найти товар через поиск</div>
                    </div>
                </div>
            </div>

            <!-- Изображения -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-images me-2"></i>Изображения товара
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Основное изображение -->
                        <div class="col-lg-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">
                                    Основное изображение <span class="text-danger">*</span>
                                    <small class="text-muted">(отображается в каталоге)</small>
                                </label>
                                <div class="image-upload-area" id="mainImageUpload">
                                    <div class="upload-placeholder">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                        <h5>Перетащите изображение сюда</h5>
                                        <p class="text-muted mb-3">или нажмите для выбора файла</p>
                                        <button type="button" class="btn btn-primary">
                                            <i class="fas fa-folder-open me-1"></i>Выбрать файл
                                        </button>
                                        <p class="small text-muted mt-2">
                                            Поддерживаются: JPG, PNG, GIF, WebP<br>
                                            Максимальный размер: 5MB<br>
                                            Рекомендуемый размер: 800x600px
                                        </p>
                                    </div>
                                </div>
                                <input type="hidden" name="main_image" id="mainImagePath">
                            </div>
                        </div>

                        <!-- Галерея -->
                        <div class="col-lg-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">
                                    Галерея изображений
                                    <small class="text-muted">(дополнительные фото)</small>
                                </label>
                                <div class="image-upload-area" id="galleryUpload">
                                    <div class="upload-placeholder">
                                        <i class="fas fa-images fa-3x text-secondary mb-3"></i>
                                        <h6>Дополнительные изображения</h6>
                                        <p class="text-muted mb-3">Можно загрузить несколько файлов</p>
                                        <button type="button" class="btn btn-outline-secondary">
                                            <i class="fas fa-plus me-1"></i>Добавить фото
                                        </button>
                                        <p class="small text-muted mt-2">
                                            Максимум 10 изображений
                                        </p>
                                    </div>
                                </div>
                                <div id="galleryPreview" class="gallery-preview mt-3"></div>
                                <input type="hidden" name="gallery" id="galleryPaths" value="[]">
                            </div>
                        </div>
                    </div>

                    <!-- ИИ инструменты для фото -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="bg-light rounded p-3">
                                <h6 class="mb-3">🤖 ИИ инструменты для изображений</h6>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="aiGenerateImage()">
                                        <i class="fas fa-magic me-1"></i>Сгенерировать изображение
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-success" onclick="aiEnhanceImages()">
                                        <i class="fas fa-wand-magic-sparkles me-1"></i>Улучшить качество
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-warning" onclick="aiRemoveBackground()">
                                        <i class="fas fa-cut me-1"></i>Удалить фон
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-info" onclick="aiOptimizeImages()">
                                        <i class="fas fa-compress me-1"></i>Оптимизировать размер
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Кнопки сохранения -->
            <div class="card shadow mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <button type="button" class="btn btn-outline-secondary me-2" onclick="saveAsDraft()">
                                <i class="fas fa-save me-1"></i>Сохранить черновик
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="previewProduct()">
                                <i class="fas fa-eye me-1"></i>Предпросмотр
                            </button>
                        </div>
                        <div>
                            <button type="reset" class="btn btn-secondary me-2" onclick="confirmReset()">
                                <i class="fas fa-undo me-1"></i>Сбросить
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-check me-1"></i>Создать товар
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </form>
    </div>

    <!-- Боковая панель -->
    <div class="col-xl-4 col-lg-5">

        <!-- ИИ Помощник -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-robot me-2"></i>🤖 ИИ Помощник
                </h6>
            </div>
            <div class="card-body">
                <div class="ai-chat-container" id="aiChatContainer" style="max-height: 300px; overflow-y: auto;">
                    <div class="ai-message mb-3">
                        <div class="d-flex">
                            <div class="ai-avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 35px; height: 35px; font-size: 14px;">
                                🤖
                            </div>
                            <div class="ai-message-content">
                                <div class="bg-light rounded p-2">
                                    <strong>ИИ Помощник:</strong><br>
                                    Привет! Я помогу создать отличный товар. Начнём с названия - введите его, и я предложу описание и характеристики!
                                </div>
                                <small class="text-muted">Только что</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="ai-input-area mt-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="aiChatInput" placeholder="Спросите ИИ о товаре...">
                        <button class="btn btn-primary" onclick="sendAIMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>

                <div class="ai-quick-actions mt-3">
                    <div class="d-grid gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="aiSuggestAll()">
                            <i class="fas fa-wand-magic-sparkles me-1"></i>Заполнить всё автоматически
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="aiAnalyzeCompetitors()">
                            <i class="fas fa-search-dollar me-1"></i>Анализ конкурентов
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Шаблоны товаров -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">📋 Шаблоны товаров</h6>
            </div>
            <div class="card-body">
                <div class="template-categories">
                    <div class="mb-3">
                        <h6 class="text-success mb-2">🌿 Растения</h6>
                        <div class="list-group list-group-flush">
                            <button type="button" class="list-group-item list-group-item-action py-2 border-0" 
                                    onclick="applyTemplate('plant', 'anubias')">
                                <small><strong>Анубиас нана</strong><br>
                                <span class="text-muted">Неприхотливое растение переднего плана</span></small>
                            </button>
                            <button type="button" class="list-group-item list-group-item-action py-2 border-0" 
                                    onclick="applyTemplate('plant', 'vallisneria')">
                                <small><strong>Валлиснерия</strong><br>
                                <span class="text-muted">Быстрорастущее растение заднего плана</span></small>
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <h6 class="text-info mb-2">🐠 Рыбки</h6>
                        <div class="list-group list-group-flush">
                            <button type="button" class="list-group-item list-group-item-action py-2 border-0" 
                                    onclick="applyTemplate('fish', 'guppy')">
                                <small><strong>Гуппи</strong><br>
                                <span class="text-muted">Яркая живородящая рыбка</span></small>
                            </button>
                            <button type="button" class="list-group-item list-group-item-action py-2 border-0" 
                                    onclick="applyTemplate('fish', 'neon')">
                                <small><strong>Неон</strong><br>
                                <span class="text-muted">Стайная светящаяся рыбка</span></small>
                            </button>
                        </div>
                    </div>

                    <div class="mb-0">
                        <h6 class="text-warning mb-2">⚙️ Оборудование</h6>
                        <div class="list-group list-group-flush">
                            <button type="button" class="list-group-item list-group-item-action py-2 border-0" 
                                    onclick="applyTemplate('equipment', 'filter')">
                                <small><strong>Фильтр внутренний</strong><br>
                                <span class="text-muted">Система очистки воды</span></small>
                            </button>
                            <button type="button" class="list-group-item list-group-item-action py-2 border-0" 
                                    onclick="applyTemplate('equipment', 'heater')">
                                <small><strong>Нагреватель</strong><br>
                                <span class="text-muted">Поддержание температуры</span></small>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Характеристики -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">🔧 Характеристики</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <div class="form-group mb-3">
                            <label class="form-label small">Размер</label>
                            <input type="text" class="form-control form-control-sm" name="size" placeholder="10-15 см">
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-group mb-3">
                            <label class="form-label small">Температура</label>
                            <input type="text" class="form-control form-control-sm" name="temperature" placeholder="22-26°C">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <div class="form-group mb-3">
                            <label class="form-label small">pH уровень</label>
                            <input type="text" class="form-control form-control-sm" name="ph_level" placeholder="6.0-7.5">
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-group mb-3">
                            <label class="form-label small">Освещение</label>
                            <select class="form-select form-select-sm" name="lighting">
                                <option value="">Выберите</option>
                                <option value="слабое">Слабое</option>
                                <option value="среднее">Среднее</option>
                                <option value="яркое">Яркое</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ярлыки и бейджи -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">🏷️ Ярлыки товара</h6>
            </div>
            <div class="card-body">
                <div class="badges-container">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="badge_new" value="new" onchange="updateBadges()">
                        <label class="form-check-label" for="badge_new">
                            <span class="badge bg-success">🆕 Новинка</span>
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="badge_hit" value="hit" onchange="updateBadges()">
                        <label class="form-check-label" for="badge_hit">
                            <span class="badge bg-danger">🔥 Хит продаж</span>
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="badge_recommend" value="recommend" onchange="updateBadges()">
                        <label class="form-check-label" for="badge_recommend">
                            <span class="badge bg-warning text-dark">⭐ Рекомендуем</span>
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="badge_discount" value="discount" onchange="updateBadges()">
                        <label class="form-check-label" for="badge_discount">
                            <span class="badge bg-info">💸 Скидка</span>
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="badge_premium" value="premium" onchange="updateBadges()">
                        <label class="form-check-label" for="badge_premium">
                            <span class="badge bg-dark">💎 Премиум</span>
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="badge_eco" value="eco" onchange="updateBadges()">
                        <label class="form-check-label" for="badge_eco">
                            <span class="badge bg-success">🌿 Эко</span>
                        </label>
                    </div>
                </div>
                <input type="hidden" name="badges" id="selectedBadges" value="[]">
            </div>
        </div>

        <!-- SEO настройки -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">🎯 SEO настройки</h6>
            </div>
            <div class="card-body">
                <div class="form-group mb-3">
                    <label class="form-label small">Meta Title</label>
                    <input type="text" class="form-control form-control-sm" name="meta_title" maxlength="60">
                    <small class="text-muted">Символов: <span id="metaTitleLength">0</span>/60</small>
                </div>
                <div class="form-group mb-3">
                    <label class="form-label small">Meta Description</label>
                    <textarea class="form-control form-control-sm" name="meta_description" rows="3" maxlength="160"></textarea>
                    <small class="text-muted">Символов: <span id="metaDescLength">0</span>/160</small>
                </div>
                <button type="button" class="btn btn-sm btn-outline-primary w-100" onclick="generateSEO()">
                    <i class="fas fa-search me-1"></i>Автогенерация SEO
                </button>
            </div>
        </div>

        <!-- Предпросмотр товара -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">👁️ Предпросмотр</h6>
            </div>
            <div class="card-body">
                <div class="product-preview" id="productPreview">
                    <div class="preview-badges mb-2" id="previewBadges"></div>
                    <div class="preview-image mb-2">
                        <div class="ratio ratio-1x1 bg-light rounded d-flex align-items-center justify-content-center border">
                            <i class="fas fa-image fa-2x text-muted" id="previewImageIcon"></i>
                        </div>
                    </div>
                    <h6 class="preview-name fw-bold mb-1" id="previewName">Название товара</h6>
                    <p class="preview-description text-muted small mb-2" id="previewDescription">
                        Описание появится здесь...
                    </p>
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="preview-price fw-bold text-success" id="previewPrice">0 ₽</span>
                            <small class="preview-old-price text-muted text-decoration-line-through ms-1" 
                                   id="previewOldPrice" style="display: none;"></small>
                        </div>
                        <small class="text-muted" id="previewCategory">Категория</small>
                    </div>
                    <div class="preview-specs mt-2" id="previewSpecs"></div>
                </div>
            </div>
        </div>

    </div>
</div>

<style>
/* Профессиональные стили */
.page-header {
    background: #fff;
    padding: 1.5rem 0;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid #e3e6f0;
}

.breadcrumb {
    background: none;
    padding: 0;
    margin: 0;
    font-size: 0.85rem;
}

.breadcrumb-item + .breadcrumb-item::before {
    color: #858796;
    content: "›";
}

.card {
    border: 1px solid #e3e6f0;
    border-radius: 0.5rem;
}

.card-header {
    background-color: #f8f9fc;
    border-bottom: 1px solid #e3e6f0;
}

.form-control, .form-select {
    border-color: #d1d3e2;
    font-size: 0.9rem;
}

.form-control:focus, .form-select:focus {
    border-color: #4e73df;
    box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
}

.image-upload-area {
    border: 2px dashed #d1d3e2;
    border-radius: 0.5rem;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #f8f9fc;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.image-upload-area:hover {
    border-color: #4e73df;
    background: #f0f2ff;
    transform: translateY(-2px);
}

.image-upload-area.dragover {
    border-color: #4e73df;
    background: #e8ecff;
    border-style: solid;
}

.image-upload-area.has-image {
    padding: 1rem;
}

.image-preview-container {
    position: relative;
    display: inline-block;
    border-radius: 0.5rem;
    overflow: hidden;
}

.image-preview-container img {
    width: 100%;
    height: auto;
    display: block;
    border-radius: 0.5rem;
}

.image-actions {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 5px;
}

.image-actions .btn {
    width: 30px;
    height: 30px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
}

.gallery-preview {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 10px;
}

.gallery-item {
    position: relative;
    border-radius: 0.5rem;
    overflow: hidden;
    border: 2px solid #e3e6f0;
}

.gallery-item img {
    width: 100%;
    height: 100px;
    object-fit: cover;
}

.gallery-item .remove-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: rgba(220, 53, 69, 0.9);
    color: white;
    border: none;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.ai-message {
    margin-bottom: 1rem;
}

.ai-avatar {
    flex-shrink: 0;
}

.upload-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(78, 115, 223, 0.1);
    padding: 10px;
}

.btn {
    font-size: 0.875rem;
    border-radius: 0.375rem;
}

.btn-primary {
    background-color: #4e73df;
    border-color: #4e73df;
}

.btn-primary:hover {
    background-color: #2e59d9;
    border-color: #2653d4;
}

.text-gray-800 { color: #5a5c69 !important; }
.font-weight-bold { font-weight: 700 !important; }
.fw-semibold { font-weight: 600 !important; }

/* Анимации */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.loading {
    animation: pulse 1.5s infinite;
}

/* Адаптивность */
@media (max-width: 768px) {
    .page-header { padding: 1rem 0; }
    .card-body { padding: 1rem; }
    .image-upload-area { min-height: 150px; padding: 1.5rem; }
    .gallery-preview { grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); }
}
</style>

<script>
// Глобальные переменные
let galleryImages = [];
let aiTemplates = {
    plant: {
        anubias: {
            name: "Анубиас нана",
            latin_name: "Anubias barteri var. nana", 
            price: 450,
            description: "Неприхотливое медленнорастущее растение с жесткими темно-зелеными листьями. Идеально подходит для начинающих аквариумистов. Растет при слабом освещении, не требует подачи CO2. Можно крепить к корягам и камням.",
            short_description: "Неприхотливое аквариумное растение для переднего плана",
            size: "10-15 см",
            lighting: "слабое",
            difficulty: "легко",
            tags: "анубиас, неприхотливые, медленнорастущие, тенелюбивые, передний план"
        },
        vallisneria: {
            name: "Валлиснерия спиральная",
            latin_name: "Vallisneria spiralis",
            price: 250,
            description: "Быстрорастущее длинностебельное растение для заднего плана аквариума. Образует густые заросли, хорошо очищает воду и выделяет кислород. Размножается побегами. Подходит для аквариумов любого размера.",
            short_description: "Быстрорастущее растение заднего плана",
            size: "30-60 см",
            lighting: "среднее",
            difficulty: "легко", 
            tags: "валлиснерия, быстрорастущие, задний план, кислород, побеги"
        }
    },
    fish: {
        guppy: {
            name: "Гуппи обыкновенная",
            latin_name: "Poecilia reticulata",
            price: 150,
            description: "Яркая и неприхотливая живородящая рыбка, идеальная для начинающих аквариумистов. Самцы имеют яркую окраску и развитые плавники. Миролюбивые, хорошо уживаются с другими видами. Легко размножаются.",
            short_description: "Яркая неприхотливая живородящая рыбка",
            size: "3-6 см",
            temperature: "22-28°C",
            ph_level: "6.5-8.0",
            difficulty: "легко",
            tags: "гуппи, живородящие, яркие, неприхотливые, начинающим"
        },
        neon: {
            name: "Неон голубой",
            latin_name: "Paracheirodon innesi",
            price: 80,
            description: "Маленькая стайная рыбка с ярко-голубой неоновой полоской вдоль тела. Создает потрясающий визуальный эффект в стае от 10-15 особей. Мирные, подходят для общих аквариумов. Предпочитают мягкую слабокислую воду.",
            short_description: "Яркая стайная рыбка с неоновой полоской",
            size: "3-4 см",
            temperature: "20-26°C",
            ph_level: "5.5-7.0",
            difficulty: "средне",
            tags: "неон, стайные, яркие, мирные, небольшие"
        }
    },
    equipment: {
        filter: {
            name: "Фильтр внутренний аквариумный",
            price: 1200,
            description: "Надежный внутренний фильтр для механической и биологической очистки воды. Подходит для аквариумов объемом до 100 литров. Регулируемая производительность, бесшумная работа. В комплекте губки и наполнители.",
            short_description: "Внутренний фильтр для очистки воды",
            difficulty: "легко",
            warranty_months: 24,
            tags: "фильтр, очистка, биофильтрация, внутренний, тихий"
        },
        heater: {
            name: "Обогреватель с терморегулятором",
            price: 800,
            description: "Автоматический обогреватель с точным терморегулятором для поддержания стабильной температуры воды. Мощность 50W, подходит для аквариумов 50-80 литров. Защита от перегрева, влагозащищенный корпус.",
            short_description: "Автоматический обогреватель для аквариума",
            difficulty: "легко", 
            warranty_months: 12,
            tags: "обогреватель, терморегулятор, температура, автомат"
        }
    }
};

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    initImageUploads();
    initFormTracking();
    initAIChat();
    updatePreview();

    // Приветствие от ИИ
    setTimeout(() => {
        addAIMessage("Готов помочь! Начните с ввода названия товара, и я предложу остальные данные 🚀");
    }, 1000);
});

// Инициализация загрузки изображений
function initImageUploads() {
    // Основное изображение
    const mainUpload = document.getElementById('mainImageUpload');
    if (mainUpload) {
        mainUpload.addEventListener('click', (e) => {
            if (!e.target.closest('.btn-danger') && !e.target.closest('.image-actions')) {
                selectFiles('main');
            }
        });

        mainUpload.addEventListener('dragover', (e) => handleDragOver(e, mainUpload));
        mainUpload.addEventListener('dragleave', (e) => handleDragLeave(e, mainUpload));
        mainUpload.addEventListener('drop', (e) => handleDrop(e, 'main'));
    }

    // Галерея
    const galleryUpload = document.getElementById('galleryUpload');
    if (galleryUpload) {
        galleryUpload.addEventListener('click', (e) => {
            if (!e.target.closest('.remove-btn')) {
                selectFiles('gallery');
            }
        });

        galleryUpload.addEventListener('dragover', (e) => handleDragOver(e, galleryUpload));
        galleryUpload.addEventListener('dragleave', (e) => handleDragLeave(e, galleryUpload));
        galleryUpload.addEventListener('drop', (e) => handleDrop(e, 'gallery'));
    }
}

function selectFiles(type) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.multiple = type === 'gallery';

    input.onchange = (e) => {
        const files = Array.from(e.target.files);
        if (files.length > 0) {
            processFiles(files, type);
        }
    };

    input.click();
}

function handleDragOver(e, element) {
    e.preventDefault();
    e.stopPropagation();
    element.classList.add('dragover');
}

function handleDragLeave(e, element) {
    e.preventDefault();
    e.stopPropagation();
    if (!element.contains(e.relatedTarget)) {
        element.classList.remove('dragover');
    }
}

function handleDrop(e, type) {
    e.preventDefault();
    e.stopPropagation();
    e.currentTarget.classList.remove('dragover');

    const files = Array.from(e.dataTransfer.files);
    if (files.length > 0) {
        processFiles(files, type);
    }
}

async function processFiles(files, type) {
    const validFiles = files.filter(file => {
        if (!file.type.startsWith('image/')) {
            showNotification(`Файл ${file.name} не является изображением`, 'warning');
            return false;
        }

        if (file.size > 5 * 1024 * 1024) {
            showNotification(`Файл ${file.name} слишком большой (максимум 5MB)`, 'warning');
            return false;
        }

        return true;
    });

    if (validFiles.length === 0) return;

    // Показываем индикатор загрузки
    showUploadProgress(true);

    try {
        for (const file of validFiles) {
            await uploadImage(file, type);
        }
    } finally {
        showUploadProgress(false);
    }
}

async function uploadImage(file, type) {
    try {
        const formData = new FormData();
        formData.append('images', file);

        const response = await fetch('upload.php', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('Получен не JSON:', text);
            throw new Error('Сервер вернул некорректный ответ');
        }

        const result = await response.json();

        if (result.success && result.files.length > 0) {
            const imageData = result.files[0];

            if (type === 'main') {
                setMainImage(imageData);
            } else {
                addToGallery(imageData);
            }

            updatePreview();
            showNotification(`Изображение ${imageData.original_name} загружено успешно`, 'success');

            // Добавляем сообщение от ИИ
            addAIMessage(`Отличное изображение! Размер: ${imageData.dimensions.width}x${imageData.dimensions.height}px. Рекомендую добавить еще 2-3 фото товара с разных ракурсов 📸`);

        } else {
            throw new Error(result.message || 'Ошибка загрузки файла');
        }

        if (result.errors && result.errors.length > 0) {
            result.errors.forEach(error => {
                showNotification(error, 'warning');
            });
        }

    } catch (error) {
        console.error('Ошибка загрузки:', error);
        showNotification('Ошибка загрузки изображения: ' + error.message, 'error');
    }
}

function setMainImage(imageData) {
    const mainUpload = document.getElementById('mainImageUpload');
    const mainPath = document.getElementById('mainImagePath');

    mainUpload.innerHTML = `
        <div class="image-preview-container">
            <img src="${imageData.url}" alt="Основное изображение" class="img-fluid">
            <div class="image-actions">
                <button type="button" class="btn btn-sm btn-primary" onclick="cropImage('${imageData.url}')" title="Обрезать">
                    <i class="fas fa-crop"></i>
                </button>
                <button type="button" class="btn btn-sm btn-danger" onclick="removeMainImage()" title="Удалить">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `;

    mainUpload.classList.add('has-image');
    mainPath.value = imageData.url;
}

function removeMainImage() {
    const mainUpload = document.getElementById('mainImageUpload');
    const mainPath = document.getElementById('mainImagePath');

    mainUpload.innerHTML = `
        <div class="upload-placeholder">
            <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
            <h5>Перетащите изображение сюда</h5>
            <p class="text-muted mb-3">или нажмите для выбора файла</p>
            <button type="button" class="btn btn-primary">
                <i class="fas fa-folder-open me-1"></i>Выбрать файл
            </button>
            <p class="small text-muted mt-2">
                Поддерживаются: JPG, PNG, GIF, WebP<br>
                Максимальный размер: 5MB<br>
                Рекомендуемый размер: 800x600px
            </p>
        </div>
    `;

    mainUpload.classList.remove('has-image');
    mainPath.value = '';
    updatePreview();
}

function addToGallery(imageData) {
    galleryImages.push(imageData);
    updateGalleryPreview();
    updateGalleryInput();
}

function updateGalleryPreview() {
    const preview = document.getElementById('galleryPreview');

    if (galleryImages.length === 0) {
        preview.innerHTML = '';
        return;
    }

    preview.innerHTML = galleryImages.map((imageData, index) => `
        <div class="gallery-item">
            <img src="${imageData.thumbnail || imageData.url}" alt="Галерея ${index + 1}">
            <button type="button" class="remove-btn" onclick="removeFromGallery(${index})" title="Удалить">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
}

function removeFromGallery(index) {
    galleryImages.splice(index, 1);
    updateGalleryPreview();
    updateGalleryInput();
    updatePreview();
}

function updateGalleryInput() {
    document.getElementById('galleryPaths').value = JSON.stringify(galleryImages.map(img => img.url));
}

function showUploadProgress(show) {
    // Можно добавить индикатор прогресса загрузки
    const areas = document.querySelectorAll('.image-upload-area');
    areas.forEach(area => {
        if (show) {
            area.classList.add('loading');
        } else {
            area.classList.remove('loading');
        }
    });
}

// ИИ функции
function initAIChat() {
    const input = document.getElementById('aiChatInput');
    if (input) {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendAIMessage();
            }
        });
    }
}

function sendAIMessage() {
    const input = document.getElementById('aiChatInput');
    const message = input.value.trim();

    if (!message) return;

    // Добавляем сообщение пользователя
    addUserMessage(message);
    input.value = '';

    // Имитируем размышление ИИ
    addAIMessage("Анализирую...", true);

    setTimeout(() => {
        removeTemporaryMessages();
        processAIRequest(message);
    }, 1500);
}

function addUserMessage(message) {
    const container = document.getElementById('aiChatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'user-message mb-3';

    messageDiv.innerHTML = `
        <div class="d-flex justify-content-end">
            <div class="user-message-content">
                <div class="bg-primary text-white rounded p-2">
                    ${message}
                </div>
                <small class="text-muted float-end">Только что</small>
            </div>
            <div class="user-avatar bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center ms-3" style="width: 35px; height: 35px; font-size: 14px;">
                👤
            </div>
        </div>
    `;

    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}

function addAIMessage(message, isTemporary = false) {
    const container = document.getElementById('aiChatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `ai-message mb-3 ${isTemporary ? 'temporary' : ''}`;

    messageDiv.innerHTML = `
        <div class="d-flex">
            <div class="ai-avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 35px; height: 35px; font-size: 14px;">
                🤖
            </div>
            <div class="ai-message-content">
                <div class="bg-light rounded p-2">
                    <strong>ИИ Помощник:</strong><br>
                    ${message}
                </div>
                <small class="text-muted">Только что</small>
            </div>
        </div>
    `;

    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}

function removeTemporaryMessages() {
    const tempMessages = document.querySelectorAll('.temporary');
    tempMessages.forEach(msg => msg.remove());
}

function processAIRequest(message) {
    const lowerMessage = message.toLowerCase();
    let response = "Интересный вопрос! 🤔 ";

    if (lowerMessage.includes('цена') || lowerMessage.includes('стоимость')) {
        response += "Для определения оптимальной цены рекомендую изучить конкурентов. Могу предложить цену на основе категории и характеристик товара.";
    } else if (lowerMessage.includes('описание')) {
        response += "Хорошее описание должно включать: назначение товара, преимущества, характеристики, условия использования. Хотите, чтобы я сгенерировал описание на основе названия?";
    } else if (lowerMessage.includes('фото') || lowerMessage.includes('изображение')) {
        response += "Качественные фотографии критически важны! Рекомендую: основное фото на белом фоне, детали крупным планом, товар в использовании. Могу улучшить загруженные изображения.";
    } else if (lowerMessage.includes('seo') || lowerMessage.includes('поиск')) {
        response += "Для хорошего SEO важны: уникальное название с ключевыми словами, подробное описание, правильно заполненные мета-теги. Могу автоматически оптимизировать все поля.";
    } else {
        const responses = [
            "Отличная идея! Давайте проработаем детали этого товара. Какую категорию выберем?",
            "Понял вас! Могу помочь с заполнением всех полей. С чего начнем?",
            "Интересно! Рекомендую также обратить внимание на характеристики и ярлыки товара.",
            "Хороший подход! Не забудьте про качественные фотографии - они повышают продажи на 40%.",
            "Отлично! Могу предложить готовый шаблон или создать уникальное описание."
        ];
        response += responses[Math.floor(Math.random() * responses.length)];
    }

    addAIMessage(response);
}

// Применение шаблонов
function applyTemplate(category, type) {
    const template = aiTemplates[category]?.[type];
    if (!template) return;

    // Заполняем поля формы
    Object.keys(template).forEach(key => {
        const input = document.querySelector(`[name="${key}"], #product${key.charAt(0).toUpperCase() + key.slice(1)}`);
        if (input) {
            input.value = template[key];
            input.dispatchEvent(new Event('input'));
        }
    });

    generateSKU();
    updatePreview();

    addAIMessage(`Применен шаблон "${template.name}"! Все основные поля заполнены. Можете отредактировать данные под свои потребности 🎯`);
    showNotification(`Шаблон "${template.name}" применен!`, 'success');
}

// Генерация SKU
function generateSKU() {
    const name = document.getElementById('productName').value || 'PRODUCT';
    const category = document.getElementById('productCategory').selectedOptions[0]?.text || 'CAT';
    const timestamp = Date.now().toString().slice(-4);

    const sku = (category.substring(0, 3) + '_' + name.substring(0, 3) + '_' + timestamp)
        .toUpperCase().replace(/[^A-Z0-9_]/g, '');

    document.getElementById('productSKU').value = sku;
}

// ИИ функции генерации
async function aiGenerateDescription() {
    const name = document.getElementById('productName').value;
    const category = document.getElementById('productCategory').selectedOptions[0]?.text || '';

    if (!name) {
        showNotification('Сначала введите название товара', 'warning');
        return;
    }

    addAIMessage("Генерирую описание на основе названия и категории...", true);

    setTimeout(() => {
        removeTemporaryMessages();

        const descriptions = [
            `${name} - высококачественный товар для аквариумистики категории "${category}". Отличается надежностью, простотой использования и долговечностью. Идеально подходит как для начинающих, так и для опытных аквариумистов. 

Особенности:
• Проверенное качество и безопасность
• Простота в установке и обслуживании  
• Совместимость с большинством аквариумных систем
• Подходит для пресноводных и морских аквариумов

Рекомендуется специалистами и имеет множество положительных отзывов от покупателей.`,

            `Представляем ${name} - инновационное решение в сфере аквариумистики! Этот товар из категории "${category}" станет отличным дополнением к вашему аквариуму.

Преимущества:
• Высокое качество материалов и изготовления
• Удобство в эксплуатации и обслуживании
• Длительный срок службы
• Соответствие международным стандартам качества

Подходит для аквариумов различного объема и типа. Поставляется с подробной инструкцией по установке и использованию.`
        ];

        const randomDescription = descriptions[Math.floor(Math.random() * descriptions.length)];
        document.getElementById('productDescription').value = randomDescription;

        // Генерируем краткое описание
        const shortDesc = `${name} - качественный товар для аквариумистики с отличными характеристиками и надежностью`;
        document.getElementById('productShortDescription').value = shortDesc;

        updatePreview();
        addAIMessage("Готово! Сгенерировал подробное описание товара. Вы можете отредактировать текст под свои потребности ✨");
    }, 2000);
}

async function aiImproveDescription() {
    const description = document.getElementById('productDescription').value;

    if (!description) {
        showNotification('Сначала добавьте описание товара', 'warning');
        return;
    }

    addAIMessage("Улучшаю существующее описание...", true);

    setTimeout(() => {
        removeTemporaryMessages();

        const improvements = [
            "\n\n💎 ПРЕИМУЩЕСТВА ПОКУПКИ У НАС:\n• Гарантия качества и оригинальности товара\n• Быстрая доставка по всей России\n• Профессиональная консультация специалистов\n• Возможность возврата в течение 14 дней",

            "\n\n🔬 ТЕХНИЧЕСКИЕ ОСОБЕННОСТИ:\n• Сертифицированное качество\n• Соответствие европейским стандартам\n• Экологически безопасные материалы\n• Подробная инструкция на русском языке",

            "\n\n⭐ РЕКОМЕНДАЦИИ ЭКСПЕРТОВ:\n• Одобрено ведущими аквариумистами\n• Проверено в реальных условиях эксплуатации\n• Высокие оценки в специализированных изданиях\n• Рекомендуется для профессионального использования"
        ];

        const randomImprovement = improvements[Math.floor(Math.random() * improvements.length)];
        document.getElementById('productDescription').value = description + randomImprovement;

        updatePreview();
        addAIMessage("Описание улучшено! Добавил дополнительную информацию, которая поможет покупателям принять решение 🚀");
    }, 1500);
}

async function aiSuggestPrice() {
    const name = document.getElementById('productName').value;
    const category = document.getElementById('productCategory').selectedOptions[0]?.text || '';

    if (!name) {
        showNotification('Введите название товара для анализа цены', 'warning');
        return;
    }

    addAIMessage("Анализирую рынок и предлагаю оптимальную цену...", true);

    setTimeout(() => {
        removeTemporaryMessages();

        // Базовые цены по категориям
        const basePrices = {
            'Растения': rand(150, 600),
            'Рыбки': rand(80, 400), 
            'Оборудование': rand(500, 3000),
            'Декор': rand(200, 800),
            'Корма': rand(100, 500),
            'Химия': rand(150, 700)
        };

        const basePrice = basePrices[category] || rand(200, 800);
        const suggestedPrice = Math.round(basePrice * (0.8 + Math.random() * 0.4));
        const oldPrice = Math.round(suggestedPrice * 1.2);

        document.getElementById('productPrice').value = suggestedPrice;
        document.getElementById('productOldPrice').value = oldPrice;

        calculateDiscount();
        updatePreview();

        addAIMessage(`Рекомендуемая цена: ${suggestedPrice} ₽ (была ${oldPrice} ₽). Скидка привлечет больше покупателей! Цена основана на анализе рынка и категории товара 💰`);
    }, 2000);
}

async function aiGenerateTags() {
    const name = document.getElementById('productName').value;
    const category = document.getElementById('productCategory').selectedOptions[0]?.text || '';
    const description = document.getElementById('productDescription').value;

    if (!name) {
        showNotification('Введите название товара для генерации тегов', 'warning');
        return;
    }

    // Базовые теги по категориям
    const categoryTags = {
        'Растения': ['растения', 'аквариумные', 'зеленые', 'живые', 'декор'],
        'Рыбки': ['рыбки', 'аквариумные', 'тропические', 'цветные', 'живые'],
        'Оборудование': ['оборудование', 'аквариум', 'техника', 'фильтр', 'насос'],
        'Декор': ['декор', 'украшения', 'дизайн', 'камни', 'коряги'],
        'Корма': ['корм', 'питание', 'рыбки', 'витамины', 'гранулы']
    };

    let tags = [...(categoryTags[category] || ['аквариум'])];

    // Добавляем теги на основе названия
    const nameWords = name.toLowerCase().split(' ').filter(word => word.length > 3);
    tags = [...tags, ...nameWords];

    // Удаляем дубликаты и ограничиваем количество
    tags = [...new Set(tags)].slice(0, 8);

    document.getElementById('productTags').value = tags.join(', ');

    addAIMessage(`Сгенерировал теги для лучшего поиска: "${tags.join(', ')}". Эти теги помогут покупателям найти ваш товар 🔍`);
}

function aiGenerateAll() {
    const name = document.getElementById('productName').value;

    if (!name) {
        showNotification('Сначала введите название товара', 'warning');
        return;
    }

    addAIMessage("Автоматически заполняю все поля товара...", true);

    setTimeout(() => {
        removeTemporaryMessages();

        // Генерируем все поля
        aiGenerateDescription();
        setTimeout(() => {
            aiSuggestPrice();
            generateSKU();
            aiGenerateTags();
            generateSEO();

            // Устанавливаем случайный бейдж
            const badges = ['new', 'recommend'];
            const randomBadge = badges[Math.floor(Math.random() * badges.length)];
            document.getElementById(`badge_${randomBadge}`).checked = true;
            updateBadges();

            addAIMessage("Всё готово! Заполнил все основные поля товара. Проверьте данные и добавьте фотографии для завершения ✅");
        }, 1000);
    }, 500);
}

// Другие функции
function generateSEO() {
    const name = document.getElementById('productName').value;
    const category = document.getElementById('productCategory').selectedOptions[0]?.text || '';
    const price = document.getElementById('productPrice').value;

    if (!name) {
        showNotification('Введите название товара для генерации SEO', 'warning');
        return;
    }

    const metaTitle = `${name} - купить в АкваСбор${price ? ' от ' + price + ' руб' : ''}`;
    const metaDescription = `${name} из категории ${category}. Лучшие цены, качественные товары, быстрая доставка. Заказать ${name} в интернет-магазине АкваСбор.`;

    document.querySelector('[name="meta_title"]').value = metaTitle.substring(0, 60);
    document.querySelector('[name="meta_description"]').value = metaDescription.substring(0, 160);

    showNotification('SEO данные сгенерированы!', 'success');
}

function updateBadges() {
    const badges = [];
    document.querySelectorAll('.badges-container input[type="checkbox"]:checked').forEach(checkbox => {
        badges.push(checkbox.value);
    });
    document.getElementById('selectedBadges').value = JSON.stringify(badges);
    updatePreview();
}

function calculateDiscount() {
    const price = parseFloat(document.getElementById('productPrice').value) || 0;
    const oldPrice = parseFloat(document.getElementById('productOldPrice').value) || 0;

    if (price > 0 && oldPrice > price) {
        const discount = Math.round(((oldPrice - price) / oldPrice) * 100);
        const savings = oldPrice - price;
        document.getElementById('discountInfo').innerHTML = 
            `<small class="text-success">Скидка: ${discount}% (экономия ${savings.toFixed(0)} ₽)</small>`;

        // Автоматически включаем бейдж скидки
        document.getElementById('badge_discount').checked = true;
        updateBadges();
    } else {
        document.getElementById('discountInfo').innerHTML = '';
    }
}

// Отслеживание изменений формы
function initFormTracking() {
    const form = document.getElementById('productForm');
    const inputs = form.querySelectorAll('input, select, textarea');

    inputs.forEach(input => {
        input.addEventListener('input', updatePreview);
        input.addEventListener('change', updatePreview);
    });

    // Специальные обработчики
    document.getElementById('productName').addEventListener('input', function() {
        const length = this.value.length;
        document.getElementById('nameLength').textContent = length;

        const seoScore = document.getElementById('nameSeoScore');
        if (length < 10) {
            seoScore.innerHTML = '<span class="text-warning">📈 Слишком короткое для SEO</span>';
        } else if (length < 30) {
            seoScore.innerHTML = '<span class="text-success">✅ Хорошо для SEO</span>';  
        } else if (length < 60) {
            seoScore.innerHTML = '<span class="text-success">🎯 Отлично для SEO</span>';
        } else {
            seoScore.innerHTML = '<span class="text-danger">⚠️ Слишком длинное</span>';
        }
    });

    document.getElementById('productDescription').addEventListener('input', function() {
        const length = this.value.length;
        document.getElementById('descLength').textContent = length;

        const readability = document.getElementById('readabilityScore');
        const seoAnalysis = document.getElementById('seoAnalysis');

        if (length < 100) {
            readability.textContent = 'Коротко';
            readability.className = 'fw-bold text-warning';
            seoAnalysis.innerHTML = '<span class="text-danger">Нужно больше</span>';
        } else if (length < 300) {
            readability.textContent = 'Хорошо';
            readability.className = 'fw-bold text-success';
            seoAnalysis.innerHTML = '<span class="text-success">Хорошо</span>';
        } else if (length < 600) {
            readability.textContent = 'Отлично';  
            readability.className = 'fw-bold text-success';
            seoAnalysis.innerHTML = '<span class="text-success">Отлично</span>';
        } else {
            readability.textContent = 'Очень подробно';
            readability.className = 'fw-bold text-info';
            seoAnalysis.innerHTML = '<span class="text-info">Очень подробно</span>';
        }
    });

    document.getElementById('productShortDescription').addEventListener('input', function() {
        document.getElementById('shortDescLength').textContent = this.value.length;
    });

    // Meta поля
    document.querySelector('[name="meta_title"]').addEventListener('input', function() {
        document.getElementById('metaTitleLength').textContent = this.value.length;
    });

    document.querySelector('[name="meta_description"]').addEventListener('input', function() {
        document.getElementById('metaDescLength').textContent = this.value.length;
    });

    // Автоматический расчет скидки
    ['productPrice', 'productOldPrice'].forEach(id => {
        document.getElementById(id).addEventListener('input', calculateDiscount);
    });
}

// Обновление предпросмотра
function updatePreview() {
    const name = document.getElementById('productName').value || 'Название товара';
    const price = document.getElementById('productPrice').value || '0';
    const oldPrice = document.getElementById('productOldPrice').value || '';
    const description = document.getElementById('productDescription').value || 'Описание появится здесь...';
    const categoryText = document.getElementById('productCategory').selectedOptions[0]?.text || 'Категория';

    // Обновляем элементы предпросмотра
    document.getElementById('previewName').textContent = name;
    document.getElementById('previewPrice').textContent = formatPrice(price);
    document.getElementById('previewDescription').textContent = description.substring(0, 120) + 
        (description.length > 120 ? '...' : '');
    document.getElementById('previewCategory').textContent = categoryText;

    // Старая цена
    const oldPriceElement = document.getElementById('previewOldPrice');
    if (oldPrice && parseFloat(oldPrice) > parseFloat(price)) {
        oldPriceElement.textContent = formatPrice(oldPrice);
        oldPriceElement.style.display = 'inline';
    } else {
        oldPriceElement.style.display = 'none';
    }

    // Бейджи
    const badges = JSON.parse(document.getElementById('selectedBadges').value || '[]');
    const badgeColors = {
        new: 'success', hit: 'danger', recommend: 'warning', 
        discount: 'info', premium: 'dark', eco: 'success'
    };
    const badgeTexts = {
        new: '🆕 Новинка', hit: '🔥 Хит', recommend: '⭐ ТОП', 
        discount: '💸 Скидка', premium: '💎 Премиум', eco: '🌿 Эко'
    };

    const badgesHtml = badges.map(badge => 
        `<span class="badge bg-${badgeColors[badge] || 'secondary'} me-1 mb-1">${badgeTexts[badge] || badge}</span>`
    ).join('');

    document.getElementById('previewBadges').innerHTML = badgesHtml;

    // Характеристики  
    const specs = [];
    ['size', 'temperature', 'ph_level'].forEach(field => {
        const value = document.querySelector(`[name="${field}"]`).value;
        if (value) {
            const labels = { size: '📏', temperature: '🌡️', ph_level: '💧' };
            specs.push(`${labels[field]} ${value}`);
        }
    });

    document.getElementById('previewSpecs').innerHTML = specs.length ? 
        '<small class="text-muted d-block mt-2">' + specs.join(' • ') + '</small>' : '';

    // Иконка изображения
    const mainImage = document.getElementById('mainImagePath').value;
    const icon = document.getElementById('previewImageIcon');

    if (mainImage) {
        icon.className = 'fas fa-check-circle fa-2x text-success';
        icon.title = 'Основное изображение загружено';
    } else {
        icon.className = 'fas fa-image fa-2x text-muted';
        icon.title = 'Изображение не загружено';
    }
}

// Вспомогательные функции
function formatPrice(price) {
    return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'RUB',
        minimumFractionDigits: 0
    }).format(price);
}

function rand(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function showNotification(message, type = 'success') {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'error' ? 'alert-danger' : 
                      type === 'warning' ? 'alert-warning' : 'alert-info';

    const alert = document.createElement('div');
    alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; border-radius: 0.5rem;';
    alert.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            ${message}
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alert);

    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

// Дополнительные функции
function saveAsDraft() {
    const formData = new FormData(document.getElementById('productForm'));
    const draftData = {};

    for (let [key, value] of formData.entries()) {
        draftData[key] = value;
    }

    localStorage.setItem('product_draft_' + Date.now(), JSON.stringify(draftData));
    showNotification('Черновик сохранен в локальном хранилище!', 'success');
    addAIMessage('Черновик сохранен! Вы можете вернуться к редактированию позже 💾');
}

function previewProduct() {
    updatePreview();

    // Создаем модальное окно предпросмотра
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">👁️ Предпросмотр товара</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="ratio ratio-1x1 bg-light rounded d-flex align-items-center justify-content-center border">
                                ${document.getElementById('mainImagePath').value ? 
                                    `<img src="${document.getElementById('mainImagePath').value}" class="img-fluid rounded">` :
                                    '<i class="fas fa-image fa-4x text-muted"></i>'
                                }
                            </div>
                        </div>
                        <div class="col-md-6">
                            ${document.getElementById('productPreview').innerHTML}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();

    modal.addEventListener('hidden.bs.modal', () => {
        modal.remove();
    });
}

function confirmReset() {
    if (confirm('🗑️ Вы уверены, что хотите очистить всю форму? Все введенные данные будут потеряны!')) {
        document.getElementById('productForm').reset();
        galleryImages = [];
        updateGalleryPreview();
        updateGalleryInput();
        document.getElementById('selectedBadges').value = '[]';
        document.getElementById('mainImagePath').value = '';
        removeMainImage();
        updatePreview();

        // Очищаем чат с ИИ
        const container = document.getElementById('aiChatContainer');
        container.innerHTML = `
            <div class="ai-message mb-3">
                <div class="d-flex">
                    <div class="ai-avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 35px; height: 35px; font-size: 14px;">
                        🤖
                    </div>
                    <div class="ai-message-content">
                        <div class="bg-light rounded p-2">
                            <strong>ИИ Помощник:</strong><br>
                            Форма очищена! Готов помочь создать новый товар. Начнем сначала? 🚀
                        </div>
                        <small class="text-muted">Только что</small>
                    </div>
                </div>
            </div>
        `;

        showNotification('Форма очищена!', 'info');
    }
}

// ИИ функции для изображений (заглушки)
function aiGenerateImage() {
    addAIMessage("Генерация изображений с помощью ИИ будет доступна в следующих версиях! А пока загрузите фото вручную 📸");
}

function aiEnhanceImages() {
    if (galleryImages.length === 0 && !document.getElementById('mainImagePath').value) {
        showNotification('Сначала загрузите изображения', 'warning');
        return;
    }

    addAIMessage("Функция улучшения качества изображений в разработке! Скоро будет доступна автоматическая оптимизация фото 🎨");
}

function aiRemoveBackground() {
    addAIMessage("Автоматическое удаление фона будет доступно в премиум версии! Это поможет создавать профессиональные фото товаров ✂️");
}

function aiOptimizeImages() {
    addAIMessage("Оптимизация размера изображений поможет ускорить загрузку сайта. Функция будет добавлена в следующих обновлениях 🚀");
}
</script>
