<?php
session_start();

// Проверка на уже установленную систему
if (file_exists('config/database.php') && file_exists('config/.installed')) {
    die('Система уже установлена! Удалите файл config/.installed для переустановки.');
}

$step = isset($_GET['step']) ? (int)$_GET['step'] : 1;
$errors = [];
$success = [];

// Обработка POST запросов
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    switch ($step) {
        case 2: // Проверка БД
            $db_host = trim($_POST['db_host']);
            $db_name = trim($_POST['db_name']);
            $db_user = trim($_POST['db_user']);
            $db_pass = trim($_POST['db_pass']);

            try {
                // ИСПРАВЛЕНО: Подключаемся только к уже созданной БД (БЕЗ СОЗДАНИЯ!)
                $pdo = new PDO("mysql:host={$db_host};dbname={$db_name};charset=utf8mb4",
                              $db_user, $db_pass, [
                    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
                    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
                    PDO::ATTR_EMULATE_PREPARES => false
                ]);

                // Проверяем права на создание таблиц
                $pdo->query('CREATE TEMPORARY TABLE test_permissions (id INT)');
                $pdo->query('DROP TEMPORARY TABLE test_permissions');

                // Проверяем версию MySQL
                $mysql_version = $pdo->query('SELECT VERSION()')->fetchColumn();

                // Сохраняем данные в сессии
                $_SESSION['db_config'] = compact('db_host', 'db_name', 'db_user', 'db_pass');
                $_SESSION['mysql_version'] = $mysql_version;

                $success[] = 'Подключение к базе данных успешно! MySQL ' . $mysql_version;
                $step = 3;
            } catch (PDOException $e) {
                if (strpos($e->getMessage(), 'Unknown database') !== false) {
                    $errors[] = 'База данных "' . $db_name . '" не найдена! Создайте её в панели управления хостингом.';
                } elseif (strpos($e->getMessage(), 'Access denied') !== false) {
                    $errors[] = 'Неверные данные доступа к БД. Проверьте логин и пароль.';
                } elseif (strpos($e->getMessage(), 'No such file or directory') !== false) {
                    $errors[] = 'Не удается подключиться к серверу MySQL. Проверьте хост.';
                } else {
                    $errors[] = 'Ошибка подключения к БД: ' . $e->getMessage();
                }
            }
            break;

        case 3: // Создание таблиц
            if (isset($_POST['create_tables'])) {
                if (createTables()) {
                    $success[] = 'Структура базы данных создана успешно!';
                    $step = 4;
                } else {
                    $errors[] = 'Ошибка создания таблиц! Проверьте права доступа к БД.';
                }
            }
            break;

        case 4: // Создание админа
            $admin_login = trim($_POST['admin_login']);
            $admin_email = trim($_POST['admin_email']);
            $admin_pass = trim($_POST['admin_pass']);
            $admin_pass2 = trim($_POST['admin_pass2']);

            if (empty($admin_login) || empty($admin_email) || empty($admin_pass)) {
                $errors[] = 'Все поля обязательны для заполнения!';
            } elseif (!filter_var($admin_email, FILTER_VALIDATE_EMAIL)) {
                $errors[] = 'Некорректный email адрес!';
            } elseif ($admin_pass !== $admin_pass2) {
                $errors[] = 'Пароли не совпадают!';
            } elseif (strlen($admin_pass) < 8) {
                $errors[] = 'Пароль должен быть не менее 8 символов!';
            } else {
                if (createAdmin($admin_login, $admin_email, $admin_pass)) {
                    $_SESSION['admin_created'] = ['login' => $admin_login, 'email' => $admin_email];
                    $success[] = 'Администратор создан успешно!';
                    $step = 5;
                } else {
                    $errors[] = 'Ошибка создания администратора! Возможно, логин или email уже заняты.';
                }
            }
            break;

        case 5: // Финализация
            if (isset($_POST['finalize'])) {
                if (finalizeInstallation()) {
                    $success[] = 'Установка завершена успешно!';
                    $step = 6;
                } else {
                    $errors[] = 'Ошибка финализации установки! Проверьте права на запись в папки.';
                }
            }
            break;
    }
}

// Функции установки
function checkRequirements() {
    $requirements = [
        'PHP версия >= 8.0' => version_compare(PHP_VERSION, '8.0.0', '>='),
        'PDO расширение' => extension_loaded('pdo'),
        'PDO MySQL' => extension_loaded('pdo_mysql'),
        'GD расширение' => extension_loaded('gd'),
        'cURL расширение' => extension_loaded('curl'),
        'JSON расширение' => extension_loaded('json'),
        'Zip расширение' => extension_loaded('zip'),
        'OpenSSL расширение' => extension_loaded('openssl'),
        'mbstring расширение' => extension_loaded('mbstring'),
        'fileinfo расширение' => extension_loaded('fileinfo'),
        'Запись в config/' => is_writable('config/') || @mkdir('config/', 0755, true),
        'Запись в uploads/' => is_writable('uploads/') || @mkdir('uploads/', 0755, true),
        'Запись в cache/' => is_writable('cache/') || @mkdir('cache/', 0755, true),
        'Запись в logs/' => is_writable('logs/') || @mkdir('logs/', 0755, true)
    ];

    return $requirements;
}

function createTables() {
    try {
        $db_config = $_SESSION['db_config'];
        $pdo = new PDO("mysql:host={$db_config['db_host']};dbname={$db_config['db_name']};charset=utf8mb4",
                      $db_config['db_user'], $db_config['db_pass'], [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
        ]);

        // ВАЖНО: НЕ СОЗДАЕМ БД, только таблицы в уже существующей БД
        $sql = "
        SET FOREIGN_KEY_CHECKS = 0;

        -- Администраторы
        DROP TABLE IF EXISTS `admins`;
        CREATE TABLE `admins` (
            `id` int(11) NOT NULL AUTO_INCREMENT,
            `login` varchar(50) NOT NULL UNIQUE,
            `email` varchar(100) NOT NULL UNIQUE,
            `password` varchar(255) NOT NULL,
            `role` varchar(20) DEFAULT 'admin',
            `status` tinyint(1) DEFAULT 1,
            `avatar` varchar(255) DEFAULT NULL,
            `last_login` timestamp NULL DEFAULT NULL,
            `login_attempts` int(11) DEFAULT 0,
            `locked_until` timestamp NULL DEFAULT NULL,
            `remember_token` varchar(100) DEFAULT NULL,
            `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,
            `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            PRIMARY KEY (`id`),
            KEY `status` (`status`),
            KEY `role` (`role`),
            KEY `login` (`login`),
            KEY `remember_token` (`remember_token`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

        -- Категории товаров
        DROP TABLE IF EXISTS `categories`;
        CREATE TABLE `categories` (
            `id` int(11) NOT NULL AUTO_INCREMENT,
            `parent_id` int(11) DEFAULT 0,
            `name` varchar(255) NOT NULL,
            `slug` varchar(255) NOT NULL UNIQUE,
            `description` text,
            `image` varchar(255) DEFAULT NULL,
            `sort_order` int(11) DEFAULT 0,
            `status` tinyint(1) DEFAULT 1,
            `seo_title` varchar(255) DEFAULT NULL,
            `seo_description` varchar(500) DEFAULT NULL,
            `seo_keywords` varchar(500) DEFAULT NULL,
            `products_count` int(11) DEFAULT 0,
            `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,
            `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            PRIMARY KEY (`id`),
            KEY `parent_id` (`parent_id`),
            KEY `status` (`status`),
            KEY `slug` (`slug`),
            KEY `sort_order` (`sort_order`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

        -- Товары
        DROP TABLE IF EXISTS `products`;
        CREATE TABLE `products` (
            `id` int(11) NOT NULL AUTO_INCREMENT,
            `category_id` int(11) NOT NULL,
            `name` varchar(255) NOT NULL,
            `slug` varchar(255) NOT NULL UNIQUE,
            `description` longtext,
            `short_description` varchar(500) DEFAULT NULL,
            `price` decimal(10,2) NOT NULL DEFAULT 0.00,
            `old_price` decimal(10,2) DEFAULT NULL,
            `cost_price` decimal(10,2) DEFAULT NULL,
            `sku` varchar(100) DEFAULT NULL,
            `barcode` varchar(100) DEFAULT NULL,
            `stock_quantity` int(11) DEFAULT 0,
            `min_stock` int(11) DEFAULT 5,
            `max_stock` int(11) DEFAULT 1000,
            `weight` decimal(8,3) DEFAULT NULL,
            `dimensions` varchar(100) DEFAULT NULL,
            `images` json,
            `gallery` json,
            `status` tinyint(1) DEFAULT 1,
            `featured` tinyint(1) DEFAULT 0,
            `views` int(11) DEFAULT 0,
            `sales_count` int(11) DEFAULT 0,
            `rating` decimal(3,2) DEFAULT 0.00,
            `reviews_count` int(11) DEFAULT 0,
            `seo_title` varchar(255) DEFAULT NULL,
            `seo_description` varchar(500) DEFAULT NULL,
            `seo_keywords` varchar(500) DEFAULT NULL,
            -- Специфичные поля для аквариумных товаров
            `care_level` enum('easy','medium','hard','expert') DEFAULT 'medium',
            `lighting` enum('low','medium','high','very_high') DEFAULT 'medium',
            `ph_min` decimal(3,1) DEFAULT 6.0,
            `ph_max` decimal(3,1) DEFAULT 8.0,
            `temp_min` int(3) DEFAULT 20,
            `temp_max` int(3) DEFAULT 28,
            `hardness_min` int(3) DEFAULT 1,
            `hardness_max` int(3) DEFAULT 20,
            `co2_required` tinyint(1) DEFAULT 0,
            `growth_rate` enum('very_slow','slow','medium','fast','very_fast') DEFAULT 'medium',
            `placement` enum('foreground','midground','background','floating') DEFAULT 'midground',
            `max_size` varchar(50) DEFAULT NULL,
            `origin` varchar(100) DEFAULT NULL,
            `compatibility` json,
            `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,
            `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            PRIMARY KEY (`id`),
            KEY `category_id` (`category_id`),
            KEY `status` (`status`),
            KEY `featured` (`featured`),
            KEY `slug` (`slug`),
            KEY `price` (`price`),
            KEY `sku` (`sku`),
            KEY `stock_quantity` (`stock_quantity`),
            FULLTEXT KEY `search` (`name`, `description`, `short_description`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

        -- Заказы
        DROP TABLE IF EXISTS `orders`;
        CREATE TABLE `orders` (
            `id` int(11) NOT NULL AUTO_INCREMENT,
            `order_number` varchar(50) NOT NULL UNIQUE,
            `customer_name` varchar(255) NOT NULL,
            `customer_email` varchar(255) NOT NULL,
            `customer_phone` varchar(50) NOT NULL,
            `customer_address` text NOT NULL,
            `customer_city` varchar(100) DEFAULT NULL,
            `customer_postal` varchar(20) DEFAULT NULL,
            `customer_country` varchar(100) DEFAULT 'Россия',
            `total_amount` decimal(10,2) NOT NULL,
            `delivery_cost` decimal(10,2) DEFAULT 0.00,
            `discount_amount` decimal(10,2) DEFAULT 0.00,
            `tax_amount` decimal(10,2) DEFAULT 0.00,
            `status` enum('new','confirmed','processing','packed','shipped','delivered','cancelled','refunded') DEFAULT 'new',
            `payment_method` varchar(50) DEFAULT 'cash',
            `payment_status` enum('pending','paid','failed','refunded','partially_refunded') DEFAULT 'pending',
            `delivery_method` varchar(50) DEFAULT 'courier',
            `delivery_date` date DEFAULT NULL,
            `delivery_time` varchar(20) DEFAULT NULL,
            `notes` text,
            `admin_notes` text,
            `tracking_number` varchar(100) DEFAULT NULL,
            `manager_id` int(11) DEFAULT NULL,
            `source` varchar(50) DEFAULT 'website',
            `ip_address` varchar(45) DEFAULT NULL,
            `user_agent` varchar(500) DEFAULT NULL,
            `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,
            `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            PRIMARY KEY (`id`),
            UNIQUE KEY `order_number` (`order_number`),
            KEY `status` (`status`),
            KEY `payment_status` (`payment_status`),
            KEY `created_at` (`created_at`),
            KEY `customer_email` (`customer_email`),
            KEY `manager_id` (`manager_id`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

        -- Позиции заказа
        DROP TABLE IF EXISTS `order_items`;
        CREATE TABLE `order_items` (
            `id` int(11) NOT NULL AUTO_INCREMENT,
            `order_id` int(11) NOT NULL,
            `product_id` int(11) NOT NULL,
            `product_name` varchar(255) NOT NULL,
            `product_sku` varchar(100) DEFAULT NULL,
            `product_price` decimal(10,2) NOT NULL,
            `quantity` int(11) NOT NULL DEFAULT 1,
            `total_price` decimal(10,2) NOT NULL,
            PRIMARY KEY (`id`),
            KEY `order_id` (`order_id`),
            KEY `product_id` (`product_id`),
            FOREIGN KEY (`order_id`) REFERENCES `orders` (`id`) ON DELETE CASCADE
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

        -- Отзывы
        DROP TABLE IF EXISTS `reviews`;
        CREATE TABLE `reviews` (
            `id` int(11) NOT NULL AUTO_INCREMENT,
            `product_id` int(11) NOT NULL,
            `order_id` int(11) DEFAULT NULL,
            `customer_name` varchar(255) NOT NULL,
            `customer_email` varchar(255) NOT NULL,
            `rating` tinyint(1) NOT NULL DEFAULT 5,
            `title` varchar(255) DEFAULT NULL,
            `comment` text,
            `pros` text,
            `cons` text,
            `images` json,
            `status` enum('pending','approved','rejected','spam') DEFAULT 'pending',
            `helpful_count` int(11) DEFAULT 0,
            `unhelpful_count` int(11) DEFAULT 0,
            `verified_purchase` tinyint(1) DEFAULT 0,
            `admin_reply` text,
            `replied_at` timestamp NULL DEFAULT NULL,
            `ip_address` varchar(45) DEFAULT NULL,
            `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,
            `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            PRIMARY KEY (`id`),
            KEY `product_id` (`product_id`),
            KEY `order_id` (`order_id`),
            KEY `status` (`status`),
            KEY `rating` (`rating`),
            KEY `created_at` (`created_at`),
            FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE CASCADE,
            FOREIGN KEY (`order_id`) REFERENCES `orders` (`id`) ON DELETE SET NULL
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

        -- Настройки сайта
        DROP TABLE IF EXISTS `settings`;
        CREATE TABLE `settings` (
            `key` varchar(100) NOT NULL,
            `value` longtext,
            `type` varchar(20) DEFAULT 'string',
            `group` varchar(50) DEFAULT 'general',
            `description` varchar(500) DEFAULT NULL,
            `sort_order` int(11) DEFAULT 0,
            `is_public` tinyint(1) DEFAULT 0,
            `is_required` tinyint(1) DEFAULT 0,
            `validation_rules` varchar(255) DEFAULT NULL,
            PRIMARY KEY (`key`),
            KEY `group` (`group`),
            KEY `is_public` (`is_public`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

        -- Новости/статьи
        DROP TABLE IF EXISTS `news`;
        CREATE TABLE `news` (
            `id` int(11) NOT NULL AUTO_INCREMENT,
            `title` varchar(255) NOT NULL,
            `slug` varchar(255) NOT NULL UNIQUE,
            `excerpt` varchar(500) DEFAULT NULL,
            `content` longtext,
            `image` varchar(255) DEFAULT NULL,
            `gallery` json,
            `status` tinyint(1) DEFAULT 1,
            `featured` tinyint(1) DEFAULT 0,
            `views` int(11) DEFAULT 0,
            `likes` int(11) DEFAULT 0,
            `seo_title` varchar(255) DEFAULT NULL,
            `seo_description` varchar(500) DEFAULT NULL,
            `seo_keywords` varchar(500) DEFAULT NULL,
            `tags` varchar(500) DEFAULT NULL,
            `author_id` int(11) DEFAULT NULL,
            `category` varchar(100) DEFAULT 'general',
            `reading_time` int(11) DEFAULT 0,
            `published_at` timestamp DEFAULT CURRENT_TIMESTAMP,
            `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,
            `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            PRIMARY KEY (`id`),
            UNIQUE KEY `slug` (`slug`),
            KEY `status` (`status`),
            KEY `featured` (`featured`),
            KEY `author_id` (`author_id`),
            KEY `category` (`category`),
            KEY `published_at` (`published_at`),
            FULLTEXT KEY `search` (`title`, `excerpt`, `content`),
            FOREIGN KEY (`author_id`) REFERENCES `admins` (`id`) ON DELETE SET NULL
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

        -- Корзина для незарегистрированных
        DROP TABLE IF EXISTS `cart`;
        CREATE TABLE `cart` (
            `id` int(11) NOT NULL AUTO_INCREMENT,
            `session_id` varchar(128) NOT NULL,
            `product_id` int(11) NOT NULL,
            `quantity` int(11) NOT NULL DEFAULT 1,
            `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,
            `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            PRIMARY KEY (`id`),
            UNIQUE KEY `session_product` (`session_id`, `product_id`),
            KEY `session_id` (`session_id`),
            KEY `product_id` (`product_id`),
            KEY `created_at` (`created_at`),
            FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE CASCADE
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

        -- Избранное
        DROP TABLE IF EXISTS `wishlist`;
        CREATE TABLE `wishlist` (
            `id` int(11) NOT NULL AUTO_INCREMENT,
            `session_id` varchar(128) NOT NULL,
            `product_id` int(11) NOT NULL,
            `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (`id`),
            UNIQUE KEY `session_product` (`session_id`, `product_id`),
            KEY `session_id` (`session_id`),
            KEY `product_id` (`product_id`),
            FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE CASCADE
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

        -- Сравнение товаров
        DROP TABLE IF EXISTS `compare`;
        CREATE TABLE `compare` (
            `id` int(11) NOT NULL AUTO_INCREMENT,
            `session_id` varchar(128) NOT NULL,
            `product_id` int(11) NOT NULL,
            `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (`id`),
            UNIQUE KEY `session_product` (`session_id`, `product_id`),
            KEY `session_id` (`session_id`),
            KEY `product_id` (`product_id`),
            FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE CASCADE
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

        -- Статистика и аналитика
        DROP TABLE IF EXISTS `analytics`;
        CREATE TABLE `analytics` (
            `id` bigint(20) NOT NULL AUTO_INCREMENT,
            `event_type` varchar(50) NOT NULL,
            `event_data` json,
            `session_id` varchar(128) DEFAULT NULL,
            `ip_address` varchar(45) DEFAULT NULL,
            `user_agent` text,
            `referer` text,
            `page_url` varchar(500) DEFAULT NULL,
            `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (`id`),
            KEY `event_type` (`event_type`),
            KEY `session_id` (`session_id`),
            KEY `created_at` (`created_at`),
            KEY `ip_address` (`ip_address`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

        -- Купоны и скидки
        DROP TABLE IF EXISTS `coupons`;
        CREATE TABLE `coupons` (
            `id` int(11) NOT NULL AUTO_INCREMENT,
            `code` varchar(50) NOT NULL UNIQUE,
            `name` varchar(255) NOT NULL,
            `type` enum('fixed','percent') NOT NULL DEFAULT 'fixed',
            `value` decimal(10,2) NOT NULL,
            `min_amount` decimal(10,2) DEFAULT 0.00,
            `max_discount` decimal(10,2) DEFAULT NULL,
            `usage_limit` int(11) DEFAULT NULL,
            `used_count` int(11) DEFAULT 0,
            `usage_limit_per_customer` int(11) DEFAULT 1,
            `valid_from` timestamp DEFAULT CURRENT_TIMESTAMP,
            `valid_until` timestamp NULL DEFAULT NULL,
            `status` tinyint(1) DEFAULT 1,
            `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,
            `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            PRIMARY KEY (`id`),
            UNIQUE KEY `code` (`code`),
            KEY `status` (`status`),
            KEY `valid_from` (`valid_from`),
            KEY `valid_until` (`valid_until`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

        -- История использования купонов
        DROP TABLE IF EXISTS `coupon_usage`;
        CREATE TABLE `coupon_usage` (
            `id` int(11) NOT NULL AUTO_INCREMENT,
            `coupon_id` int(11) NOT NULL,
            `order_id` int(11) NOT NULL,
            `customer_email` varchar(255) NOT NULL,
            `discount_amount` decimal(10,2) NOT NULL,
            `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (`id`),
            KEY `coupon_id` (`coupon_id`),
            KEY `order_id` (`order_id`),
            KEY `customer_email` (`customer_email`),
            FOREIGN KEY (`coupon_id`) REFERENCES `coupons` (`id`) ON DELETE CASCADE,
            FOREIGN KEY (`order_id`) REFERENCES `orders` (`id`) ON DELETE CASCADE
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

        -- Подписки на рассылку
        DROP TABLE IF EXISTS `newsletter_subscribers`;
        CREATE TABLE `newsletter_subscribers` (
            `id` int(11) NOT NULL AUTO_INCREMENT,
            `email` varchar(255) NOT NULL UNIQUE,
            `name` varchar(255) DEFAULT NULL,
            `status` enum('active','inactive','unsubscribed') DEFAULT 'active',
            `subscribed_at` timestamp DEFAULT CURRENT_TIMESTAMP,
            `unsubscribed_at` timestamp NULL DEFAULT NULL,
            `source` varchar(50) DEFAULT 'website',
            `preferences` json,
            PRIMARY KEY (`id`),
            UNIQUE KEY `email` (`email`),
            KEY `status` (`status`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

        -- Логи системы
        DROP TABLE IF EXISTS `system_logs`;
        CREATE TABLE `system_logs` (
            `id` bigint(20) NOT NULL AUTO_INCREMENT,
            `level` enum('emergency','alert','critical','error','warning','notice','info','debug') NOT NULL,
            `message` text NOT NULL,
            `context` json,
            `channel` varchar(50) DEFAULT 'general',
            `admin_id` int(11) DEFAULT NULL,
            `ip_address` varchar(45) DEFAULT NULL,
            `user_agent` varchar(500) DEFAULT NULL,
            `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (`id`),
            KEY `level` (`level`),
            KEY `channel` (`channel`),
            KEY `admin_id` (`admin_id`),
            KEY `created_at` (`created_at`),
            FOREIGN KEY (`admin_id`) REFERENCES `admins` (`id`) ON DELETE SET NULL
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

        SET FOREIGN_KEY_CHECKS = 1;
        ";

        // Выполняем SQL по частям
        $statements = array_filter(array_map('trim', explode(';', $sql)));
        foreach ($statements as $statement) {
            if (!empty($statement)) {
                $pdo->exec($statement);
            }
        }

        // Добавляем расширенные базовые настройки
        $settings = [
            // Основные настройки
            ['site_name', 'АкваСбор - аквариумы и растения', 'string', 'general', 'Название сайта', 1, 1, 1, 'required|max:255'],
            ['site_description', 'Интернет-магазин аквариумных растений, рыбок и оборудования', 'string', 'general', 'Описание сайта', 2, 1, 1, 'required|max:500'],
            ['site_keywords', 'аквариумные растения, рыбки, аквариум, оборудование', 'string', 'general', 'Ключевые слова', 3, 1, 0, 'max:500'],
            ['site_logo', '', 'file', 'general', 'Логотип сайта', 4, 1, 0, 'image|max:2MB'],
            ['site_favicon', '', 'file', 'general', 'Иконка сайта (favicon)', 5, 1, 0, 'image|max:1MB'],

            // Контакты
            ['contact_email', 'info@akvasbor.ru', 'email', 'contacts', 'Email для связи', 1, 1, 1, 'required|email'],
            ['contact_phone', '+7 (999) 123-45-67', 'string', 'contacts', 'Телефон магазина', 2, 1, 1, 'required'],
            ['contact_address', 'г. Москва, ул. Примерная, д. 1', 'string', 'contacts', 'Адрес магазина', 3, 1, 0, 'max:500'],
            ['contact_working_hours', 'Пн-Пт: 9:00-19:00, Сб: 10:00-17:00', 'string', 'contacts', 'Время работы', 4, 1, 0, 'max:255'],
            ['contact_manager_name', 'Анна Петрова', 'string', 'contacts', 'Имя менеджера', 5, 1, 0, 'max:255'],

            // Настройки магазина
            ['currency_symbol', '₽', 'string', 'shop', 'Символ валюты', 1, 1, 1, 'required|max:5'],
            ['currency_code', 'RUB', 'string', 'shop', 'Код валюты', 2, 1, 1, 'required|max:3'],
            ['products_per_page', '12', 'number', 'shop', 'Товаров на странице каталога', 3, 0, 0, 'integer|min:4|max:50'],
            ['delivery_cost', '350', 'number', 'shop', 'Стоимость доставки (руб.)', 4, 1, 1, 'numeric|min:0'],
            ['free_delivery_from', '3000', 'number', 'shop', 'Бесплатная доставка от суммы (руб.)', 5, 1, 1, 'numeric|min:0'],
            ['min_order_amount', '500', 'number', 'shop', 'Минимальная сумма заказа (руб.)', 6, 1, 1, 'numeric|min:0'],
            ['max_order_amount', '100000', 'number', 'shop', 'Максимальная сумма заказа (руб.)', 7, 0, 0, 'numeric|min:1000'],
            ['auto_reserve_stock', '1', 'boolean', 'shop', 'Автоматически резервировать товар при заказе', 8, 0, 0, 'boolean'],
            ['show_out_of_stock', '1', 'boolean', 'shop', 'Показывать товары отсутствующие на складе', 9, 0, 0, 'boolean'],

            // Дизайн и внешний вид
            ['theme_primary_color', '#28a745', 'color', 'design', 'Основной цвет темы', 1, 0, 0, 'hex_color'],
            ['theme_secondary_color', '#6c757d', 'color', 'design', 'Вторичный цвет', 2, 0, 0, 'hex_color'],
            ['theme_success_color', '#28a745', 'color', 'design', 'Цвет успеха', 3, 0, 0, 'hex_color'],
            ['theme_warning_color', '#ffc107', 'color', 'design', 'Цвет предупреждения', 4, 0, 0, 'hex_color'],
            ['theme_danger_color', '#dc3545', 'color', 'design', 'Цвет ошибки', 5, 0, 0, 'hex_color'],
            ['show_prices', '1', 'boolean', 'design', 'Показывать цены на сайте', 6, 0, 1, 'boolean'],
            ['show_stock_count', '1', 'boolean', 'design', 'Показывать количество на складе', 7, 0, 0, 'boolean'],
            ['enable_reviews', '1', 'boolean', 'design', 'Включить систему отзывов', 8, 0, 0, 'boolean'],
            ['enable_ratings', '1', 'boolean', 'design', 'Включить рейтинги товаров', 9, 0, 0, 'boolean'],
            ['enable_wishlist', '1', 'boolean', 'design', 'Включить список желаний', 10, 0, 0, 'boolean'],
            ['enable_compare', '1', 'boolean', 'design', 'Включить сравнение товаров', 11, 0, 0, 'boolean'],
            ['product_image_quality', '85', 'number', 'design', 'Качество изображений товаров (%)', 12, 0, 0, 'integer|min:50|max:100'],

            // SEO настройки
            ['seo_title_suffix', ' — АкваСбор: аквариумные растения и товары', 'string', 'seo', 'Суффикс для заголовков страниц', 1, 0, 0, 'max:100'],
            ['seo_default_image', '', 'file', 'seo', 'Изображение по умолчанию для соцсетей', 2, 0, 0, 'image|max:2MB'],
            ['google_analytics_id', '', 'string', 'seo', 'Google Analytics ID (GA4)', 3, 0, 0, 'max:50'],
            ['yandex_metrica_id', '', 'string', 'seo', 'Яндекс.Метрика ID', 4, 0, 0, 'max:50'],
            ['google_tag_manager', '', 'string', 'seo', 'Google Tag Manager ID', 5, 0, 0, 'max:50'],
            ['enable_sitemap', '1', 'boolean', 'seo', 'Автоматически генерировать sitemap.xml', 6, 0, 0, 'boolean'],
            ['enable_schema_markup', '1', 'boolean', 'seo', 'Включить микроразметку Schema.org', 7, 0, 0, 'boolean'],

            // Социальные сети
            ['social_vk', 'https://vk.com/akvasbor', 'url', 'social', 'ВКонтакте', 1, 1, 0, 'url'],
            ['social_instagram', 'https://instagram.com/akvasbor', 'url', 'social', 'Instagram', 2, 1, 0, 'url'],
            ['social_telegram', 'https://t.me/akvasbor', 'url', 'social', 'Telegram', 3, 1, 0, 'url'],
            ['social_youtube', '', 'url', 'social', 'YouTube', 4, 1, 0, 'url'],
            ['social_facebook', '', 'url', 'social', 'Facebook', 5, 1, 0, 'url'],
            ['social_whatsapp', '+79991234567', 'string', 'social', 'WhatsApp (номер телефона)', 6, 1, 0, 'max:20'],
            ['social_viber', '', 'string', 'social', 'Viber', 7, 1, 0, 'max:50'],

            // Уведомления
            ['notification_new_order', '1', 'boolean', 'notifications', 'Уведомления о новых заказах', 1, 0, 1, 'boolean'],
            ['notification_low_stock', '1', 'boolean', 'notifications', 'Уведомления о низком остатке', 2, 0, 0, 'boolean'],
            ['notification_new_review', '1', 'boolean', 'notifications', 'Уведомления о новых отзывах', 3, 0, 0, 'boolean'],
            ['notification_email', 'admin@akvasbor.ru', 'email', 'notifications', 'Email для уведомлений', 4, 0, 1, 'required|email'],
            ['notification_telegram_bot_token', '', 'string', 'notifications', 'Токен Telegram бота', 5, 0, 0, 'max:100'],
            ['notification_telegram_chat_id', '', 'string', 'notifications', 'ID чата Telegram', 6, 0, 0, 'max:50'],

            // Платежи
            ['payment_cash', '1', 'boolean', 'payments', 'Оплата наличными при получении', 1, 1, 0, 'boolean'],
            ['payment_card_courier', '1', 'boolean', 'payments', 'Оплата картой курьеру', 2, 1, 0, 'boolean'],
            ['payment_online', '0', 'boolean', 'payments', 'Онлайн оплата', 3, 1, 0, 'boolean'],
            ['payment_bank_transfer', '1', 'boolean', 'payments', 'Банковский перевод', 4, 1, 0, 'boolean'],
            ['payment_min_online_amount', '1000', 'number', 'payments', 'Минимальная сумма для онлайн оплаты', 5, 0, 0, 'numeric|min:0'],

            // Доставка
            ['delivery_courier', '1', 'boolean', 'delivery', 'Курьерская доставка', 1, 1, 0, 'boolean'],
            ['delivery_pickup', '1', 'boolean', 'delivery', 'Самовывоз', 2, 1, 0, 'boolean'],
            ['delivery_post', '1', 'boolean', 'delivery', 'Почта России', 3, 1, 0, 'boolean'],
            ['delivery_time_from', '10:00', 'time', 'delivery', 'Доставка с (время)', 4, 1, 0, 'time'],
            ['delivery_time_to', '20:00', 'time', 'delivery', 'Доставка до (время)', 5, 1, 0, 'time'],
            ['delivery_days_min', '1', 'number', 'delivery', 'Минимальный срок доставки (дней)', 6, 1, 0, 'integer|min:0'],
            ['delivery_days_max', '3', 'number', 'delivery', 'Максимальный срок доставки (дней)', 7, 1, 0, 'integer|min:1'],

            // Технические настройки
            ['cache_enabled', '1', 'boolean', 'technical', 'Включить кэширование', 1, 0, 0, 'boolean'],
            ['cache_lifetime', '3600', 'number', 'technical', 'Время жизни кэша (секунды)', 2, 0, 0, 'integer|min:300'],
            ['maintenance_mode', '0', 'boolean', 'technical', 'Режим технического обслуживания', 3, 0, 0, 'boolean'],
            ['debug_mode', '0', 'boolean', 'technical', 'Режим отладки', 4, 0, 0, 'boolean'],
            ['session_lifetime', '7200', 'number', 'technical', 'Время жизни сессии (секунды)', 5, 0, 0, 'integer|min:1800'],
            ['max_upload_size', '10', 'number', 'technical', 'Максимальный размер загружаемого файла (МБ)', 6, 0, 0, 'integer|min:1|max:100'],
            ['image_max_width', '1920', 'number', 'technical', 'Максимальная ширина изображения (px)', 7, 0, 0, 'integer|min:800'],
            ['image_max_height', '1080', 'number', 'technical', 'Максимальная высота изображения (px)', 8, 0, 0, 'integer|min:600'],
            ['thumbnail_size', '300', 'number', 'technical', 'Размер миниатюр (px)', 9, 0, 0, 'integer|min:100|max:500'],
            ['logs_retention_days', '90', 'number', 'technical', 'Хранение логов (дней)', 10, 0, 0, 'integer|min:7'],

            // API настройки
            ['api_enabled', '0', 'boolean', 'api', 'Включить API', 1, 0, 0, 'boolean'],
            ['api_rate_limit', '100', 'number', 'api', 'Лимит запросов в час', 2, 0, 0, 'integer|min:10'],
            ['api_key', '', 'string', 'api', 'Ключ API', 3, 0, 0, 'max:100'],

            // Интеграции
            ['integration_1c', '0', 'boolean', 'integrations', 'Интеграция с 1С', 1, 0, 0, 'boolean'],
            ['integration_crm', '0', 'boolean', 'integrations', 'Интеграция с CRM', 2, 0, 0, 'boolean'],
            ['integration_marketplace', '0', 'boolean', 'integrations', 'Интеграция с маркетплейсами', 3, 0, 0, 'boolean']
        ];

        $stmt = $pdo->prepare('INSERT INTO settings (`key`, value, type, `group`, description, sort_order, is_public, is_required, validation_rules) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) ON DUPLICATE KEY UPDATE value = VALUES(value)');
        foreach ($settings as $setting) {
            $stmt->execute($setting);
        }

        return true;
    } catch (Exception $e) {
        error_log('Ошибка создания таблиц: ' . $e->getMessage());
        return false;
    }
}

function createAdmin($login, $email, $password) {
    try {
        $db_config = $_SESSION['db_config'];
        $pdo = new PDO("mysql:host={$db_config['db_host']};dbname={$db_config['db_name']};charset=utf8mb4",
                      $db_config['db_user'], $db_config['db_pass'], [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION
        ]);

        $stmt = $pdo->prepare('INSERT INTO admins (login, email, password, role, status) VALUES (?, ?, ?, ?, 1)');
        return $stmt->execute([$login, $email, password_hash($password, PASSWORD_DEFAULT), 'super_admin']);
    } catch (Exception $e) {
        error_log('Ошибка создания админа: ' . $e->getMessage());
        return false;
    }
}

function finalizeInstallation() {
    try {
        $db_config = $_SESSION['db_config'];
        $mysql_version = $_SESSION['mysql_version'] ?? 'Unknown';

        // Создаем расширенный конфиг БД
        $config_content = '<?php
return [
    \'default\' => \'mysql\',
    \'connections\' => [
        \'mysql\' => [
            \'driver\' => \'mysql\',
            \'host\' => \'' . $db_config['db_host'] . '\',
            \'port\' => 3306,
            \'database\' => \'' . $db_config['db_name'] . '\',
            \'username\' => \'' . $db_config['db_user'] . '\',
            \'password\' => \'' . addslashes($db_config['db_pass']) . '\',
            \'charset\' => \'utf8mb4\',
            \'collation\' => \'utf8mb4_unicode_ci\',
            \'prefix\' => \'\',
            \'strict\' => true,
            \'engine\' => \'InnoDB\',
            \'options\' => [
                PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
                PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
                PDO::ATTR_EMULATE_PREPARES => false,
                PDO::ATTR_PERSISTENT => false,
                PDO::MYSQL_ATTR_SSL_VERIFY_SERVER_CERT => false,
                PDO::MYSQL_ATTR_INIT_COMMAND => "SET sql_mode=\'STRICT_TRANS_TABLES,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO\'"
            ]
        ]
    ]
];';
        file_put_contents('config/database.php', $config_content);

        // Создаем расширенный конфиг приложения
        $app_config = '<?php
return [
    \'name\' => \'АкваСбор CMS\',
    \'version\' => \'2.0.0\',
    \'environment\' => \'production\',
    \'debug\' => false,
    \'timezone\' => \'Europe/Moscow\',
    \'locale\' => \'ru\',
    \'fallback_locale\' => \'en\',

    \'security\' => [
        \'encryption_key\' => \'' . bin2hex(random_bytes(32)) . '\',
        \'password_min_length\' => 8,
        \'password_require_special\' => true,
        \'password_require_numbers\' => true,
        \'password_require_mixed_case\' => true,
        \'max_login_attempts\' => 5,
        \'lockout_time\' => 900, // 15 минут
        \'session_lifetime\' => 7200, // 2 часа
        \'remember_me_time\' => 2592000, // 30 дней
        \'csrf_token_lifetime\' => 3600, // 1 час
        \'rate_limit_requests\' => 100,
        \'rate_limit_time\' => 3600 // 1 час
    ],

    \'upload\' => [
        \'max_size\' => 10 * 1024 * 1024, // 10MB
        \'allowed_extensions\' => [\'jpg\', \'jpeg\', \'png\', \'webp\', \'gif\', \'svg\'],
        \'path\' => \'uploads/\',
        \'temp_path\' => \'uploads/temp/\',
        \'image_quality\' => 85,
        \'create_thumbnails\' => true,
        \'thumbnail_sizes\' => [150, 300, 600, 1200],
        \'watermark_enabled\' => false,
        \'watermark_position\' => \'bottom-right\',
        \'watermark_opacity\' => 70
    ],

    \'cache\' => [
        \'enabled\' => true,
        \'driver\' => \'file\',
        \'lifetime\' => 3600, // 1 час
        \'path\' => \'cache/\',
        \'prefix\' => \'akvas_\',
        \'compress\' => true,
        \'serialize\' => true
    ],

    \'session\' => [
        \'driver\' => \'file\',
        \'lifetime\' => 7200, // 2 часа
        \'path\' => \'storage/sessions/\',
        \'cookie_name\' => \'AKVASBOR_SESSION\',
        \'cookie_path\' => \'/\',
        \'cookie_domain\' => null,
        \'cookie_secure\' => false,
        \'cookie_httponly\' => true,
        \'cookie_samesite\' => \'Lax\'
    ],

    \'pagination\' => [
        \'per_page\' => 12,
        \'max_links\' => 7,
        \'page_name\' => \'page\',
        \'admin_per_page\' => 25
    ],

    \'image\' => [
        \'quality\' => 85,
        \'max_width\' => 1920,
        \'max_height\' => 1080,
        \'thumbnail_size\' => 300,
        \'lazy_loading\' => true,
        \'webp_support\' => true,
        \'progressive_jpeg\' => true,
        \'strip_metadata\' => true
    ],

    \'seo\' => [
        \'robots_txt\' => true,
        \'sitemap_xml\' => true,
        \'canonical_urls\' => true,
        \'meta_title_max_length\' => 60,
        \'meta_description_max_length\' => 160,
        \'structured_data\' => true,
        \'open_graph\' => true,
        \'twitter_cards\' => true
    ],

    \'mail\' => [
        \'driver\' => \'smtp\',
        \'host\' => \'smtp.gmail.com\',
        \'port\' => 587,
        \'username\' => \'\',
        \'password\' => \'\',
        \'encryption\' => \'tls\',
        \'from\' => [\'address\' => \'noreply@akvasbor.ru\', \'name\' => \'АкваСбор\'],
        \'reply_to\' => [\'address\' => \'info@akvasbor.ru\', \'name\' => \'АкваСбор\']
    ],

    \'logging\' => [
        \'enabled\' => true,
        \'level\' => \'warning\', // emergency, alert, critical, error, warning, notice, info, debug
        \'max_files\' => 30,
        \'path\' => \'logs/\',
        \'single_file\' => false,
        \'daily_rotation\' => true
    ]
];';
        file_put_contents('config/app.php', $app_config);

        // Создаем конфиг модулей
        $modules_content = '<?php
return [
    \'frontend\' => [
        \'catalog\' => [
            \'enabled\' => true,
            \'cache_enabled\' => true,
            \'cache_lifetime\' => 3600,
            \'per_page\' => 12,
            \'max_per_page\' => 48,
            \'sorting_options\' => [\'price_asc\', \'price_desc\', \'name_asc\', \'name_desc\', \'rating\', \'popularity\', \'newest\'],
            \'filter_by_price\' => true,
            \'filter_by_attributes\' => true,
            \'filter_by_brands\' => true,
            \'infinite_scroll\' => false,
            \'lazy_loading\' => true
        ],

        \'product\' => [
            \'enabled\' => true,
            \'related_products\' => 4,
            \'recently_viewed\' => 8,
            \'image_zoom\' => true,
            \'video_support\' => true,
            \'360_view\' => false,
            \'stock_warning_threshold\' => 5,
            \'show_sku\' => true,
            \'show_barcode\' => false
        ],

        \'cart\' => [
            \'enabled\' => true,
            \'session_lifetime\' => 86400, // 24 часа
            \'min_quantity\' => 1,
            \'max_quantity\' => 999,
            \'auto_remove_unavailable\' => true,
            \'save_for_later\' => true,
            \'cross_sell_products\' => 3,
            \'ajax_add_to_cart\' => true,
            \'show_recommendations\' => true
        ],

        \'checkout\' => [
            \'enabled\' => true,
            \'guest_checkout\' => true,
            \'require_phone\' => true,
            \'require_email\' => true,
            \'payment_methods\' => [\'cash\', \'card_courier\', \'bank_transfer\'],
            \'delivery_methods\' => [\'courier\', \'pickup\', \'post\'],
            \'order_notes\' => true,
            \'newsletter_subscribe\' => true,
            \'terms_acceptance\' => true
        ],

        \'search\' => [
            \'enabled\' => true,
            \'min_length\' => 2,
            \'max_results\' => 50,
            \'search_in_description\' => true,
            \'search_suggestions\' => true,
            \'search_history\' => true,
            \'typo_tolerance\' => true,
            \'highlight_results\' => true
        ],

        \'news\' => [
            \'enabled\' => true,
            \'per_page\' => 10,
            \'allow_comments\' => false,
            \'social_sharing\' => true,
            \'reading_time\' => true,
            \'related_articles\' => 3,
            \'rss_feed\' => true
        ],

        \'reviews\' => [
            \'enabled\' => true,
            \'require_moderation\' => true,
            \'allow_anonymous\' => true,
            \'require_email\' => true,
            \'max_images\' => 5,
            \'image_max_size\' => 5242880, // 5MB
            \'rating_required\' => true,
            \'helpful_voting\' => true,
            \'sort_options\' => [\'newest\', \'oldest\', \'highest_rating\', \'lowest_rating\', \'most_helpful\']
        ],

        \'wishlist\' => [
            \'enabled\' => true,
            \'max_items\' => 100,
            \'share_wishlist\' => true,
            \'email_notifications\' => true,
            \'price_drop_alerts\' => true,
            \'stock_alerts\' => true
        ],

        \'compare\' => [
            \'enabled\' => true,
            \'max_items\' => 4,
            \'show_differences_only\' => false,
            \'print_comparison\' => true,
            \'email_comparison\' => true
        ],

        \'newsletter\' => [
            \'enabled\' => true,
            \'double_opt_in\' => true,
            \'welcome_email\' => true,
            \'unsubscribe_page\' => true,
            \'subscription_preferences\' => true
        ]
    ],

    \'admin\' => [
        \'dashboard\' => [
            \'enabled\' => true,
            \'refresh_interval\' => 300, // 5 минут
            \'show_statistics\' => true,
            \'show_recent_orders\' => 10,
            \'show_low_stock\' => 5,
            \'show_recent_reviews\' => 5,
            \'charts_enabled\' => true
        ],

        \'products\' => [
            \'enabled\' => true,
            \'per_page\' => 25,
            \'bulk_actions\' => true,
            \'export_formats\' => [\'xlsx\', \'csv\', \'xml\'],
            \'import_formats\' => [\'xlsx\', \'csv\'],
            \'duplicate_products\' => true,
            \'product_variants\' => false, // Пока отключено
            \'auto_sku_generation\' => true,
            \'barcode_generation\' => false
        ],

        \'categories\' => [
            \'enabled\' => true,
            \'nested_categories\' => true,
            \'max_depth\' => 3,
            \'drag_drop_sorting\' => true,
            \'category_tree\' => true,
            \'bulk_operations\' => true
        ],

        \'orders\' => [
            \'enabled\' => true,
            \'per_page\' => 25,
            \'auto_status_updates\' => false,
            \'email_notifications\' => true,
            \'sms_notifications\' => false,
            \'order_tracking\' => true,
            \'print_invoices\' => true,
            \'export_orders\' => true,
            \'refund_management\' => true
        ],

        \'customers\' => [
            \'enabled\' => false, // Пока отключено (нет регистрации)
            \'customer_groups\' => false,
            \'loyalty_program\' => false,
            \'customer_notes\' => true
        ],

        \'reviews\' => [
            \'enabled\' => true,
            \'per_page\' => 25,
            \'auto_approve\' => false,
            \'spam_filtering\' => true,
            \'bulk_moderation\' => true,
            \'review_templates\' => true
        ],

        \'analytics\' => [
            \'enabled\' => true,
            \'retention_days\' => 365,
            \'real_time_stats\' => true,
            \'conversion_tracking\' => true,
            \'goal_tracking\' => true,
            \'export_reports\' => true,
            \'scheduled_reports\' => false
        ],

        \'marketing\' => [
            \'enabled\' => true,
            \'coupons\' => true,
            \'banners\' => true,
            \'email_campaigns\' => false,
            \'abandoned_cart\' => true,
            \'price_rules\' => false
        ],

        \'settings\' => [
            \'enabled\' => true,
            \'backup_settings\' => true,
            \'import_settings\' => true,
            \'export_settings\' => true,
            \'settings_history\' => true
        ],

        \'seo\' => [
            \'enabled\' => true,
            \'sitemap_generation\' => true,
            \'robots_txt\' => true,
            \'meta_templates\' => true,
            \'redirect_management\' => true,
            \'broken_link_checker\' => false
        ],

        \'system\' => [
            \'enabled\' => true,
            \'system_info\' => true,
            \'error_logs\' => true,
            \'maintenance_mode\' => true,
            \'database_backup\' => true,
            \'cache_management\' => true,
            \'file_manager\' => false // По соображениям безопасности
        ]
    ],

    \'api\' => [
        \'enabled\' => false, // Пока отключено
        \'version\' => \'v1\',
        \'rate_limit\' => [
            \'requests_per_hour\' => 1000,
            \'requests_per_minute\' => 60,
            \'burst_limit\' => 10
        ],
        \'authentication\' => [
            \'required\' => true,
            \'methods\' => [\'api_key\', \'oauth2\'],
            \'api_key_header\' => \'X-API-Key\'
        ],
        \'endpoints\' => [
            \'products\' => [\'enabled\' => true, \'methods\' => [\'GET\']],
            \'categories\' => [\'enabled\' => true, \'methods\' => [\'GET\']],
            \'orders\' => [\'enabled\' => false, \'methods\' => []],
            \'reviews\' => [\'enabled\' => true, \'methods\' => [\'GET\', \'POST\']]
        ],
        \'response_format\' => \'json\',
        \'pagination\' => [
            \'default_per_page\' => 20,
            \'max_per_page\' => 100
        ]
    ],

    \'integrations\' => [
        \'1c\' => [
            \'enabled\' => false,
            \'import_products\' => true,
            \'export_orders\' => true,
            \'sync_inventory\' => true,
            \'sync_interval\' => 3600 // 1 час
        ],

        \'crm\' => [
            \'enabled\' => false,
            \'export_customers\' => false,
            \'export_orders\' => true,
            \'lead_generation\' => false
        ],

        \'marketplaces\' => [
            \'enabled\' => false,
            \'ozon\' => false,
            \'wildberries\' => false,
            \'yandex_market\' => false,
            \'avito\' => false
        ],

        \'delivery\' => [
            \'cdek\' => false,
            \'pochta_russia\' => false,
            \'boxberry\' => false,
            \'pickpoint\' => false
        ],

        \'payment\' => [
            \'yookassa\' => false,
            \'sberbank\' => false,
            \'tinkoff\' => false,
            \'paypal\' => false
        ]
    ]
];';
        file_put_contents('config/modules.php', $modules_content);

        // Создаем улучшенный .htaccess с защитой и оптимизацией
        $htaccess_content = '# АкваСбор CMS 2.0 - Configuration
# Обновлено: ' . date('Y-m-d H:i:s') . '

Options -Indexes
ServerSignature Off

# Защита от различных атак
<IfModule mod_headers.c>
    # Безопасность заголовков
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

    # Кэширование
    <FilesMatch "\.(ico|pdf|flv|jpg|jpeg|png|gif|webp|svg|js|css|woff|woff2|ttf|eot)$">
        Header set Cache-Control "max-age=2592000, public, immutable"
    </FilesMatch>

    # HTML страницы
    <FilesMatch "\.(html|htm|php)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires 0
    </FilesMatch>
</IfModule>

# Блокировка доступа к служебным файлам и папкам
<FilesMatch "^\.">
    Require all denied
</FilesMatch>

<DirectoryMatch "^.*(config|logs|cache|storage|vendor|node_modules).*">
    Require all denied
</DirectoryMatch>

<FilesMatch "\.(log|sql|md|json|yml|yaml|lock|env|backup)$">
    Require all denied
</FilesMatch>

<Files "install.php">
    Require all denied
</Files>

<Files "composer.json">
    Require all denied
</Files>

<Files "composer.lock">
    Require all denied
</Files>

# Защита от hotlinking
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /

    # Блокировка hotlinking изображений
    RewriteCond %{HTTP_REFERER} !^$
    RewriteCond %{HTTP_REFERER} !^https?://([^.]+\.)?akvasbor\. [NC]
    RewriteCond %{HTTP_REFERER} !^https?://([^.]+\.)?(google|yandex|bing|yahoo)\. [NC]
    RewriteRule \.(jpg|jpeg|png|gif|webp|svg)$ /images/no-hotlink.png [R=302,L]
</IfModule>

# Сжатие контента
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/ld+json
    AddOutputFilterByType DEFLATE image/svg+xml

    # Исключаем уже сжатые файлы
    SetEnvIfNoCase Request_URI \
        \.(?:gif|jpe?g|png|rar|zip|exe|flv|mov|wma|mp3|avi|swf|mp4|webm|webp|pdf)$ no-gzip dont-vary
</IfModule>

# Кэширование браузера
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresDefault "access plus 1 hour"

    # Изображения
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresByType image/vnd.microsoft.icon "access plus 1 year"

    # Шрифты
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"

    # CSS и JavaScript
    ExpiresByType text/css "access plus 1 week"
    ExpiresByType application/javascript "access plus 1 week"
    ExpiresByType text/javascript "access plus 1 week"

    # Документы
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType text/xml "access plus 1 hour"
    ExpiresByType application/xml "access plus 1 hour"
    ExpiresByType application/rss+xml "access plus 1 hour"

    # HTML
    ExpiresByType text/html "access plus 1 hour"
</IfModule>

# Принудительное HTTPS (раскомментируйте если используете SSL)
# <IfModule mod_rewrite.c>
#     RewriteEngine On
#     RewriteCond %{HTTPS} off
#     RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
# </IfModule>

# Основная маршrutизация
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /

    # Удаление index.php из URL
    RewriteCond %{THE_REQUEST} /index\.php[\?/\s] [NC]
    RewriteRule ^index\.php$ / [R=301,L]

    # API маршруты
    RewriteRule ^api/?(.*)$ api.php?route=$1 [QSA,L]

    # Админ-панель
    RewriteRule ^admin/?(.*)$ admin.php?route=$1 [QSA,L]

    # Sitemap
    RewriteRule ^sitemap\.xml$ sitemap.php [L]

    # Robots.txt
    RewriteRule ^robots\.txt$ robots.php [L]

    # Основные маршруты сайта
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ index.php?route=$1 [QSA,L]
</IfModule>

# Дополнительная безопасность
<IfModule mod_security.c>
    # Основные правила ModSecurity
    SecRuleEngine On
    SecRequestBodyAccess On
    SecRequestBodyLimit 134217728
    SecRequestBodyInMemoryLimit 131072
    SecResponseBodyAccess Off
    SecDebugLog logs/modsec_debug.log
    SecDebugLogLevel 0
</IfModule>

# Ограничение размера загружаемых файлов
<IfModule mod_php.c>
    php_value upload_max_filesize 10M
    php_value post_max_size 12M
    php_value max_execution_time 300
    php_value max_input_time 300
    php_value memory_limit 256M
</IfModule>

# Защита от спама и ботов
<IfModule mod_evasive24.c>
    DOSHashTableSize    2048
    DOSPageCount        10
    DOSSiteCount        50
    DOSPageInterval     1
    DOSSiteInterval     1
    DOSBlockingPeriod   86400
    DOSEmailNotify      admin@akvasbor.ru
</IfModule>

# Кастомные страницы ошибок
ErrorDocument 400 /error.php?code=400
ErrorDocument 401 /error.php?code=401
ErrorDocument 403 /error.php?code=403
ErrorDocument 404 /error.php?code=404
ErrorDocument 500 /error.php?code=500
ErrorDocument 502 /error.php?code=502
ErrorDocument 503 /error.php?code=503

# MIME типы для современных форматов
<IfModule mod_mime.c>
    AddType image/webp .webp
    AddType image/avif .avif
    AddType font/woff .woff
    AddType font/woff2 .woff2
    AddType application/javascript .js
    AddType text/css .css
</IfModule>';
        file_put_contents('.htaccess', $htaccess_content);

        // Создаем robots.txt
        $robots_content = 'User-agent: *
Allow: /

# Закрываем служебные разделы
Disallow: /admin/
Disallow: /config/
Disallow: /cache/
Disallow: /logs/
Disallow: /storage/
Disallow: /vendor/
Disallow: /install.php
Disallow: /error.php

# Разрешаем важные файлы
Allow: /uploads/
Allow: /assets/
Allow: /images/

# Указываем карту сайта
Sitemap: https://' . ($_SERVER['HTTP_HOST'] ?? 'akvasbor.ru') . '/sitemap.xml

# Время обхода (в секундах)
Crawl-delay: 1

# Специальные правила для разных ботов
User-agent: Googlebot
Disallow: /search
Disallow: /*?*sort=
Disallow: /*?*filter=
Allow: /

User-agent: Yandex
Disallow: /search
Disallow: /*?*sort=
Disallow: /*?*filter=
Allow: /

User-agent: Bingbot
Disallow: /search
Allow: /

# Блокируем нежелательных ботов
User-agent: AhrefsBot
Disallow: /

User-agent: MJ12bot
Disallow: /

User-agent: DotBot
Disallow: /';
        file_put_contents('robots.txt', $robots_content);

        // Создаем базовую страницу ошибок
        $error_page = '<?php
http_response_code($_GET[\'code\'] ?? 404);
$code = $_GET[\'code\'] ?? 404;
$messages = [
    400 => \'Неверный запрос\',
    401 => \'Требуется авторизация\',
    403 => \'Доступ запрещен\',
    404 => \'Страница не найдена\',
    500 => \'Внутренняя ошибка сервера\',
    502 => \'Неверный шлюз\',
    503 => \'Сервис недоступен\'
];
?>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ошибка <?= $code ?> — АкваСбор</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .error-container { background: white; padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.1); max-width: 600px; }
        h1 { color: #333; font-size: 4rem; margin: 0; }
        h2 { color: #666; margin: 10px 0 30px; }
        p { color: #888; line-height: 1.6; margin-bottom: 30px; }
        a { color: #28a745; text-decoration: none; font-weight: 500; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="error-container">
        <h1><?= $code ?></h1>
        <h2><?= $messages[$code] ?? \'Неизвестная ошибка\' ?></h2>
        <p>К сожалению, запрашиваемая страница не найдена или произошла ошибка.</p>
        <p><a href="/">← Вернуться на главную</a></p>
    </div>
</body>
</html>';
        file_put_contents('error.php', $error_page);

        // Создаем файл установки с подробной информацией
        $install_info = [
            'version' => '2.0.0',
            'installed_at' => date('Y-m-d H:i:s'),
            'installer_ip' => $_SERVER['REMOTE_ADDR'] ?? 'unknown',
            'php_version' => PHP_VERSION,
            'mysql_version' => $mysql_version,
            'server_software' => $_SERVER['SERVER_SOFTWARE'] ?? 'unknown',
            'document_root' => $_SERVER['DOCUMENT_ROOT'] ?? '',
            'http_host' => $_SERVER['HTTP_HOST'] ?? '',
            'features_enabled' => [
                'cache' => true,
                'gd' => extension_loaded('gd'),
                'curl' => extension_loaded('curl'),
                'zip' => extension_loaded('zip'),
                'openssl' => extension_loaded('openssl'),
                'mbstring' => extension_loaded('mbstring'),
                'fileinfo' => extension_loaded('fileinfo')
            ],
            'admin_created' => isset($_SESSION['admin_created']) ? $_SESSION['admin_created'] : null,
            'database' => [
                'host' => $db_config['db_host'],
                'name' => $db_config['db_name'],
                'engine' => 'InnoDB',
                'charset' => 'utf8mb4'
            ]
        ];
        file_put_contents('config/.installed', json_encode($install_info, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));

        // Создаем структуру директорий
        $dirs = [
            'uploads', 'uploads/products', 'uploads/categories', 'uploads/news', 
            'uploads/avatars', 'uploads/temp', 'uploads/gallery', 'uploads/banners',
            'cache', 'cache/products', 'cache/categories', 'cache/pages', 
            'cache/templates', 'cache/images',
            'logs', 'logs/errors', 'logs/access', 'logs/system',
            'storage', 'storage/sessions', 'storage/temp', 'storage/exports',
            'backups', 'backups/database', 'backups/files',
            'assets', 'assets/css', 'assets/js', 'assets/images', 'assets/fonts'
        ];

        foreach ($dirs as $dir) {
            if (!is_dir($dir)) {
                @mkdir($dir, 0755, true);
                // Создаем .htaccess для защиты папок
                if (in_array($dir, ['logs', 'cache', 'storage', 'backups', 'config'])) {
                    file_put_contents($dir . '/.htaccess', 'Require all denied');
                }
                // Создаем index.html для защиты
                file_put_contents($dir . '/index.html', '<!DOCTYPE html><html><head><title>403 Forbidden</title></head><body><h1>Directory access is forbidden.</h1></body></html>');
            }
        }

        // Создаем composer.json для расширений
        $composer_content = '{
    "name": "akvasbor/cms",
    "description": "АкваСбор CMS - современная система управления интернет-магазином аквариумных товаров",
    "type": "project",
    "keywords": ["cms", "ecommerce", "aquarium", "plants", "fish", "online-store"],
    "homepage": "https://akvasbor.ru",
    "license": "MIT",
    "authors": [
        {
            "name": "АкваСбор Team",
            "email": "dev@akvasbor.ru"
        }
    ],
    "require": {
        "php": ">=8.0",
        "ext-pdo": "*",
        "ext-pdo_mysql": "*",
        "ext-gd": "*",
        "ext-curl": "*",
        "ext-json": "*",
        "ext-mbstring": "*",
        "ext-fileinfo": "*",
        "ext-zip": "*",
        "ext-openssl": "*"
    },
    "require-dev": {
        "phpunit/phpunit": "^9.0"
    },
    "autoload": {
        "psr-4": {
            "AkvasCMS\\\\": "src/",
            "App\\\\": "app/"
        },
        "files": [
            "core/functions.php",
            "core/helpers.php"
        ]
    },
    "autoload-dev": {
        "psr-4": {
            "Tests\\\\": "tests/"
        }
    },
    "scripts": {
        "test": "phpunit",
        "clear-cache": "php artisan cache:clear",
        "optimize": "php artisan optimize",
        "backup": "php artisan backup:run"
    },
    "config": {
        "optimize-autoloader": true,
        "preferred-install": "dist",
        "sort-packages": true
    },
    "minimum-stability": "stable",
    "prefer-stable": true
}';
        file_put_contents('composer.json', $composer_content);

        // Создаем файл changelog
        $changelog = '# АкваСбор CMS - История изменений

## [2.0.0] - ' . date('Y-m-d') . '

### Добавлено
- 🎉 Полная переработка системы установки
- 🚀 Современный MEGA дизайн установщика
- 🛡️ Расширенная система безопасности
- 📊 Детальная аналитика и логирование
- 🎨 Адаптивный интерфейс с анимациями
- 🔧 Модульная архитектура
- 💾 Расширенная система кэширования
- 📧 Система уведомлений
- 🏪 Продвинутый функционал магазина

### Исправлено
- ❌ Удалены попытки создания БД (для совместимости с хостингами)
- 🔒 Улучшена защита от SQL инъекций
- 📱 Исправлена адаптивность на мобильных
- 🚀 Оптимизирована производительность

### Изменено
- 🎯 Обновлен до PHP 8.0+
- 🗄️ Переход на InnoDB и utf8mb4
- 📋 Расширенная структура таблиц
- ⚙️ Улучшенная система настроек

### Безопасность
- 🛡️ Защита от CSRF атак
- 🔐 Улучшенная авторизация
- 📝 Логирование всех операций
- 🚫 Защита от брутфорса';
        file_put_contents('CHANGELOG.md', $changelog);

        // Создаем README
        $readme = '# АкваСбор CMS 2.0

Современная система управления интернет-магазином аквариумных товаров.

## 🌟 Особенности

- 🚀 **Быстрая установка** - автоматическое создание структуры
- 🎨 **Современный дизайн** - адаптивный интерфейс
- 🛡️ **Безопасность** - защита от всех видов атак
- 📊 **Аналитика** - подробная статистика продаж
- 🔧 **Модульность** - легкое расширение функционала

## 📋 Системные требования

- PHP 8.0 или выше
- MySQL 5.7 / MariaDB 10.2
- Расширения: PDO, GD, cURL, JSON, mbstring, fileinfo

## 🚀 Установка

1. Загрузите файлы на сервер
2. Создайте базу данных в панели хостинга  
3. Запустите `install.php`
4. Следуйте инструкциям мастера установки

## 📚 Документация

После установки доступна в админ-панели в разделе "Справка".

## 🆘 Поддержка

- Email: support@akvasbor.ru
- Telegram: @akvasbor_support

## 📄 Лицензия

MIT License - свободное использование и модификация.';
        file_put_contents('README.md', $readme);

        // Очищаем сессию
        unset($_SESSION['db_config'], $_SESSION['mysql_version'], $_SESSION['admin_created']);

        return true;
    } catch (Exception $e) {
        error_log('Ошибка финализации: ' . $e->getMessage());
        return false;
    }
}
?>

<!DOCTYPE html>
<html lang='ru'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Установка АкваСбор CMS 2.0 — MEGA Edition</title>
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css' rel='stylesheet'>
    <link href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap' rel='stylesheet'>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --card-shadow: 0 25px 50px rgba(0,0,0,0.15);
            --card-shadow-hover: 0 35px 70px rgba(0,0,0,0.2);
            --border-radius: 25px;
            --border-radius-sm: 15px;
            --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --animate-duration: 0.6s;
        }

        * { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            box-sizing: border-box;
        }

        body {
            background: var(--primary-gradient);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }

        /* Анимированный фон */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.3) 0%, transparent 50%);
            animation: backgroundShift 15s ease-in-out infinite;
            pointer-events: none;
            z-index: -2;
        }

        @keyframes backgroundShift {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            33% { opacity: 0.8; transform: scale(1.1) rotate(2deg); }
            66% { opacity: 0.4; transform: scale(0.9) rotate(-1deg); }
        }

        /* Плавающие элементы */
        .floating-elements {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .floating-element {
            position: absolute;
            opacity: 0.1;
            animation: float 8s ease-in-out infinite;
            font-size: 2rem;
            user-select: none;
        }

        .floating-element:nth-child(1) { top: 10%; left: 10%; animation-delay: 0s; }
        .floating-element:nth-child(2) { top: 20%; right: 10%; animation-delay: -2s; font-size: 1.5rem; }
        .floating-element:nth-child(3) { bottom: 30%; left: 15%; animation-delay: -4s; font-size: 1.8rem; }
        .floating-element:nth-child(4) { bottom: 20%; right: 20%; animation-delay: -1s; font-size: 1.3rem; }
        .floating-element:nth-child(5) { top: 50%; left: 5%; animation-delay: -3s; font-size: 2.2rem; }
        .floating-element:nth-child(6) { top: 70%; right: 5%; animation-delay: -5s; font-size: 1.6rem; }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.1; }
            25% { transform: translateY(-25px) rotate(5deg); opacity: 0.15; }
            50% { transform: translateY(-15px) rotate(-3deg); opacity: 0.08; }
            75% { transform: translateY(-35px) rotate(2deg); opacity: 0.12; }
        }

        .install-container {
            padding: 2rem 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            position: relative;
        }

        .install-card {
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: var(--card-shadow);
            border-radius: var(--border-radius);
            overflow: hidden;
            transition: var(--transition);
            position: relative;
        }

        .install-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--success-gradient);
            animation: progressShine 2s ease-in-out infinite;
        }

        @keyframes progressShine {
            0% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
            100% { transform: translateX(100%); }
        }

        .card-header {
            background: var(--success-gradient);
            border: none;
            padding: 2.5rem 2rem;
            position: relative;
            overflow: hidden;
        }

        .card-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            animation: cardHeaderShine 3s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes cardHeaderShine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(30deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(30deg); }
        }

        .logo {
            font-size: 3rem;
            font-weight: 900;
            color: white;
            text-align: center;
            margin-bottom: 1rem;
            text-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
            z-index: 2;
        }

        .logo i {
            background: rgba(255,255,255,0.2);
            padding: 0.8rem;
            border-radius: 20px;
            margin-right: 1rem;
            animation: logoFloat 3s ease-in-out infinite;
            display: inline-block;
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-5px) scale(1.05); }
        }

        .step-indicator {
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(240,248,255,0.9) 100%);
            border-radius: var(--border-radius-sm);
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .step-indicator::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--success-gradient);
            transform: translateX(calc(<?= ($step-1) * 20 ?>% - 100%));
            animation: progressMove var(--animate-duration) ease-out;
        }

        @keyframes progressMove {
            from { transform: translateX(-100%); }
            to { transform: translateX(calc(<?= ($step-1) * 20 ?>% - 100%)); }
        }

        .steps-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .step-item {
            text-align: center;
            flex: 1;
            min-width: 80px;
        }

        .step {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            text-align: center;
            font-weight: 700;
            font-size: 1.2rem;
            position: relative;
            transition: var(--transition);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            margin: 0 auto 0.5rem;
            cursor: default;
        }

        .step.active {
            background: var(--success-gradient);
            color: white;
            transform: scale(1.15);
            box-shadow: 0 15px 40px rgba(40, 167, 69, 0.4);
            animation: stepPulse 2s ease-in-out infinite;
        }

        @keyframes stepPulse {
            0%, 100% { box-shadow: 0 15px 40px rgba(40, 167, 69, 0.4); }
            50% { box-shadow: 0 15px 40px rgba(40, 167, 69, 0.6), 0 0 30px rgba(40, 167, 69, 0.3); }
        }

        .step.completed {
            background: var(--success-gradient);
            color: white;
            transform: scale(1.1);
            position: relative;
        }

        .step.completed::after {
            content: '✓';
            position: absolute;
            font-size: 1.2rem;
            font-weight: 900;
        }

        .step.pending {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #6c757d;
            border: 2px solid #e9ecef;
        }

        .step-label {
            font-size: 0.8rem;
            color: #6c757d;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .step.active + .step-label,
        .step.completed + .step-label {
            color: #28a745;
            font-weight: 700;
        }

        .version-info {
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,255,0.9) 100%);
            border-radius: var(--border-radius-sm);
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
        }

        .version-info::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: versionShine 3s ease-in-out infinite;
        }

        @keyframes versionShine {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .form-control, .form-select {
            border-radius: var(--border-radius-sm);
            border: 2px solid #e9ecef;
            padding: 1rem 1.25rem;
            transition: var(--transition);
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(5px);
            font-weight: 500;
        }

        .form-control:focus, .form-select:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.25rem rgba(40, 167, 69, 0.15), 0 8px 25px rgba(0,0,0,0.1);
            transform: translateY(-2px);
            background: white;
        }

        .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }

        .form-text {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }

        .btn {
            border-radius: var(--border-radius-sm);
            padding: 1rem 2.5rem;
            font-weight: 600;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            font-size: 0.9rem;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-success {
            background: var(--success-gradient);
            border: none;
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 20px 40px rgba(40, 167, 69, 0.4);
            color: white;
        }

        .btn-primary {
            background: var(--info-gradient);
            border: none;
            box-shadow: 0 10px 30px rgba(74, 172, 254, 0.3);
        }

        .btn-outline-primary {
            border: 2px solid #28a745;
            color: #28a745;
            background: transparent;
        }

        .btn-outline-primary:hover {
            background: var(--success-gradient);
            transform: translateY(-2px);
            color: white;
            border-color: transparent;
        }

        .alert {
            border-radius: var(--border-radius-sm);
            border: none;
            padding: 1.25rem 1.75rem;
            margin-bottom: 1.5rem;
            position: relative;
            backdrop-filter: blur(10px);
            animation: alertSlideIn var(--animate-duration) ease-out;
        }

        @keyframes alertSlideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-success {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.15) 0%, rgba(32, 201, 151, 0.15) 100%);
            border-left: 4px solid #28a745;
            color: #155724;
        }

        .alert-danger {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.15) 0%, rgba(231, 74, 59, 0.15) 100%);
            border-left: 4px solid #dc3545;
            color: #721c24;
        }

        .alert-warning {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.15) 0%, rgba(255, 171, 0, 0.15) 100%);
            border-left: 4px solid #ffc107;
            color: #856404;
        }

        .alert-info {
            background: linear-gradient(135deg, rgba(13, 202, 240, 0.15) 0%, rgba(108, 117, 125, 0.15) 100%);
            border-left: 4px solid #0dcaf0;
            color: #055160;
        }

        .requirements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .requirement-item {
            background: rgba(255,255,255,0.9);
            border-radius: var(--border-radius-sm);
            padding: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            transition: var(--transition);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .requirement-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.12);
        }

        .feature-card {
            background: rgba(255,255,255,0.95);
            border-radius: var(--border-radius-sm);
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: var(--transition);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--success-gradient);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: var(--card-shadow-hover);
        }

        .feature-card:hover::before {
            transform: scaleX(1);
        }

        .feature-icon {
            width: 80px;
            height: 80px;
            background: var(--success-gradient);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.3);
            animation: iconFloat 4s ease-in-out infinite;
        }

        @keyframes iconFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }

        .badge {
            padding: 0.6rem 1.2rem;
            font-size: 0.85rem;
            border-radius: 50px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge.bg-success {
            background: var(--success-gradient) !important;
        }

        .badge.bg-danger {
            background: var(--warning-gradient) !important;
        }

        .completion-animation {
            animation: celebration 2s ease-in-out;
        }

        @keyframes celebration {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.05) rotate(1deg); }
            50% { transform: scale(1.1) rotate(-1deg); }
            75% { transform: scale(1.05) rotate(0.5deg); }
        }

        .final-icon {
            font-size: 6rem !important;
            animation: finalIconBounce 2s ease-in-out infinite;
        }

        @keyframes finalIconBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .logo { font-size: 2.2rem; }
            .logo i { padding: 0.5rem; margin-right: 0.5rem; }
            .step { width: 50px; height: 50px; font-size: 1rem; }
            .feature-icon { width: 60px; height: 60px; font-size: 1.5rem; }
            .install-container { padding: 1rem 0; }
            .card-header { padding: 2rem 1.5rem; }
            .card-body { padding: 1.5rem !important; }
            .btn { padding: 0.875rem 2rem; font-size: 0.85rem; }
            .steps-container { gap: 0.5rem; }
            .step-item { min-width: 60px; }
        }

        /* Дополнительные анимации */
        .animate-fade-in {
            animation: fadeIn var(--animate-duration) ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-slide-in-left {
            animation: slideInLeft var(--animate-duration) ease-out;
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .animate-slide-in-right {
            animation: slideInRight var(--animate-duration) ease-out;
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Улучшенные эффекты загрузки */
        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #28a745;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Кастомный скроллбар */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--success-gradient);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #0f7b6c 0%, #2db88a 100%);
        }

        /* Стили для финальной страницы */
        .success-checkmark {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: block;
            stroke-width: 2;
            stroke: #28a745;
            stroke-miterlimit: 10;
            margin: 2rem auto 1rem;
            box-shadow: inset 0px 0px 0px #28a745;
            animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
        }

        .success-checkmark__circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 2;
            stroke-miterlimit: 10;
            stroke: #28a745;
            fill: none;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }

        .success-checkmark__check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        }

        @keyframes stroke {
            100% {
                stroke-dashoffset: 0;
            }
        }

        @keyframes scale {
            0%, 100% {
                transform: none;
            }
            50% {
                transform: scale3d(1.1, 1.1, 1);
            }
        }

        @keyframes fill {
            100% {
                box-shadow: inset 0px 0px 0px 60px #28a745;
            }
        }

        /* Конфетти эффект для финальной страницы */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #28a745;
            animation: confetti-fall 3s linear infinite;
            z-index: 1000;
        }

        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
            }
        }

        /* Тултипы */
        .tooltip-custom {
            position: relative;
            display: inline-block;
        }

        .tooltip-custom .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 1001;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
        }

        .tooltip-custom:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Плавающие элементы -->
    <div class='floating-elements'>
        <div class='floating-element'>🐠</div>
        <div class='floating-element'>🌱</div>
        <div class='floating-element'>🐟</div>
        <div class='floating-element'>🦐</div>
        <div class='floating-element'>🌿</div>
        <div class='floating-element'>🐡</div>
    </div>

    <div class='install-container'>
        <div class='container'>
            <div class='row justify-content-center'>
                <div class='col-lg-11 col-xl-10'>
                    <div class='card install-card animate-fade-in'>
                        <div class='card-header text-center'>
                            <div class='logo'>
                                <i class='bi bi-water'></i> АкваСбор CMS 2.0
                            </div>
                            <h2 class='mb-2 text-white fw-bold'>MEGA Installer</h2>
                            <p class='mb-0 text-white' style='opacity: 0.9;'>Современная система управления аквариумным магазином</p>
                            <small class='text-white' style='opacity: 0.7;'>Установка займет не более 3 минут</small>
                        </div>

                        <div class='card-body p-4 p-md-5'>
                            <!-- Версия и информация -->
                            <div class='version-info animate-slide-in-left' style='animation-delay: 0.2s;'>
                                <h5 class='mb-2 fw-bold'><i class='bi bi-info-circle text-primary me-2'></i> Информация о версии</h5>
                                <div class='row text-center'>
                                    <div class='col-md-3'>
                                        <strong>Версия</strong><br>
                                        <span class='text-success'>2.0.0 MEGA</span>
                                    </div>
                                    <div class='col-md-3'>
                                        <strong>PHP</strong><br>
                                        <span class='text-info'><?= PHP_VERSION ?></span>
                                    </div>
                                    <div class='col-md-3'>
                                        <strong>БД</strong><br>
                                        <span class='text-warning'>MySQL/MariaDB</span>
                                    </div>
                                    <div class='col-md-3'>
                                        <strong>Фреймворк</strong><br>
                                        <span class='text-danger'>Bootstrap 5.3</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Индикатор шагов -->
                            <div class='step-indicator animate-slide-in-right' style='animation-delay: 0.4s;'>
                                <div class='steps-container'>
                                    <div class='step-item'>
                                        <div class='step <?= $step == 1 ? 'active' : ($step > 1 ? 'completed' : 'pending') ?>'>1</div>
                                        <div class='step-label'>Проверка системы</div>
                                    </div>
                                    <div class='step-item'>
                                        <div class='step <?= $step == 2 ? 'active' : ($step > 2 ? 'completed' : 'pending') ?>'>2</div>
                                        <div class='step-label'>База данных</div>
                                    </div>
                                    <div class='step-item'>
                                        <div class='step <?= $step == 3 ? 'active' : ($step > 3 ? 'completed' : 'pending') ?>'>3</div>
                                        <div class='step-label'>Структура БД</div>
                                    </div>
                                    <div class='step-item'>
                                        <div class='step <?= $step == 4 ? 'active' : ($step > 4 ? 'completed' : 'pending') ?>'>4</div>
                                        <div class='step-label'>Администратор</div>
                                    </div>
                                    <div class='step-item'>
                                        <div class='step <?= $step == 5 ? 'active' : ($step > 5 ? 'completed' : 'pending') ?>'>5</div>
                                        <div class='step-label'>Настройки</div>
                                    </div>
                                    <div class='step-item'>
                                        <div class='step <?= $step == 6 ? 'active' : 'pending' ?>'>6</div>
                                        <div class='step-label'>Завершение</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Сообщения об ошибках -->
                            <?php if ($errors): ?>
                                <?php foreach ($errors as $error): ?>
                                    <div class='alert alert-danger'>
                                        <i class='bi bi-exclamation-triangle-fill me-2'></i>
                                        <strong>Ошибка!</strong> <?= htmlspecialchars($error) ?>
                                    </div>
                                <?php endforeach; ?>
                            <?php endif; ?>

                            <!-- Сообщения об успехе -->
                            <?php if ($success): ?>
                                <?php foreach ($success as $msg): ?>
                                    <div class='alert alert-success'>
                                        <i class='bi bi-check-circle-fill me-2'></i>
                                        <strong>Успешно!</strong> <?= htmlspecialchars($msg) ?>
                                    </div>
                                <?php endforeach; ?>
                            <?php endif; ?>

                            <!-- Шаг 1: Проверка требований -->
                            <?php if ($step == 1): ?>
                                <div class='animate-fade-in'>
                                    <h4 class='mb-4 fw-bold'><i class='bi bi-gear-fill text-primary me-2'></i>Проверка системных требований</h4>

                                    <div class='alert alert-info mb-4'>
                                        <i class='bi bi-info-circle me-2'></i>
                                        <strong>Проверяем готовность вашего сервера:</strong> Убедимся, что все необходимые компоненты установлены и настроены правильно.
                                    </div>

                                    <?php
                                    $requirements = checkRequirements();
                                    $all_passed = true;
                                    ?>

                                    <div class='requirements-grid'>
                                        <?php foreach ($requirements as $req => $passed): ?>
                                            <div class='requirement-item animate-slide-in-left' style='animation-delay: <?= array_search($req, array_keys($requirements)) * 0.1 ?>s;'>
                                                <div class='d-flex align-items-center'>
                                                    <i class='bi bi-<?= $passed ? 'check-circle-fill text-success' : 'x-circle-fill text-danger' ?> me-3 fs-5'></i>
                                                    <span class='fw-medium'><?= $req ?></span>
                                                </div>
                                                <span class='badge <?= $passed ? 'bg-success' : 'bg-danger' ?>'>
                                                    <?= $passed ? 'OK' : 'ОШИБКА' ?>
                                                </span>
                                            </div>
                                            <?php if (!$passed) $all_passed = false; ?>
                                        <?php endforeach; ?>
                                    </div>

                                    <?php if ($all_passed): ?>
                                        <div class='text-center mt-5'>
                                            <div class='mb-3'>
                                                <i class='bi bi-check-circle-fill text-success' style='font-size: 3rem;'></i>
                                            </div>
                                            <h5 class='text-success fw-bold mb-3'>Отлично! Все требования выполнены</h5>
                                            <p class='text-muted mb-4'>Ваш сервер готов для установки АкваСбор CMS</p>
                                            <a href='?step=2' class='btn btn-success btn-lg'>
                                                <i class='bi bi-arrow-right me-2'></i>Продолжить установку
                                            </a>
                                        </div>
                                    <?php else: ?>
                                        <div class='alert alert-warning mt-4'>
                                            <i class='bi bi-exclamation-triangle-fill me-2'></i>
                                            <strong>Внимание!</strong> Необходимо устранить все проблемы перед продолжением установки. 
                                            Обратитесь к администратору сервера или хостинг-провайдеру для решения этих вопросов.
                                        </div>
                                        <div class='text-center mt-4'>
                                            <button onclick='location.reload()' class='btn btn-outline-primary'>
                                                <i class='bi bi-arrow-clockwise me-2'></i>Повторить проверку
                                            </button>
                                        </div>
                                    <?php endif; ?>
                                </div>
                            <?php endif; ?>

                            <!-- Шаг 2: Настройка БД -->
                            <?php if ($step == 2): ?>
                                <div class='animate-fade-in'>
                                    <h4 class='mb-4 fw-bold'><i class='bi bi-database-fill text-success me-2'></i>Подключение к базе данных</h4>

                                    <div class='alert alert-warning mb-4'>
                                        <i class='bi bi-exclamation-triangle-fill me-2'></i>
                                        <strong>Важно!</strong> База данных должна быть <u>создана заранее</u> через панель управления хостингом. 
                                        Система создаст только таблицы и структуру данных.
                                    </div>

                                    <form method='post' class='needs-validation' novalidate>
                                        <div class='row g-4'>
                                            <div class='col-md-6'>
                                                <label class='form-label'>
                                                    <i class='bi bi-server me-1'></i>Хост базы данных
                                                </label>
                                                <input type='text' class='form-control' name='db_host' value='localhost' required 
                                                       placeholder='localhost или IP адрес'>
                                                <div class='form-text'>Обычно это <code>localhost</code> или IP-адрес сервера БД</div>
                                                <div class='invalid-feedback'>Пожалуйста, укажите хост базы данных</div>
                                            </div>

                                            <div class='col-md-6'>
                                                <label class='form-label'>
                                                    <i class='bi bi-database me-1'></i>Имя базы данных *
                                                </label>
                                                <input type='text' class='form-control' name='db_name' required 
                                                       placeholder='akvasbor_shop'>
                                                <div class='form-text'>Название БД, созданной в панели хостинга</div>
                                                <div class='invalid-feedback'>Необходимо указать имя базы данных</div>
                                            </div>

                                            <div class='col-md-6'>
                                                <label class='form-label'>
                                                    <i class='bi bi-person-fill me-1'></i>Пользователь БД
                                                </label>
                                                <input type='text' class='form-control' name='db_user' required 
                                                       placeholder='root или имя пользователя'>
                                                <div class='form-text'>Имя пользователя для подключения к БД</div>
                                                <div class='invalid-feedback'>Укажите имя пользователя БД</div>
                                            </div>

                                            <div class='col-md-6'>
                                                <label class='form-label'>
                                                    <i class='bi bi-key-fill me-1'></i>Пароль БД
                                                </label>
                                                <input type='password' class='form-control' name='db_pass' 
                                                       placeholder='Пароль (может быть пустым)'>
                                                <div class='form-text'>Пароль пользователя БД (оставьте пустым если пароля нет)</div>
                                            </div>
                                        </div>

                                        <div class='text-center mt-5'>
                                            <button type='submit' class='btn btn-success btn-lg'>
                                                <div class='loading-spinner d-none me-2'></div>
                                                <i class='bi bi-database-check me-2 submit-icon'></i>
                                                <span class='submit-text'>Проверить подключение</span>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            <?php endif; ?>

                            <!-- Шаг 3: Создание таблиц -->
                            <?php if ($step == 3): ?>
                                <div class='animate-fade-in'>
                                    <h4 class='mb-4 fw-bold'><i class='bi bi-table text-info me-2'></i>Создание структуры базы данных</h4>

                                    <div class='alert alert-success mb-4'>
                                        <i class='bi bi-check-circle-fill me-2'></i>
                                        <strong>Подключение установлено!</strong> Теперь создадим все необходимые таблицы и заполним базовые настройки.
                                    </div>

                                    <div class='row g-4'>
                                        <div class='col-md-6'>
                                            <div class='feature-card animate-slide-in-left'>
                                                <div class='feature-icon'>
                                                    <i class='bi bi-shop'></i>
                                                </div>
                                                <h5 class='fw-bold mb-3'>Основные таблицы</h5>
                                                <ul class='list-unstyled'>
                                                    <li class='mb-2'><i class='bi bi-check-circle text-success me-2'></i>Администраторы и права доступа</li>
                                                    <li class='mb-2'><i class='bi bi-check-circle text-success me-2'></i>Категории товаров (вложенность)</li>
                                                    <li class='mb-2'><i class='bi bi-check-circle text-success me-2'></i>Товары и их характеристики</li>
                                                    <li class='mb-2'><i class='bi bi-check-circle text-success me-2'></i>Заказы и позиции заказов</li>
                                                    <li class='mb-2'><i class='bi bi-check-circle text-success me-2'></i>Корзина и избранное</li>
                                                </ul>
                                            </div>
                                        </div>

                                        <div class='col-md-6'>
                                            <div class='feature-card animate-slide-in-right' style='animation-delay: 0.2s;'>
                                                <div class='feature-icon'>
                                                    <i class='bi bi-gear-wide-connected'></i>
                                                </div>
                                                <h5 class='fw-bold mb-3'>Дополнительные возможности</h5>
                                                <ul class='list-unstyled'>
                                                    <li class='mb-2'><i class='bi bi-check-circle text-success me-2'></i>Отзывы и рейтинги</li>
                                                    <li class='mb-2'><i class='bi bi-check-circle text-success me-2'></i>Система настроек</li>
                                                    <li class='mb-2'><i class='bi bi-check-circle text-success me-2'></i>Новости и статьи</li>
                                                    <li class='mb-2'><i class='bi bi-check-circle text-success me-2'></i>Купоны и скидки</li>
                                                    <li class='mb-2'><i class='bi bi-check-circle text-success me-2'></i>Аналитика и логирование</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <div class='alert alert-info'>
                                        <i class='bi bi-info-circle me-2'></i>
                                        <strong>Что будет создано:</strong>
                                        <ul class='mb-0 mt-2'>
                                            <li>15+ оптимизированных таблиц с поддержкой внешних ключей</li>
                                            <li>Индексы для быстрого поиска и фильтрации</li>
                                            <li>Полнотекстовый поиск по товарам и статьям</li>
                                            <li>JSON поля для гибкого хранения данных</li>
                                            <li>100+ готовых настроек системы</li>
                                        </ul>
                                    </div>

                                    <div class='text-center mt-5'>
                                        <form method='post'>
                                            <button type='submit' name='create_tables' class='btn btn-success btn-lg'>
                                                <div class='loading-spinner d-none me-2'></div>
                                                <i class='bi bi-play-circle-fill me-2 submit-icon'></i>
                                                <span class='submit-text'>Создать структуру БД</span>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            <?php endif; ?>

                            <!-- Шаг 4: Создание админа -->
                            <?php if ($step == 4): ?>
                                <div class='animate-fade-in'>
                                    <h4 class='mb-4 fw-bold'><i class='bi bi-person-gear text-warning me-2'></i>Создание администратора</h4>

                                    <div class='alert alert-success mb-4'>
                                        <i class='bi bi-check-circle-fill me-2'></i>
                                        <strong>База данных готова!</strong> Создайте учетную запись главного администратора.
                                    </div>

                                    <div class='row justify-content-center'>
                                        <div class='col-lg-8'>
                                            <div class='feature-card'>
                                                <div class='text-center mb-4'>
                                                    <div class='feature-icon mx-auto'>
                                                        <i class='bi bi-shield-lock'></i>
                                                    </div>
                                                    <h5 class='fw-bold'>Учетная запись супер-администратора</h5>
                                                    <p class='text-muted'>Эта учетная запись будет иметь полный доступ ко всем функциям системы</p>
                                                </div>

                                                <form method='post' class='needs-validation' novalidate>
                                                    <div class='row g-4'>
                                                        <div class='col-12'>
                                                            <label class='form-label'>
                                                                <i class='bi bi-person-circle me-1'></i>Логин администратора
                                                            </label>
                                                            <input type='text' class='form-control' name='admin_login' value='admin' required
                                                                   pattern='[a-zA-Z0-9_-]{3,20}' minlength='3' maxlength='20'>
                                                            <div class='form-text'>От 3 до 20 символов, только латинские буквы, цифры, дефис и подчеркивание</div>
                                                            <div class='invalid-feedback'>Логин должен содержать от 3 до 20 символов</div>
                                                        </div>

                                                        <div class='col-12'>
                                                            <label class='form-label'>
                                                                <i class='bi bi-envelope me-1'></i>Email администратора
                                                            </label>
                                                            <input type='email' class='form-control' name='admin_email' required
                                                                   placeholder='admin@akvasbor.ru'>
                                                            <div class='form-text'>Используется для восстановления пароля и уведомлений</div>
                                                            <div class='invalid-feedback'>Введите корректный email адрес</div>
                                                        </div>

                                                        <div class='col-md-6'>
                                                            <label class='form-label'>
                                                                <i class='bi bi-key me-1'></i>Пароль
                                                            </label>
                                                            <input type='password' class='form-control' name='admin_pass' required
                                                                   minlength='8' id='password'>
                                                            <div class='form-text'>Минимум 8 символов, желательно включить цифры и специальные символы</div>
                                                            <div class='invalid-feedback'>Пароль должен быть не менее 8 символов</div>
                                                        </div>

                                                        <div class='col-md-6'>
                                                            <label class='form-label'>
                                                                <i class='bi bi-key-fill me-1'></i>Повторите пароль
                                                            </label>
                                                            <input type='password' class='form-control' name='admin_pass2' required
                                                                   minlength='8' id='password2'>
                                                            <div class='form-text'>Введите пароль еще раз для подтверждения</div>
                                                            <div class='invalid-feedback'>Пароли должны совпадать</div>
                                                        </div>
                                                    </div>

                                                    <div class='text-center mt-5'>
                                                        <button type='submit' class='btn btn-success btn-lg'>
                                                            <div class='loading-spinner d-none me-2'></div>
                                                            <i class='bi bi-person-plus-fill me-2 submit-icon'></i>
                                                            <span class='submit-text'>Создать администратора</span>
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <?php endif; ?>

                            <!-- Шаг 5: Финализация -->
                            <?php if ($step == 5): ?>
                                <div class='animate-fade-in'>
                                    <h4 class='mb-4 fw-bold'><i class='bi bi-gear-wide-connected text-primary me-2'></i>Финализация установки</h4>

                                    <div class='alert alert-success mb-4'>
                                        <i class='bi bi-check-circle-fill me-2'></i>
                                        <strong>Администратор создан!</strong> Осталось настроить конфигурационные файлы и структуру проекта.
                                    </div>

                                    <div class='row g-4'>
                                        <div class='col-md-4'>
                                            <div class='feature-card animate-slide-in-left'>
                                                <div class='feature-icon'>
                                                    <i class='bi bi-file-earmark-code'></i>
                                                </div>
                                                <h6 class='fw-bold'>Конфигурация</h6>
                                                <ul class='list-unstyled small'>
                                                    <li><i class='bi bi-check text-success me-1'></i>Настройки подключения к БД</li>
                                                    <li><i class='bi bi-check text-success me-1'></i>Параметры безопасности</li>
                                                    <li><i class='bi bi-check text-success me-1'></i>Конфигурация модулей</li>
                                                    <li><i class='bi bi-check text-success me-1'></i>Настройки кэширования</li>
                                                </ul>
                                            </div>
                                        </div>

                                        <div class='col-md-4'>
                                            <div class='feature-card animate-slide-in-up' style='animation-delay: 0.2s;'>
                                                <div class='feature-icon'>
                                                    <i class='bi bi-folder-check'></i>
                                                </div>
                                                <h6 class='fw-bold'>Структура файлов</h6>
                                                <ul class='list-unstyled small'>
                                                    <li><i class='bi bi-check text-success me-1'></i>Директории загрузок</li>
                                                    <li><i class='bi bi-check text-success me-1'></i>Папки для кэша и логов</li>
                                                    <li><i class='bi bi-check text-success me-1'></i>Защитные .htaccess файлы</li>
                                                    <li><i class='bi bi-check text-success me-1'></i>Резервные копии</li>
                                                </ul>
                                            </div>
                                        </div>

                                        <div class='col-md-4'>
                                            <div class='feature-card animate-slide-in-right' style='animation-delay: 0.4s;'>
                                                <div class='feature-icon'>
                                                    <i class='bi bi-shield-check'></i>
                                                </div>
                                                <h6 class='fw-bold'>Безопасность</h6>
                                                <ul class='list-unstyled small'>
                                                    <li><i class='bi bi-check text-success me-1'></i>SEO-оптимизация</li>
                                                    <li><i class='bi bi-check text-success me-1'></i>robots.txt и sitemap</li>
                                                    <li><i class='bi bi-check text-success me-1'></i>Защита от атак</li>
                                                    <li><i class='bi bi-check text-success me-1'></i>Оптимизация производительности</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <div class='alert alert-info'>
                                        <i class='bi bi-info-circle me-2'></i>
                                        <strong>Что будет создано на этом шаге:</strong>
                                        <div class='row mt-3'>
                                            <div class='col-md-6'>
                                                <ul class='mb-0'>
                                                    <li>Конфигурационные файлы (database.php, app.php, modules.php)</li>
                                                    <li>Оптимизированный .htaccess с защитой</li>
                                                    <li>robots.txt для поисковых роботов</li>
                                                </ul>
                                            </div>
                                            <div class='col-md-6'>
                                                <ul class='mb-0'>
                                                    <li>Структура папок (uploads, cache, logs, backups)</li>
                                                    <li>Базовая документация (README.md, CHANGELOG.md)</li>
                                                    <li>composer.json для расширений</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <div class='text-center mt-5'>
                                        <form method='post'>
                                            <button type='submit' name='finalize' class='btn btn-success btn-lg'>
                                                <div class='loading-spinner d-none me-2'></div>
                                                <i class='bi bi-check-circle-fill me-2 submit-icon'></i>
                                                <span class='submit-text'>Завершить установку</span>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            <?php endif; ?>

                            <!-- Шаг 6: Завершение -->
                            <?php if ($step == 6): ?>
                                <div class='text-center completion-animation animate-fade-in'>
                                    <!-- SVG чекмарк -->
                                    <svg class="success-checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                                        <circle class="success-checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                                        <path class="success-checkmark__check" fill="none" d="m14.1 27.2l7.1 7.2 16.7-16.8"/>
                                    </svg>

                                    <h2 class='text-success mb-3 fw-bold'>🎉 Установка завершена успешно!</h2>
                                    <p class='text-muted mb-4 fs-5'>АкваСбор CMS 2.0 MEGA готова к использованию</p>

                                    <div class='row g-4 justify-content-center mt-5'>
                                        <div class='col-md-5'>
                                            <div class='feature-card text-center animate-slide-in-left' style='animation-delay: 1s;'>
                                                <div class='feature-icon mx-auto mb-3'>
                                                    <i class='bi bi-house-door-fill'></i>
                                                </div>
                                                <h5 class='fw-bold mb-2'>Фронтенд сайта</h5>
                                                <p class='text-muted small mb-3'>Главная страница интернет-магазина</p>
                                                <a href='index.php' class='btn btn-outline-primary' target='_blank'>
                                                    <i class='bi bi-box-arrow-up-right me-2'></i>Открыть сайт
                                                </a>
                                            </div>
                                        </div>

                                        <div class='col-md-5'>
                                            <div class='feature-card text-center animate-slide-in-right' style='animation-delay: 1.2s;'>
                                                <div class='feature-icon mx-auto mb-3'>
                                                    <i class='bi bi-gear-wide-connected'></i>
                                                </div>
                                                <h5 class='fw-bold mb-2'>Админ-панель</h5>
                                                <p class='text-muted small mb-3'>Панель управления магазином</p>
                                                <a href='admin.php' class='btn btn-success' target='_blank'>
                                                    <i class='bi bi-box-arrow-up-right me-2'></i>Войти в админку
                                                </a>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Данные для входа в админку -->
                                    <?php if (isset($_SESSION['admin_created'])): ?>
                                    <div class='alert alert-info mt-4 animate-slide-in-up' style='animation-delay: 1.4s;'>
                                        <i class='bi bi-key-fill me-2'></i>
                                        <strong>Данные для входа в админ-панель:</strong><br>
                                        <strong>Логин:</strong> <?= htmlspecialchars($_SESSION['admin_created']['login']) ?><br>
                                        <strong>Email:</strong> <?= htmlspecialchars($_SESSION['admin_created']['email']) ?><br>
                                        <small class='text-muted'>Пароль тот, который вы указали на предыдущем шаге</small>
                                    </div>
                                    <?php endif; ?>

                                    <!-- Предупреждения безопасности -->
                                    <div class='alert alert-warning mt-4 animate-slide-in-up' style='animation-delay: 1.6s;'>
                                        <i class='bi bi-shield-exclamation me-2'></i>
                                        <strong>Важные меры безопасности:</strong>
                                        <ol class='mb-0 mt-2 text-start'>
                                            <li><strong>Обязательно удалите файл install.php</strong> — это критически важно для безопасности!</li>
                                            <li>Измените пароль администратора на более сложный в админ-панели</li>
                                            <li>Регулярно создавайте резервные копии базы данных</li>
                                            <li>Следите за обновлениями системы</li>
                                        </ol>
                                    </div>

                                    <!-- Следующие шаги -->
                                    <div class='alert alert-success mt-4 animate-slide-in-up' style='animation-delay: 1.8s;'>
                                        <i class='bi bi-list-check me-2'></i>
                                        <strong>Рекомендуемые следующие шаги:</strong>
                                        <div class='row mt-3 text-start'>
                                            <div class='col-md-6'>
                                                <ol>
                                                    <li>Настройте основные параметры сайта</li>
                                                    <li>Добавьте категории товаров</li>
                                                    <li>Загрузите логотип и настройте дизайн</li>
                                                    <li>Создайте первые товары</li>
                                                </ol>
                                            </div>
                                            <div class='col-md-6'>
                                                <ol start='5'>
                                                    <li>Настройте способы доставки и оплаты</li>
                                                    <li>Настройте SEO и аналитику</li>
                                                    <li>Протестируйте процесс заказа</li>
                                                    <li>Запустите рекламную кампанию</li>
                                                </ol>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Информация о системе -->
                                    <div class='row g-3 mt-4'>
                                        <div class='col-md-3 col-6'>
                                            <div class='text-center p-3 bg-light rounded'>
                                                <i class='bi bi-code-slash text-primary fs-4'></i>
                                                <div class='small fw-bold mt-1'>PHP <?= PHP_VERSION ?></div>
                                            </div>
                                        </div>
                                        <div class='col-md-3 col-6'>
                                            <div class='text-center p-3 bg-light rounded'>
                                                <i class='bi bi-database text-success fs-4'></i>
                                                <div class='small fw-bold mt-1'>MySQL Ready</div>
                                            </div>
                                        </div>
                                        <div class='col-md-3 col-6'>
                                            <div class='text-center p-3 bg-light rounded'>
                                                <i class='bi bi-bootstrap text-purple fs-4'></i>
                                                <div class='small fw-bold mt-1'>Bootstrap 5.3</div>
                                            </div>
                                        </div>
                                        <div class='col-md-3 col-6'>
                                            <div class='text-center p-3 bg-light rounded'>
                                                <i class='bi bi-shield-check text-warning fs-4'></i>
                                                <div class='small fw-bold mt-1'>Secure</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Контакты поддержки -->
                                    <div class='mt-5 p-4 bg-light rounded'>
                                        <h6 class='fw-bold mb-3'><i class='bi bi-headset me-2'></i>Нужна помощь?</h6>
                                        <div class='row text-center'>
                                            <div class='col-md-4'>
                                                <i class='bi bi-envelope text-primary me-1'></i>
                                                <small>support@akvasbor.ru</small>
                                            </div>
                                            <div class='col-md-4'>
                                                <i class='bi bi-telegram text-info me-1'></i>
                                                <small>@akvasbor_support</small>
                                            </div>
                                            <div class='col-md-4'>
                                                <i class='bi bi-book text-success me-1'></i>
                                                <small>Документация в админке</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Кнопка удаления install.php -->
                                    <div class='mt-4'>
                                        <button class='btn btn-danger btn-sm' onclick='deleteInstaller()'>
                                            <i class='bi bi-trash3 me-2'></i>Удалить install.php (рекомендуется)
                                        </button>
                                    </div>
                                </div>

                                <!-- Добавляем конфетти эффект -->
                                <script>
                                    // Создаем конфетти эффект
                                    function createConfetti() {
                                        for (let i = 0; i < 100; i++) {
                                            const confetti = document.createElement('div');
                                            confetti.className = 'confetti';
                                            confetti.style.left = Math.random() * 100 + 'vw';
                                            confetti.style.backgroundColor = ['#28a745', '#007bff', '#ffc107', '#dc3545', '#6f42c1'][Math.floor(Math.random() * 5)];
                                            confetti.style.animationDelay = Math.random() * 2 + 's';
                                            confetti.style.animationDuration = (Math.random() * 2 + 3) + 's';
                                            document.body.appendChild(confetti);

                                            setTimeout(() => confetti.remove(), 5000);
                                        }
                                    }

                                    // Запускаем конфетти через секунду после загрузки
                                    setTimeout(createConfetti, 1000);
                                </script>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js'></script>
    <script>
        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            // Валидация форм в реальном времени
            const forms = document.querySelectorAll('.needs-validation');
            forms.forEach(form => {
                const inputs = form.querySelectorAll('input[required]');
                inputs.forEach(input => {
                    input.addEventListener('input', function() {
                        validateInput(this);
                    });

                    input.addEventListener('blur', function() {
                        validateInput(this);
                    });
                });

                // Обработка отправки формы
                form.addEventListener('submit', function(e) {
                    if (!form.checkValidity()) {
                        e.preventDefault();
                        e.stopPropagation();
                    } else {
                        // Показываем спиннер
                        const submitBtn = form.querySelector('button[type="submit"]');
                        const spinner = submitBtn.querySelector('.loading-spinner');
                        const icon = submitBtn.querySelector('.submit-icon');
                        const text = submitBtn.querySelector('.submit-text');

                        if (spinner && icon && text) {
                            spinner.classList.remove('d-none');
                            icon.classList.add('d-none');
                            text.textContent = 'Обработка...';
                            submitBtn.disabled = true;
                        }
                    }
                    form.classList.add('was-validated');
                });
            });

            // Проверка совпадения паролей
            const password = document.getElementById('password');
            const password2 = document.getElementById('password2');

            if (password && password2) {
                function checkPasswordMatch() {
                    if (password.value !== password2.value) {
                        password2.setCustomValidity('Пароли не совпадают');
                        password2.classList.add('is-invalid');
                        password2.classList.remove('is-valid');
                    } else {
                        password2.setCustomValidity('');
                        if (password2.value.length >= 8) {
                            password2.classList.add('is-valid');
                            password2.classList.remove('is-invalid');
                        }
                    }
                }

                password.addEventListener('input', checkPasswordMatch);
                password2.addEventListener('input', checkPasswordMatch);
            }

            // Анимация появления карточек
            const cards = document.querySelectorAll('.feature-card:not(.animate-slide-in-left):not(.animate-slide-in-right):not(.animate-slide-in-up)');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(30px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 150);
            });

            // Анимация элементов требований
            const requirements = document.querySelectorAll('.requirement-item:not(.animate-slide-in-left)');
            requirements.forEach((req, index) => {
                req.style.opacity = '0';
                req.style.transform = 'translateX(-30px)';
                setTimeout(() => {
                    req.style.transition = 'all 0.5s ease';
                    req.style.opacity = '1';
                    req.style.transform = 'translateX(0)';
                }, index * 100);
            });
        });

        // Валидация отдельного поля
        function validateInput(input) {
            if (input.checkValidity()) {
                input.classList.add('is-valid');
                input.classList.remove('is-invalid');
            } else {
                input.classList.add('is-invalid');
                input.classList.remove('is-valid');
            }
        }

        // Функция удаления установщика
        function deleteInstaller() {
            if (confirm('Вы уверены, что хотите удалить файл install.php? Это действие нельзя отменить.')) {
                fetch('install.php?action=delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({action: 'delete_installer'})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Файл install.php успешно удален!');
                        window.location.href = 'index.php';
                    } else {
                        alert('Ошибка при удалении файла. Удалите install.php вручную через FTP.');
                    }
                })
                .catch(error => {
                    alert('Ошибка при удалении файла. Удалите install.php вручную через FTP.');
                });
            }
        }

        // Добавляем обработку удаления установщика
        <?php
        if (isset($_GET['action']) && $_GET['action'] === 'delete' && $_SERVER['REQUEST_METHOD'] === 'POST') {
            $response = ['success' => false];
            if (@unlink(__FILE__)) {
                $response['success'] = true;
            }
            header('Content-Type: application/json');
            echo json_encode($response);
            exit;
        }
        ?>

        // Улучшенные визуальные эффекты
        let ticking = false;

        function updateParallax() {
            const scrolled = window.pageYOffset;
            const parallax = document.querySelector('.floating-elements');

            if (parallax) {
                parallax.style.transform = 'translateY(' + (scrolled * 0.1) + 'px)';
            }

            ticking = false;
        }

        function requestTick() {
            if (!ticking) {
                requestAnimationFrame(updateParallax);
                ticking = true;
            }
        }

        window.addEventListener('scroll', requestTick);

        // Эффекты при наведении на кнопки
        document.querySelectorAll('.btn').forEach(btn => {
            btn.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-2px) scale(1.02)';
            });

            btn.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0) scale(1)';
            });
        });

        // Улучшенная обработка кликов
        document.querySelectorAll('.btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                // Эффект волны при клике
                const rect = this.getBoundingClientRect();
                const ripple = document.createElement('span');
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;

                ripple.style.cssText = `
                    position: absolute;
                    width: ${size}px;
                    height: ${size}px;
                    left: ${x}px;
                    top: ${y}px;
                    background: rgba(255,255,255,0.4);
                    border-radius: 50%;
                    transform: scale(0);
                    animation: ripple 0.6s linear;
                    pointer-events: none;
                `;

                this.appendChild(ripple);

                setTimeout(() => ripple.remove(), 600);
            });
        });

        // CSS для анимации волны
        const style = document.createElement('style');
        style.textContent = `
            @keyframes ripple {
                to {
                    transform: scale(4);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // Прогрессивное улучшение производительности
        if ('IntersectionObserver' in window) {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('animate-fade-in');
                    }
                });
            }, {
                threshold: 0.1
            });

            document.querySelectorAll('.feature-card, .requirement-item, .alert').forEach(el => {
                observer.observe(el);
            });
        }

        // Автоматическое скрытие алертов через некоторое время
        document.querySelectorAll('.alert-success').forEach(alert => {
            setTimeout(() => {
                alert.style.transition = 'all 0.5s ease';
                alert.style.opacity = '0.7';
            }, 5000);
        });

        console.log('🎉 АкваСбор CMS 2.0 MEGA Installer загружен успешно!');
        console.log('🚀 Версия PHP: <?= PHP_VERSION ?>');
        console.log('📦 Bootstrap: 5.3.2');
        console.log('🎨 Дизайн: MEGA Edition с анимациями');
    </script>
</body>
</html>
